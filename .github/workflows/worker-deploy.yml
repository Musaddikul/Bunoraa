name: Publish Cloudflare Worker (production)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  publish-worker:
    runs-on: ubuntu-latest
    concurrency:
      group: "worker-publish-${{ github.ref }}"
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Wrangler
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json — using npm ci"
            npm ci --silent
          else
            echo "No package-lock.json found — falling back to npm install"
            npm install --silent
          fi
          npm i --no-save wrangler@4

      - name: Configure Cloudflare API token
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          echo "Configured CLOUDFLARE_API_TOKEN"

      - name: Put Worker secrets (DATABASE_URL)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -n "$DATABASE_URL" ]; then
            printf '%s' "$DATABASE_URL" | npx wrangler secret put DATABASE_URL --env production --config ./wrangler.worker.toml
          else
            echo "DATABASE_URL secret not provided; skipping"
          fi

      - name: Put Worker secrets (SECRET_KEY)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          if [ -n "$SECRET_KEY" ]; then
            printf '%s' "$SECRET_KEY" | npx wrangler secret put SECRET_KEY --env production --config ./wrangler.worker.toml
          else
            echo "SECRET_KEY secret not provided; skipping"
          fi

      - name: Put Worker secrets (SENTRY_DSN)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          if [ -n "$SENTRY_DSN" ]; then
            printf '%s' "$SENTRY_DSN" | npx wrangler secret put SENTRY_DSN --env production --config ./wrangler.worker.toml
          else
            echo "SENTRY_DSN secret not provided; skipping"
          fi

      - name: Publish Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # Verify config exists
          echo "Using config: ./wrangler.worker.toml"
          npx wrangler publish --config ./wrangler.worker.toml --env production

      - name: Smoke tests — verify static assets & API
        env:
          URL: https://bunoraa.com
        run: |
          set -e
          echo "Checking static components index.js..."
          for i in 1 2 3; do
            curl -sSf -I "$URL/static/js/components/index.js" && break || (echo "attempt $i failed" && sleep 2)
          done

          echo "Checking Tabs.js (direct)..."
          curl -sSf -I "$URL/static/js/components/Tabs.js"

          echo "Checking currency API..."
          for i in 1 3; do
            curl -sSf -I "$URL/api/v1/currencies/" && break || (echo "attempt $i failed" && sleep 2)
          done
