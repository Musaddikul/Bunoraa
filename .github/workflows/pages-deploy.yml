name: Build and Deploy to Cloudflare Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: "pages-deploy-${{ github.ref }}"
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install JS deps & build CSS
        run: |
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json — using npm ci"
            npm ci
          else
            echo "No package-lock.json found — falling back to npm install"
            npm install
          fi
          npm run build

      - name: Install Python deps (minimal)
        run: |
          python -m pip install --upgrade pip
          # To speed up build, install only what is needed for collectstatic
          pip install -r requirements.txt

      - name: Collect static files
        env:
          DJANGO_SETTINGS_MODULE: core.settings.production
        run: |
          python manage.py collectstatic --noinput

      - name: Prepare Pages output (add /static prefix)
        run: |
          mkdir -p staticfiles/static
          # Copy collected output into a /static subdirectory so URLs like /static/js/... resolve
          shopt -s dotglob || true
          for f in staticfiles/*; do
            if [ "$f" != "staticfiles/static" ]; then
              cp -r "$f" staticfiles/static/
            fi
          done

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_PAGES_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: bunoraa
          directory: ./staticfiles

      - name: Smoke tests — verify static assets & API
        env:
          URL: https://bunoraa.com
        run: |
          set -e
          echo "Checking static components index.js..."
          for i in 1 2 3; do
            curl -sSf -I "$URL/static/js/components/index.js" && break || (echo "attempt $i failed" && sleep 2)
          done

          echo "Checking Tabs.js (direct)..."
          curl -sSf -I "$URL/static/js/components/Tabs.js"

          echo "Checking currency API..."
          for i in 1 3; do
            curl -sSf -I "$URL/api/v1/currencies/" && break || (echo "attempt $i failed" && sleep 2)
          done

      - name: Notify (optional)
        if: failure()
        run: echo "Pages deployment failed or smoke tests failed" && exit 1
