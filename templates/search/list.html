{% extends 'base.html' %}
{% load static %}

{% block page_id %}category{% endblock %}
{% load seo_tags %}
{% block title %}{% if category %}{{ category.name|seo_title }}{% else %}All Products{% endif %} - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}{% if category %}{{ category.meta_description|default:category.description|seo_desc }}{% else %}{{ "Browse our premium collection of products. Find the best deals on fashion, electronics, home & living and more."|seo_desc }}{% endif %}{% endblock %}

{% block extra_head %}
{% if products and products.has_other_pages %}
    {% if products.has_previous %}
    <link rel="prev" href="{{ canonical_url }}?page={{ products.previous_page_number }}">
    {% endif %}
    {% if products.has_next %}
    <link rel="next" href="{{ canonical_url }}?page={{ products.next_page_number }}">
    {% endif %}
{% endif %}
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="bg-white dark:bg-stone-900 border-b border-gray-100 dark:border-stone-800">
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <h1 id="page-title" class="text-3xl lg:text-4xl font-display font-bold text-gray-900 dark:text-white mb-2">All Products</h1>
                <p id="product-count" class="text-gray-600 dark:text-stone-400">Loading products...</p>
            </div>
            
            <!-- View Toggle & Sort (Desktop) -->
            <div class="hidden lg:flex items-center gap-4">
                <div class="flex items-center gap-2 border border-gray-200 dark:border-stone-700 rounded-lg p-1 dark:bg-stone-900">
                    <button id="view-grid" class="p-2 bg-primary-100 dark:bg-stone-800 text-primary-700 dark:text-stone-200 rounded-md" title="Grid View">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    </button>
                    <button id="view-list" class="p-2 text-gray-400 dark:text-stone-400 dark:hover:text-stone-300 rounded-md" title="List View">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    </button>
                </div>
                
                <select id="sort-select" class="border border-gray-200 dark:border-stone-700 rounded-lg px-4 py-2 text-gray-700 dark:text-stone-200 bg-white dark:bg-stone-800 focus:ring-2 focus:ring-primary-500 dark:focus:ring-amber-900 focus:border-primary-500 dark:focus:border-amber-700">
                    <option value="popular">Most Popular</option>
                    <option value="newest">Newest First</option>
                    <option value="price_low">Price: Low to High</option>
                    <option value="price_high">Price: High to Low</option>
                    <option value="rating">Highest Rated</option>
                    <option value="bestselling">Best Selling</option>
                </select>
            </div>
        </div>
    </div>
</section>

<section class="bg-gray-50 dark:bg-stone-900 py-8">
    <div class="container mx-auto px-4">
        <div class="flex gap-8">
            <!-- Sidebar Filters (Desktop) -->
            <aside id="filters-sidebar" class="hidden lg:block w-72 flex-shrink-0">
                <div class="sticky top-24 space-y-6">
                    <!-- Active Filters -->
                    <div id="active-filters" class="hidden bg-white dark:bg-stone-900 rounded-xl p-4 shadow-soft border border-stone-100 dark:border-stone-800">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-900 dark:text-white">Active Filters</h3>
                            <button id="clear-all-filters" class="text-sm text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300">Clear All</button>
                        </div>
                        <div id="active-filters-list" class="flex flex-wrap gap-2">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                    
                    <!-- Product Search -->
                    <div class="bg-white dark:bg-stone-900 rounded-xl p-4 shadow-soft border border-stone-100 dark:border-stone-800">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Product Search</h3>
                            </div>
                            <button id="sidebar-reset-filters" type="button" class="text-sm font-medium text-primary-700 dark:text-amber-400 hover:text-primary-900 dark:hover:text-amber-300">Reset All</button>
                        </div>
                        <div class="mt-4">
                            <div class="relative">
                                <svg class="w-4 h-4 text-gray-400 dark:text-stone-500 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z"></path></svg>
                                <input type="search" id="product-search-input" class="w-full pr-10 pl-3 py-2.5 border border-gray-200 dark:border-stone-700 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 dark:focus:ring-amber-900 focus:border-primary-500 dark:focus:border-amber-700 bg-white dark:bg-stone-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-stone-500" placeholder="Search products...">
                            </div>
                        </div>
                    </div>

                    <!-- Categories -->
                    <div class="bg-white dark:bg-stone-900 rounded-xl p-4 shadow-soft border border-stone-100 dark:border-stone-800" data-filter-card>
                        <div class="flex items-start justify-between gap-3 mb-4">
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Category</h3>
                            </div>
                            <button type="button" class="filter-collapse text-gray-400 dark:text-stone-500 hover:text-gray-600 dark:hover:text-stone-300" data-collapse-target="#category-filter-body">
                                <svg class="w-5 h-5 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                        <div id="category-filter-body" data-filter-content>
                            <div id="categories-filter" class="space-y-1 max-h-72 overflow-y-auto">
                                <div class="skeleton h-8 rounded"></div>
                                <div class="skeleton h-8 rounded"></div>
                                <div class="skeleton h-8 rounded"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Range -->
                    <div class="bg-white dark:bg-stone-900 rounded-xl p-4 shadow-soft border border-stone-100 dark:border-stone-800" data-filter-card>
                        <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center justify-between">
                            <span>Price Range</span>
                            <button type="button" class="filter-collapse text-gray-400 dark:text-stone-500 hover:text-gray-600 dark:hover:text-stone-300" data-collapse-target="#price-filter">
                                <svg class="w-5 h-5 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </h3>
                        <div id="price-filter" data-filter-content>
                            <div class="flex items-center gap-3 mb-4">
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-stone-500">{{ currency_symbol }}</span>
                                    <input type="number" id="price-min" class="w-full pl-7 pr-3 py-2 border border-gray-200 dark:border-stone-700 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 dark:focus:ring-amber-900 focus:border-primary-500 dark:focus:border-amber-700 bg-white dark:bg-stone-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-stone-500" placeholder="Min">
                                </div>
                                <span class="text-gray-400 dark:text-stone-500">–</span>
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-stone-500">{{ currency_symbol }}</span>
                                    <input type="number" id="price-max" class="w-full pl-7 pr-3 py-2 border border-gray-200 dark:border-stone-700 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 dark:focus:ring-amber-900 focus:border-primary-500 dark:focus:border-amber-700 bg-white dark:bg-stone-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-stone-500" placeholder="Max">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Availability -->
                    <div class="bg-white dark:bg-stone-900 rounded-xl p-4 shadow-soft border border-stone-100 dark:border-stone-800" data-filter-card>
                        <div class="flex items-center justify-between gap-3 mb-4">
                            <span class="font-semibold text-gray-900 dark:text-white">Availability</span>
                            <button type="button" class="filter-collapse text-gray-400 dark:text-stone-500 hover:text-gray-600 dark:hover:text-stone-300" data-collapse-target="#availability-filter">
                                <svg class="w-5 h-5 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                        <div class="space-y-2" id="availability-filter" data-filter-content>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-stone-800 p-1.5 rounded-lg transition-colors">
                                <input type="checkbox" id="in-stock" class="w-4 h-4 text-primary-600 dark:text-amber-400 border-gray-300 dark:border-stone-700 rounded focus:ring-primary-500 dark:focus:ring-amber-900">
                                <span class="text-sm text-gray-700 dark:text-stone-200">In Stock Only</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-stone-800 p-1.5 rounded-lg transition-colors">
                                <input type="checkbox" id="on-sale" class="w-4 h-4 text-primary-600 dark:text-amber-400 border-gray-300 dark:border-stone-700 rounded focus:ring-primary-500 dark:focus:ring-amber-900">
                                <span class="text-sm text-gray-700 dark:text-stone-200">On Sale</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-stone-800 p-1.5 rounded-lg transition-colors">
                                <input type="checkbox" id="new-arrivals" class="w-4 h-4 text-primary-600 dark:text-amber-400 border-gray-300 dark:border-stone-700 rounded focus:ring-primary-500 dark:focus:ring-amber-900">
                                <span class="text-sm text-gray-700 dark:text-stone-200">New Arrivals</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1 min-w-0">
                <!-- Mobile Filter Bar -->
                <div class="lg:hidden flex items-center gap-3 mb-6">
                    <button id="open-filters" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-xl text-gray-700 dark:text-stone-200 font-medium hover:bg-gray-50 dark:hover:bg-stone-800 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                        Filters
                        <span id="filter-count-badge" class="hidden px-2 py-0.5 bg-primary-600 text-white text-xs rounded-full">0</span>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="flex bg-white dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-xl p-1">
                            <button id="mobile-view-grid" class="p-2 bg-transparent text-gray-600 dark:text-stone-300 rounded-md" title="Grid View (mobile)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                            </button>
                            <button id="mobile-view-list" class="p-2 text-gray-400 hover:text-gray-600 rounded-md" title="List View (mobile)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                            </button>
                        </div>
                        <select id="mobile-sort-select" class="px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="popular">Popular</option>
                            <option value="newest">Newest</option>
                            <option value="price_low">Price ↑</option>
                            <option value="price_high">Price ↓</option>
                            <option value="rating">Top Rated</option>
                        </select>
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="products-container">
                    <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 lg:gap-6">
                        <!-- Loading skeletons -->
                        {% for i in "12345678" %}
                        <div class="skeleton h-64 sm:h-72 md:h-80 rounded-2xl"></div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-16">
                    <div class="w-20 h-20 bg-gray-100 dark:bg-stone-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-gray-400 dark:text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No products found</h3>
                    <p class="text-gray-600 dark:text-stone-400 mb-6">Try adjusting your filters or search terms</p>
                    <button id="reset-filters" class="btn-primary">Reset Filters</button>
                </div>
                
                <!-- Load More / Pagination -->
                <div id="pagination-container" class="mt-8 flex flex-col items-center gap-4">
                    <div id="pagination-component" class="flex justify-center"></div>
                    <button id="load-more" class="hidden px-8 py-3 bg-white dark:bg-stone-900 dark:border-stone-700 border border-gray-200 rounded-xl text-gray-700 dark:text-stone-200 font-medium hover:bg-gray-50 dark:hover:bg-stone-800 transition-colors">
                        <span class="load-more-text">Load More Products</span>
                        <svg class="load-more-spinner hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <!-- Sentinel element observed by IntersectionObserver to auto-load next pages -->
                    <div id="scroll-sentinel" class="w-full h-1"></div>
                </div>
            </main>
        </div>
    </div>
</section>

<!-- Mobile Filters Modal -->
<div id="filters-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" data-close-modal></div>
    <div class="absolute inset-y-0 left-0 w-full max-w-sm bg-white dark:bg-stone-900 transform -translate-x-full transition-transform duration-300" id="filters-modal-content">
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Filters</h2>
            <button data-close-modal class="p-2 text-gray-400 hover:text-gray-600 dark:text-stone-400 dark:hover:text-stone-200 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="p-4 overflow-y-auto h-[calc(100vh-140px)]">
            <!-- Mobile filters will be cloned from sidebar -->
            <div id="mobile-filters-content"></div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100 dark:border-stone-700 bg-white dark:bg-stone-900">
            <div class="flex gap-3">
                <button id="mobile-clear-filters" class="flex-1 py-3 border border-gray-200 dark:border-stone-700 text-gray-700 dark:text-stone-200 font-medium rounded-xl hover:bg-gray-50 dark:hover:bg-stone-800 transition-colors">Clear</button>
                <button id="mobile-apply-filters" class="flex-1 py-3 bg-primary-700 dark:bg-amber-600 text-white font-medium rounded-xl hover:bg-primary-800 transition-colors">Apply</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
import { Pagination, Toast } from "{% static 'js/components/index.js' %}";

document.addEventListener('DOMContentLoaded', async function() {
    // Single-currency mode: frontend uses server-configured currency (no client-side switching).
    
    // Client-side currency selection disabled (single-currency mode).
    
    const locale = document.documentElement.lang || navigator.language || 'en-US';
    const categoryNameMap = {};
    const routePlaceholder = window.BUNORAA_ROUTE_PLACEHOLDER || '__slug__';
    const routeMap = window.BUNORAA_ROUTES || {};
    const buildRoute = (name, value) => {
        const template = routeMap[name];
        if (!template) {
            return '#';
        }
        if (value === undefined || value === null) {
            return template;
        }
        return template.replace(routePlaceholder, encodeURIComponent(value));
    };
    
    // State
    let currentPage = 1;
    let totalPages = 1;
    let totalProducts = 0;
    let paginationInstance = null;
    let isLoading = false;
    let viewMode = 'grid';
    let filters = {
        categories: [],
        price_min: null,
        price_max: null,
        in_stock: false,
        on_sale: false,
        new_arrivals: false,
        sort: 'popular',
        search: null
    };
    
    // Parse URL params
    const urlParams = new URLSearchParams(window.location.search);
    const initialCategoryParam = urlParams.get('category') || urlParams.get('categories') || '{{ category.slug|default:"" }}';
    filters.categories = initialCategoryParam ? initialCategoryParam.split(',').map(slug => slug.trim()).filter(Boolean) : [];
    filters.search = urlParams.get('q') || urlParams.get('search') || null;
    filters.sort = urlParams.get('sort') || 'popular';
    filters.on_sale = urlParams.get('sale') === 'true' || urlParams.get('on_sale') === 'true';
    filters.in_stock = urlParams.get('in_stock') === 'true';
    filters.new_arrivals = urlParams.get('new') === 'true' || urlParams.get('new_arrivals') === 'true';
    filters.price_min = urlParams.get('min_price') || urlParams.get('price_min') || null;
    filters.price_max = urlParams.get('max_price') || urlParams.get('price_max') || null;
    
    // Elements
    const productsGrid = document.getElementById('products-grid');
    const emptyState = document.getElementById('empty-state');
    const loadMoreBtn = document.getElementById('load-more');
    const paginationMount = document.getElementById('pagination-component');
    const productCount = document.getElementById('product-count');
    const pageTitle = document.getElementById('page-title');
    const sortSelect = document.getElementById('sort-select');
    const mobileSortSelect = document.getElementById('mobile-sort-select');
    const productSearchInput = document.getElementById('product-search-input');
    const sidebarResetButton = document.getElementById('sidebar-reset-filters');
    const categoriesFilterElement = document.getElementById('categories-filter');
    const priceMinInput = document.getElementById('price-min');
    const priceMaxInput = document.getElementById('price-max');
    if (productSearchInput) {
        productSearchInput.value = filters.search || '';
    }
    if (priceMinInput) {
        priceMinInput.value = filters.price_min || '';
    }
    if (priceMaxInput) {
        priceMaxInput.value = filters.price_max || '';
    }
    const quickFilterButtons = document.querySelectorAll('[data-quick-filter]');
    
    // Escape HTML helper
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]);
    }

    function escapeSelector(value) {
        if (typeof value !== 'string') return '';
        if (window.CSS && typeof window.CSS.escape === 'function') {
            return window.CSS.escape(value);
        }
        return value.replace(/[^a-zA-Z0-9_-]/g, '\\$&');
    }

    function buildCategoryTree(categories) {
        const lookup = {};
        const roots = [];

        categories.forEach(cat => {
            if (!cat?.slug) return;
            lookup[cat.slug] = { ...cat, children: [] };
            categoryNameMap[cat.slug] = cat.name || cat.title || cat.slug;
        });

        categories.forEach(cat => {
            if (!cat?.slug) return;
            const node = lookup[cat.slug];
            const parentSlug = cat.parent?.slug || cat.parent_slug || cat.parent || cat.parent_id || null;
            if (parentSlug && lookup[parentSlug]) {
                lookup[parentSlug].children.push(node);
            } else {
                roots.push(node);
            }
        });

        return roots;
    }

    function indexCategoryNames(nodes) {
        if (!Array.isArray(nodes)) return;
        nodes.forEach(node => {
            if (!node?.slug) return;
            categoryNameMap[node.slug] = node.name || node.title || node.slug;
            if (Array.isArray(node.children) && node.children.length) {
                indexCategoryNames(node.children);
            }
        });
    }

    function isNodeExpanded(node, depth = 0) {
        if (!node) return false;
        if (depth === 0) return true;
        const slug = String(node.slug || '');
        if (filters.categories.includes(slug)) return true;
        if (!Array.isArray(node.children) || !node.children.length) return false;
        return node.children.some(child => isNodeExpanded(child, depth + 1));
    }

    function renderCategoryTree(items) {
        if (!Array.isArray(items) || !items.length) {
            return '<p class="text-sm text-gray-500 dark:text-stone-400">No categories available right now.</p>'; 
        }

        const buildNodes = (nodes, depth = 0) => {
            const sortedNodes = [...nodes].sort((a, b) => {
                const aOrder = a.order ?? a.position ?? a.priority ?? 0;
                const bOrder = b.order ?? b.position ?? b.priority ?? 0;
                if (aOrder !== bOrder) return aOrder - bOrder;
                const aName = (a.name || a.title || a.slug || '').toLowerCase();
                const bName = (b.name || b.title || b.slug || '').toLowerCase();
                return aName.localeCompare(bName);
            });

            return sortedNodes.map(item => {
                const label = item.name || item.title || item.slug;
                const slug = String(item.slug || '');
                const isChecked = filters.categories.includes(slug) ? 'checked' : '';
                const hasChildren = Array.isArray(item.children) && item.children.length > 0;
                const expanded = hasChildren ? isNodeExpanded(item, depth) : false;
                const toggleButton = hasChildren
                    ? `<button type="button" class="category-toggle w-6 h-6 flex items-center justify-center text-gray-400 hover:text-gray-600" data-category-toggle="${escapeHtml(slug)}" aria-label="Toggle ${escapeHtml(label)}" aria-expanded="${expanded ? 'true' : 'false'}">
                            <svg class="w-4 h-4 transition-transform duration-200 ${expanded ? 'rotate-90' : 'rotate-0'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>`
                    : '<span class="w-6 h-6 flex-shrink-0"></span>';

                const childrenMarkup = hasChildren
                    ? `<ul class="category-children border-l border-gray-100 ml-4 pl-3 mt-1 space-y-1 ${expanded ? '' : 'hidden'}" data-category-children="${escapeHtml(slug)}">
                            ${buildNodes(item.children, depth + 1)}
                       </ul>`
                    : '';

                return `
                    <li class="category-tree-item" data-slug="${escapeHtml(slug)}">
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-2 py-1 rounded-lg">
                            <input type="checkbox" class="category-checkbox w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500" value="${escapeHtml(slug)}" ${isChecked}>
                            <span class="flex items-center gap-2 flex-1">
                                <span class="text-sm text-gray-700">${escapeHtml(label)}</span>
                                ${toggleButton}
                            </span>
                            <span class="text-xs text-gray-400 flex-shrink-0">${item.product_count || 0}</span>
                        </label>
                        ${childrenMarkup}
                    </li>
                `;
            }).join('');
        };

        return `<ul class="category-tree space-y-2 list-none m-0 p-0">${buildNodes(items)}</ul>`;
    }

    function formatRangeValue(value) {
        if (value === null || value === undefined || value === '') return '';
        const numeric = Number(value);
        if (Number.isNaN(numeric)) return value;
        return numeric.toLocaleString(locale);
    }

    // Price decorators handled server-side; no client-side symbol injection required.

    function applyProductSearch() {
        if (!productSearchInput) return;
        const term = productSearchInput.value.trim();
        filters.search = term || null;
        updateActiveFilters();
        loadProducts();
    }

    let searchInputDebounce;
    const SEARCH_INPUT_DEBOUNCE = 350;

    function scheduleSearchUpdate(immediate = false) {
        if (!productSearchInput) return;
        if (immediate) {
            applyProductSearch();
            return;
        }
        clearTimeout(searchInputDebounce);
        searchInputDebounce = setTimeout(() => {
            applyProductSearch();
        }, SEARCH_INPUT_DEBOUNCE);
    }

    let priceInputDebounce;
    const PRICE_INPUT_DEBOUNCE = 400;

    function schedulePriceFilterUpdate(immediate = false) {
        if (immediate) {
            filters.price_min = priceMinInput?.value || null;
            filters.price_max = priceMaxInput?.value || null;
            updateActiveFilters();
            loadProducts();
            return;
        }

        clearTimeout(priceInputDebounce);
        priceInputDebounce = setTimeout(() => {
            filters.price_min = priceMinInput?.value || null;
            filters.price_max = priceMaxInput?.value || null;
            updateActiveFilters();
            loadProducts();
        }, PRICE_INPUT_DEBOUNCE);
    }

    // Client-side currency change handlers removed; prices use server formatting.
    
    // Helper to format price using global Templates.formatPrice with currency conversion
    function formatProductPrice(amount) {
        if (amount === null || amount === undefined) return '';
        try {
            if (window.Templates && window.Templates.formatPrice) {
                return window.Templates.formatPrice(amount);
            }
        } catch (e) {
            // ignore
        }
        // Fallback if Templates not available
        return `${(window.BUNORAA_CURRENCY && window.BUNORAA_CURRENCY.symbol) || '{{ currency_symbol }}'}${parseFloat(amount).toLocaleString(locale)}`;
    }

    // Helper to pick the appropriate display amount for a product (prefer per-request converted values)
    function getProductDisplayAmount(product) {
        // Preferred order: current_price (already effective price converted), sale_price_converted, price_converted, sale_price, price
        return product.current_price ?? product.sale_price_converted ?? product.price_converted ?? product.sale_price ?? product.price;
    }

    function getProductOriginalAmount(product) {
        // Original price (for line-through display when on sale), prefer converted version if available
        return product.price_converted ?? product.price;
    }
    
    // Number of products to load per page (reduced to speed initial load)
    const PRODUCTS_PER_PAGE = 8;

    // Store last loaded products for re-rendering on currency change
    let cachedProducts = [];

    // IntersectionObserver for deferring heavy product images
    let productImageObserver;
    function initProductImageObserver() {
        if (productImageObserver) return;
        productImageObserver = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) return;
                const img = entry.target;
                const src = img.dataset.src;
                if (src) {
                    img.src = src;
                    img.removeAttribute('data-src');
                }
                img.setAttribute('loading', 'lazy');
                img.setAttribute('decoding', 'async');
                obs.unobserve(img);
            });
        }, { rootMargin: '200px 0px' });
    }

    // If currency changes via selector, reload products (clear API cache first)
    document.addEventListener('currency:changed', async (e) => {
        try {
            if (window.ApiClient && typeof window.ApiClient.clearCache === 'function') {
                // Remove cached GETs that include products endpoint
                window.ApiClient.clearCache('/api/v1/products/');
            }
        } catch (err) {
        }

        // Re-load products to fetch converted prices
        await loadProducts(false);
        // If we have cached products, re-render to pick up converted fields
        renderProductsFromCache();
    });
    
    function renderProductsFromCache() {
        if (cachedProducts.length > 0 && productsGrid) {
            productsGrid.innerHTML = cachedProducts.map(p => createProductCard(p)).join('');
            // Re-init observer for cached content
            initProductImageObserver();
            document.querySelectorAll('#products-grid .product-image[data-src]').forEach(img => {
                try { productImageObserver.observe(img); } catch (e) { /* ignore */ }
            });
        }
    }
    
    // Create product card (use thumbnails and defer image loading via data-src)
    function createProductCard(product) {
        const saleAmount = product.sale_price_converted ?? product.sale_price ?? null;
        const origAmount = product.price_converted ?? product.price ?? null;
        const discount = (saleAmount && origAmount && origAmount > 0) ? Math.round((1 - (saleAmount / origAmount)) * 100) : 0;

        // Prefer thumbnail if available to reduce payload on list pages
        const rawPrimary = product.thumbnail || product.primary_image || '/static/images/placeholder.svg';
        // Normalise possible object shapes
        const imgUrl = (typeof rawPrimary === 'object') ? (rawPrimary?.image?.url || rawPrimary?.url || '/static/images/placeholder.svg') : rawPrimary;

        if (viewMode === 'list') {
            return `
                <div class="product-card bg-white dark:bg-stone-900 rounded-none shadow-sm overflow-hidden flex group col-span-full border border-stone-200 dark:border-stone-800">
                    <div class="relative w-48 flex-shrink-0 overflow-hidden">
                        <img data-src="${imgUrl}" src="/static/images/placeholder.svg" alt="${escapeHtml(product.name)}" loading="lazy" decoding="async" width="320" height="320"
                             class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 product-image">
                        ${discount > 0 ? `<span class="absolute top-3 left-3 px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-lg">-${discount}%</span>` : ''}
                    </div>
                    <div class="flex-1 py-3 md:py-4 px-1 md:px-4 flex flex-col">
                        <div class="flex-1">
                            <a href="${buildRoute('productDetail', product.slug)}">
                                <h3 class="font-bold text-gray-900 mb-2 hover:text-primary-600 transition-colors text-sm md:text-base">${escapeHtml(product.name)}</h3>
                            </a>
                            ${product.short_description ? `<p class="text-gray-600 text-sm mb-3 line-clamp-2">${escapeHtml(product.short_description)}</p>` : ''}
                            ${product.average_rating ? `
                            <div class="flex items-center gap-1 mb-3">
                                <div class="flex text-yellow-400">
                                    ${[1,2,3,4,5].map(i => `<svg class="w-4 h-4 ${i <= Math.round(product.average_rating) ? 'fill-current text-yellow-400' : 'fill-gray-300'}" viewBox="0 0 20 20" aria-hidden="true"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`).join('')}
                                </div>
                                <span class="text-sm text-gray-500">(${product.review_count || 0} reviews)</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                            <div class="flex items-center gap-2">
                                ${product.sale_price ? `
                                    <span class="text-sm md:text-base font-normal text-gray-900">${formatProductPrice(getProductDisplayAmount(product))}</span>
                                    <span class="text-xs md:text-sm text-gray-400 line-through">${formatProductPrice(getProductOriginalAmount(product))}</span>
                                ` : `
                                    <span class="text-sm md:text-base font-normal text-gray-900">${formatProductPrice(getProductDisplayAmount(product))}</span>
                                `}
                            </div>
                            <div class="flex gap-2">
                                <button data-add-to-wishlist="${product.id}" title="Add to wishlist" aria-label="Add to wishlist" class="p-2 rounded-md !text-black transition-colors">
                                    <svg class="w-7 h-7" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                </button>
                                <button data-add-to-cart="${product.id}" class="px-3 py-2 text-sm bg-primary-700 text-white font-medium rounded-lg hover:bg-primary-800 transition-colors">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="product-card group bg-white dark:bg-stone-900 rounded-none shadow-sm overflow-hidden border border-stone-200 dark:border-stone-800">
                <div class="relative overflow-hidden" style="aspect-ratio: ${product?.aspect?.css || '1/1'};">
                    <img data-src="${imgUrl}" src="/static/images/placeholder.svg" alt="${escapeHtml(product.name)}" loading="lazy" decoding="async" width="600" height="600"
                         class="product-image w-full h-full object-cover transition-transform duration-500">
                    ${discount > 0 ? `<span class="absolute top-3 left-3 px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-lg">-${discount}%</span>` : ''}
                    ${product.is_new ? `<span class="absolute top-3 ${discount > 0 ? 'left-16' : 'left-3'} px-2 py-1 bg-green-500 text-white text-xs font-bold rounded-lg">NEW</span>` : ''}
                    <div class="product-actions absolute bottom-3 left-3 flex gap-2">
                        <button data-quick-view="${product.id}" title="Quick view" aria-label="Quick view" class="product-action-btn">
                            <svg class="w-5 h-5 text-gray-700 dark:text-stone-300" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                    </div>
                    <button data-add-to-wishlist="${product.id}" class="absolute top-3 right-3 p-2 bg-white/80 backdrop-blur rounded-full text-gray-600 hover:scale-110 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                    </button>
                </div>
                <div class="py-3 md:py-4 px-1 md:px-4">
                    <a href="${buildRoute('productDetail', product.slug)}" class="block">
                        <h3 class="font-bold text-gray-900 line-clamp-2 mb-2 hover:text-primary-600 transition-colors text-sm md:text-base">${escapeHtml(product.name)}</h3>
                    </a>
                    ${product.average_rating ? `
                    <div class="flex items-center gap-1 mb-2">
                        <div class="flex text-yellow-400">
                            ${[1,2,3,4,5].map(i => `<svg class="w-4 h-4 ${i <= Math.round(product.average_rating) ? 'fill-current text-yellow-400' : 'fill-gray-300'}" viewBox="0 0 20 20" aria-hidden="true"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`).join('')}
                        </div>
                        <span class="text-xs text-gray-500">(${product.review_count || 0})</span>
                    </div>
                    ` : ''}
                    <div class="flex items-center gap-2">
                        ${product.sale_price ? `
                            <span class="text-sm md:text-base font-normal text-gray-900" data-price-id="product-price-${product.id}">${formatProductPrice(product.sale_price_converted ?? product.sale_price)}</span>
                            <span class="text-sm text-gray-400 line-through" data-price-id="product-price-${product.id}-orig">${formatProductPrice(product.price_converted ?? product.price)}</span>
                        ` : `
                            <span class="text-sm md:text-base font-normal text-gray-900" data-price-id="product-price-${product.id}">${formatProductPrice(product.price_converted ?? product.price)}</span>
                        `}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Load products
    async function loadProducts(append = false) {
        if (isLoading) return;
        isLoading = true;
        
        if (!append) {
            productsGrid.innerHTML = Array(8).fill('<div class="skeleton h-80 rounded-none"></div>').join('');
            currentPage = 1;
        } else {
            loadMoreBtn.querySelector('.load-more-text').classList.add('hidden');
            loadMoreBtn.querySelector('.load-more-spinner').classList.remove('hidden');
        }
        
        try {
            const params = {
                page: currentPage,
                pageSize: PRODUCTS_PER_PAGE
            };
            
            if (filters.categories.length) params.category = filters.categories.join(',');
            if (filters.search) params.search = filters.search;
            if (filters.price_min) params.minPrice = filters.price_min;
            if (filters.price_max) params.maxPrice = filters.price_max;
            if (filters.in_stock) params.inStock = true;
            if (filters.on_sale) params.onSale = true;
            if (filters.new_arrivals) params.isNew = true;
            
            const response = await ProductsApi.getProducts(params);
            const products = response.data || response.results || [];
            
            // Cache products for currency re-rendering
            if (append) {
                cachedProducts = [...cachedProducts, ...products];
            } else {
                cachedProducts = products;
            }
            
            totalProducts = response.meta?.pagination?.count || response.count || products.length;
            totalPages = response.meta?.pagination?.total_pages || Math.ceil(totalProducts / PRODUCTS_PER_PAGE);
            
            productCount.textContent = `Showing ${products.length} of ${totalProducts} products`;
            
            if (!products.length) {
                productsGrid.innerHTML = '';
                emptyState.classList.remove('hidden');
                loadMoreBtn.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                if (append) {
                    productsGrid.insertAdjacentHTML('beforeend', products.map(p => createProductCard(p)).join(''));
                } else {
                    productsGrid.innerHTML = products.map(p => createProductCard(p)).join('');
                }

                // Ensure product images are observed and only loaded when near viewport
                initProductImageObserver();
                document.querySelectorAll('#products-grid .product-image[data-src]').forEach(img => {
                    try { productImageObserver.observe(img); } catch (e) { /* ignore */ }
                });

                // Initialize infinite scroll (auto-load on scroll) and manage its lifecycle
                initInfiniteScroll();
                // If we've reached the last page, disconnect infinite scroll
                if (typeof totalPages === 'number' && currentPage >= totalPages) {
                    if (infiniteScrollObserver) { infiniteScrollObserver.disconnect(); infiniteScrollObserver = null; }
                    if (loadMoreBtn) loadMoreBtn.classList.add('hidden');
                } else {
                    if (loadMoreBtn) loadMoreBtn.classList.remove('hidden');
                }
                
                if (currentPage < totalPages) {
                    loadMoreBtn.classList.remove('hidden');
                    // ensure infinite scroll is observing
                    initInfiniteScroll();
                } else {
                    loadMoreBtn.classList.add('hidden');
                    if (infiniteScrollObserver) { infiniteScrollObserver.disconnect(); infiniteScrollObserver = null; }
                }
            }

            syncPagination();
            
            // Update URL
            const url = new URL(window.location);
            Object.keys(filters).forEach(key => {
                if (key === 'categories' || key === 'search') return;
                if (filters[key] && (Array.isArray(filters[key]) ? filters[key].length : true)) {
                    if (Array.isArray(filters[key])) {
                        url.searchParams.set(key, filters[key].join(','));
                    } else {
                        url.searchParams.set(key, filters[key]);
                    }
                } else {
                    url.searchParams.delete(key);
                }
            });

            if (filters.search) {
                url.searchParams.set('q', filters.search);
            } else {
                url.searchParams.delete('q');
            }

            if (filters.categories.length) {
                url.searchParams.set('category', filters.categories.join(','));
            } else {
                url.searchParams.delete('category');
            }
            window.history.replaceState({}, '', url);
            
        } catch (error) {
            console.error('Error loading products:', error);
            Toast.show('Failed to load products. Please try again.', { type: 'error', position: 'top-right' });
        } finally {
            isLoading = false;
            loadMoreBtn.querySelector('.load-more-text').classList.remove('hidden');
            loadMoreBtn.querySelector('.load-more-spinner').classList.add('hidden');
        }
    }

    function syncPagination() {
        if (!paginationMount) return;
        const total = Math.max(totalPages, 1);
        const current = Math.min(Math.max(currentPage, 1), total);

        if (!paginationInstance) {
            paginationInstance = new Pagination({
                totalPages: total,
                currentPage: current,
                maxVisible: 7,
                className: 'justify-center',
                onChange: (page) => {
                    currentPage = page;
                    loadProducts(false);
                }
            });
        } else {
            paginationInstance.totalPages = total;
            paginationInstance.currentPage = current;
        }

        paginationMount.innerHTML = '';
        const element = paginationInstance.create();
        paginationMount.appendChild(element);
        paginationInstance.element = element;
    }
    
    // Load filters
    async function loadFilters() {
        try {
            const container = categoriesFilterElement;
            if (!container) return;
            Object.keys(categoryNameMap).forEach(key => delete categoryNameMap[key]);

            let treeData = [];
            try {
                const treeResponse = await CategoriesApi.getTree();
                treeData = treeResponse?.data || treeResponse?.results || treeResponse || [];
            } catch (treeError) {
            }

            if (!Array.isArray(treeData) || !treeData.length) {
                const fallbackResponse = await CategoriesApi.getCategories({ pageSize: 300 });
                const categories = fallbackResponse?.data || fallbackResponse?.results || [];
                if (categories.length) {
                    treeData = buildCategoryTree(categories);
                }
            }

            if (Array.isArray(treeData) && treeData.length) {
                indexCategoryNames(treeData);
                container.innerHTML = renderCategoryTree(treeData);
            } else {
                container.innerHTML = '<p class="text-sm text-gray-500">No categories available right now.</p>';
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            if (categoriesFilterElement) {
                categoriesFilterElement.innerHTML = '<p class="text-sm text-red-500">Unable to load categories right now.</p>';
            }
        }
    }

    function setQuickFilterState(button, isActive) {
        if (!button) return;
        if (isActive) {
            button.classList.add('bg-primary-600', 'text-white', 'border-primary-600', 'ring-2', 'ring-primary-200', 'ring-offset-1', 'ring-offset-white');
            button.classList.remove('text-gray-600', 'border-gray-200', 'bg-white');
            button.setAttribute('aria-pressed', 'true');
        } else {
            button.classList.remove('bg-primary-600', 'text-white', 'border-primary-600', 'ring-2', 'ring-primary-200', 'ring-offset-1', 'ring-offset-white');
            button.classList.add('text-gray-600', 'border-gray-200', 'bg-white');
            button.setAttribute('aria-pressed', 'false');
        }
    }

    function syncQuickFilters() {
        quickFilterButtons.forEach(button => {
            const type = button.dataset.quickFilter;
            let isActive = false;

            if (type === 'price') {
                const buttonMin = button.dataset.min ?? null;
                const buttonMax = button.dataset.max ?? null;
                const normalizedMin = buttonMin === '' ? null : buttonMin;
                const normalizedMax = buttonMax === '' ? null : buttonMax;
                isActive = (filters.price_min || null) === normalizedMin && (filters.price_max || null) === normalizedMax && (filters.price_min || filters.price_max);
            } else if (type === 'sort') {
                isActive = filters.sort === (button.dataset.value || 'popular');
            } else if (filters.hasOwnProperty(type)) {
                isActive = Boolean(filters[type]);
            }

            setQuickFilterState(button, isActive);
        });
    }
    
    // Update active filters display
    function updateActiveFilters() {
        const container = document.getElementById('active-filters');
        const list = document.getElementById('active-filters-list');
        const activeFilters = [];
        
        if (filters.categories.length) {
            filters.categories.forEach(slug => {
                const label = categoryNameMap[slug] || slug;
                activeFilters.push({ key: 'category', value: slug, label: `Category: ${label}` });
            });
        }
        if (filters.price_min || filters.price_max) {
            activeFilters.push({ key: 'price', value: 'price', label: `Price: ${currency.symbol}${filters.price_min || 0} - ${currency.symbol}${filters.price_max || '∞'}` });
        }
        if (filters.search) {
            activeFilters.push({ key: 'search', value: filters.search, label: `Search: ${filters.search}` });
        }
        if (filters.in_stock) activeFilters.push({ key: 'in_stock', value: true, label: 'In Stock' });
        if (filters.on_sale) activeFilters.push({ key: 'on_sale', value: true, label: 'On Sale' });
        if (filters.new_arrivals) activeFilters.push({ key: 'new_arrivals', value: true, label: 'New Arrivals' });
        
        if (activeFilters.length > 0) {
            container.classList.remove('hidden');
            list.innerHTML = activeFilters.map(f => `
                <button class="inline-flex items-center gap-1 px-2 py-1 bg-primary-100 text-primary-700 text-sm rounded-lg hover:bg-primary-200 transition-colors" data-remove-filter="${f.key}" data-value="${f.value}">
                    ${escapeHtml(f.label)}
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `).join('');
            
            // Update mobile badge
            document.getElementById('filter-count-badge').textContent = activeFilters.length;
            document.getElementById('filter-count-badge').classList.remove('hidden');
        } else {
            container.classList.add('hidden');
            document.getElementById('filter-count-badge').classList.add('hidden');
        }

        syncQuickFilters();
    }
    
    // Reset filters
    function resetFilters() {
        filters = {
            categories: [],
            price_min: null,
            price_max: null,
            in_stock: false,
            on_sale: false,
            new_arrivals: false,
            sort: 'popular',
            search: null
        };
        
        document.querySelectorAll('.category-checkbox, #in-stock, #on-sale, #new-arrivals').forEach(cb => cb.checked = false);
        if (priceMinInput) priceMinInput.value = '';
        if (priceMaxInput) priceMaxInput.value = '';
        if (productSearchInput) productSearchInput.value = '';
        sortSelect.value = 'popular';
        mobileSortSelect.value = 'popular';
        
        updateActiveFilters();
        loadProducts();
    }
    
    // Event listeners
    sortSelect.value = filters.sort;
    mobileSortSelect.value = filters.sort;
    
    sortSelect.addEventListener('change', (e) => {
        filters.sort = e.target.value;
        mobileSortSelect.value = e.target.value;
        loadProducts();
    });
    
    mobileSortSelect.addEventListener('change', (e) => {
        filters.sort = e.target.value;
        sortSelect.value = e.target.value;
        loadProducts();
    });

    productSearchInput?.addEventListener('input', () => scheduleSearchUpdate(false));
    productSearchInput?.addEventListener('blur', () => scheduleSearchUpdate(true));
    productSearchInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            scheduleSearchUpdate(true);
        }
    });
    sidebarResetButton?.addEventListener('click', resetFilters);
    priceMinInput?.addEventListener('input', () => schedulePriceFilterUpdate(false));
    priceMaxInput?.addEventListener('input', () => schedulePriceFilterUpdate(false));
    priceMinInput?.addEventListener('change', () => schedulePriceFilterUpdate(true));
    priceMaxInput?.addEventListener('change', () => schedulePriceFilterUpdate(true));

    quickFilterButtons.forEach(button => {
        button.addEventListener('click', () => {
            const type = button.dataset.quickFilter;

            if (type === 'price') {
                const buttonMin = button.dataset.min ?? null;
                const buttonMax = button.dataset.max ?? null;
                const normalizedMin = buttonMin === '' ? null : buttonMin;
                const normalizedMax = buttonMax === '' ? null : buttonMax;
                const isAlreadyActive = (filters.price_min || null) === normalizedMin && (filters.price_max || null) === normalizedMax;

                if (isAlreadyActive) {
                    filters.price_min = null;
                    filters.price_max = null;
                } else {
                    filters.price_min = normalizedMin;
                    filters.price_max = normalizedMax;
                }

                if (priceMinInput) priceMinInput.value = filters.price_min || '';
                if (priceMaxInput) priceMaxInput.value = filters.price_max || '';
                schedulePriceFilterUpdate(true);
                return;
            } else if (type === 'sort') {
                const value = button.dataset.value || 'popular';
                const nextValue = filters.sort === value ? 'popular' : value;
                filters.sort = nextValue;
                sortSelect.value = nextValue;
                mobileSortSelect.value = nextValue;
            } else if (filters.hasOwnProperty(type)) {
                filters[type] = !filters[type];
                const checkbox = document.getElementById(type.replace('_', '-'));
                if (checkbox) checkbox.checked = filters[type];
            }

            updateActiveFilters();
            loadProducts();
        });
    });

    syncQuickFilters();
    
    // View toggle
    document.getElementById('view-grid').addEventListener('click', () => {
        viewMode = 'grid';
        document.getElementById('view-grid').classList.add('bg-primary-100', 'text-primary-700');
        document.getElementById('view-grid').classList.remove('text-gray-400');
        document.getElementById('view-list').classList.remove('bg-primary-100', 'text-primary-700');
        document.getElementById('view-list').classList.add('text-gray-400');
        // reset responsive gaps for grid
        productsGrid.className = 'grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 lg:gap-6';
        // mirror to mobile controls
        const mg = document.getElementById('mobile-view-grid'); const ml = document.getElementById('mobile-view-list');
        if (mg) mg.classList.add('bg-primary-100', 'text-primary-700');
        if (ml) ml.classList.remove('bg-primary-100', 'text-primary-700');
        loadProducts();
    });
    
    document.getElementById('view-list').addEventListener('click', () => {
        viewMode = 'list';
        document.getElementById('view-list').classList.add('bg-primary-100', 'text-primary-700');
        document.getElementById('view-list').classList.remove('text-gray-400');
        document.getElementById('view-grid').classList.remove('bg-primary-100', 'text-primary-700');
        document.getElementById('view-grid').classList.add('text-gray-400');
        productsGrid.className = 'grid grid-cols-1 gap-4';
        // mirror to mobile controls
        const mg = document.getElementById('mobile-view-grid'); const ml = document.getElementById('mobile-view-list');
        if (ml) ml.classList.add('bg-primary-100', 'text-primary-700');
        if (mg) mg.classList.remove('bg-primary-100', 'text-primary-700');
        loadProducts();
    });

    // Mobile view controls: forward to desktop handlers
    const mobileGridBtn = document.getElementById('mobile-view-grid');
    const mobileListBtn = document.getElementById('mobile-view-list');
    if (mobileGridBtn) mobileGridBtn.addEventListener('click', () => document.getElementById('view-grid').click());
    if (mobileListBtn) mobileListBtn.addEventListener('click', () => document.getElementById('view-list').click());
    
    // Load more
    loadMoreBtn.addEventListener('click', () => {
        currentPage++;
        loadProducts(true);
    });

    // Infinite scroll: observe sentinel near bottom and load next page when visible
    let infiniteScrollObserver;
    const INFINITE_SCROLL_ENABLED = true;
    function initInfiniteScroll() {
        if (!INFINITE_SCROLL_ENABLED) return;
        const sentinel = document.getElementById('scroll-sentinel');
        if (!sentinel) return;
        if (infiniteScrollObserver) return;
        infiniteScrollObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) return;
                if (isLoading) return;
                if (typeof totalPages !== 'number' || currentPage >= totalPages) {
                    if (infiniteScrollObserver) {
                        infiniteScrollObserver.disconnect();
                        infiniteScrollObserver = null;
                    }
                    return;
                }
                currentPage++;
                loadProducts(true);
            });
        }, { rootMargin: '600px 0px' });
        infiniteScrollObserver.observe(sentinel);
    }
    
    // Category filter
    categoriesFilterElement?.addEventListener('change', (e) => {
        if (e.target.classList.contains('category-checkbox')) {
            const value = e.target.value;
            if (e.target.checked) {
                if (!filters.categories.includes(value)) {
                    filters.categories.push(value);
                }
            } else {
                filters.categories = filters.categories.filter(slug => slug !== value);
            }
            updateActiveFilters();
            loadProducts();
        }
    });

    categoriesFilterElement?.addEventListener('click', (e) => {
        const toggleButton = e.target.closest('[data-category-toggle]');
        if (toggleButton) {
            e.preventDefault();
            e.stopPropagation();
            const targetSlug = toggleButton.dataset.categoryToggle;
            if (!targetSlug) return;
            const selector = escapeSelector(targetSlug);
            if (!selector) return;
            const childList = categoriesFilterElement.querySelector(`[data-category-children="${selector}"]`);
            if (childList) {
                childList.classList.toggle('hidden');
                const icon = toggleButton.querySelector('svg');
                const expanded = !childList.classList.contains('hidden');
                if (icon) {
                    icon.classList.toggle('rotate-90', expanded);
                    icon.classList.toggle('rotate-0', !expanded);
                }
                toggleButton.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            }
        }
    });
    
    // Availability filters
    document.getElementById('in-stock').addEventListener('change', (e) => {
        filters.in_stock = e.target.checked;
        updateActiveFilters();
        loadProducts();
    });
    
    document.getElementById('on-sale').addEventListener('change', (e) => {
        filters.on_sale = e.target.checked;
        updateActiveFilters();
        loadProducts();
    });
    
    document.getElementById('new-arrivals').addEventListener('change', (e) => {
        filters.new_arrivals = e.target.checked;
        updateActiveFilters();
        loadProducts();
    });
    
    // Clear all filters
    document.getElementById('clear-all-filters').addEventListener('click', resetFilters);
    document.getElementById('reset-filters').addEventListener('click', resetFilters);
    
    // Remove single filter
    document.getElementById('active-filters-list').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-remove-filter]');
        if (btn) {
            const key = btn.dataset.removeFilter;
            const value = btn.dataset.value;
            
            if (key === 'price') {
                filters.price_min = null;
                filters.price_max = null;
                document.getElementById('price-min').value = '';
                document.getElementById('price-max').value = '';
            } else if (key === 'category') {
                filters.categories = filters.categories.filter(slug => slug !== value);
                const checkbox = document.querySelector(`.category-checkbox[value="${value}"]`);
                if (checkbox) checkbox.checked = false;
            } else if (key === 'search') {
                filters.search = null;
                if (productSearchInput) productSearchInput.value = '';
            } else {
                filters[key] = false;
                const checkbox = document.getElementById(key.replace('_', '-'));
                if (checkbox) checkbox.checked = false;
            }
            
            updateActiveFilters();
            loadProducts();
        }
    });
    
    // Filter collapse
    document.querySelectorAll('.filter-collapse').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetSelector = btn.getAttribute('data-collapse-target');
            const content = targetSelector ? document.querySelector(targetSelector) : null;
            if (!content) return;
            content.classList.toggle('hidden');
            btn.querySelector('svg')?.classList.toggle('rotate-180');
        });
    });
    
    // Mobile filters modal
    const filtersModal = document.getElementById('filters-modal');
    const filtersModalContent = document.getElementById('filters-modal-content');

    // Sidebar element move/restore helpers to avoid duplicating inputs
    const filtersSidebar = document.getElementById('filters-sidebar');
    const mobileFiltersMount = document.getElementById('mobile-filters-content');
    let _sidebarOriginalParent = filtersSidebar ? filtersSidebar.parentNode : null;
    let _sidebarNextSibling = filtersSidebar ? filtersSidebar.nextElementSibling : null;
    const _sidebarOriginalClasses = filtersSidebar ? filtersSidebar.className : '';
    let _sidebarMovedToModal = false;
    let _previousActiveElement = null;

    function moveSidebarToModal() {
        if (!filtersSidebar || !_sidebarOriginalParent || _sidebarMovedToModal) return;
        // remove the 'hidden' utility so it is visible in modal and make sure it displays as block
        filtersSidebar.classList.remove('hidden');
        filtersSidebar.classList.remove('w-72', 'flex-shrink-0');
        filtersSidebar.classList.add('block', 'w-full');
        mobileFiltersMount.appendChild(filtersSidebar);
        _sidebarMovedToModal = true;
    }

    function restoreSidebarToOriginal() {
        if (!filtersSidebar || !_sidebarOriginalParent || !_sidebarMovedToModal) return;
        // restore original classes
        filtersSidebar.className = _sidebarOriginalClasses;
        if (_sidebarNextSibling) {
            _sidebarOriginalParent.insertBefore(filtersSidebar, _sidebarNextSibling);
        } else {
            _sidebarOriginalParent.appendChild(filtersSidebar);
        }
        _sidebarMovedToModal = false;
    }

    document.getElementById('open-filters').addEventListener('click', () => {
        // move sidebar into modal for mobile, keeping the same inputs and listeners
        if (filtersSidebar && mobileFiltersMount) moveSidebarToModal();
        _previousActiveElement = document.activeElement;
        filtersModal.classList.remove('hidden');
        setTimeout(() => filtersModalContent.classList.remove('-translate-x-full'), 10);
        document.body.style.overflow = 'hidden';
        // set aria-expanded
        try { document.getElementById('open-filters').setAttribute('aria-expanded', 'true'); } catch (e) {}
        // focus first focusable element inside modal
        setTimeout(() => {
            const focusable = filtersModal.querySelector('input, select, button, [tabindex]');
            if (focusable) focusable.focus();
        }, 150);
    });

    filtersModal.querySelectorAll('[data-close-modal]').forEach(el => {
        el.addEventListener('click', () => {
            filtersModalContent.classList.add('-translate-x-full');
            setTimeout(() => {
                filtersModal.classList.add('hidden');
                // restore sidebar back to desktop location
                restoreSidebarToOriginal();
            }, 300);
            document.body.style.overflow = '';
            try { document.getElementById('open-filters').setAttribute('aria-expanded', 'false'); } catch (e) {}
            if (_previousActiveElement) _previousActiveElement.focus();
        });

    // Ensure that sidebar is restored on desktop/resizes in case modal was left open
    window.addEventListener('resize', () => {
        try {
            if (window.innerWidth >= 1024 && _sidebarMovedToModal) {
                restoreSidebarToOriginal();
            }
        } catch (e) { /* ignore */ }
    });

    // Close modal on Escape key when open
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && filtersModal && !filtersModal.classList.contains('hidden')) {
            filtersModalContent.classList.add('-translate-x-full');
            setTimeout(() => {
                filtersModal.classList.add('hidden');
                restoreSidebarToOriginal();
            }, 300);
            document.body.style.overflow = '';
            if (_previousActiveElement) _previousActiveElement.focus();
        }
    });
    });

    document.getElementById('mobile-clear-filters')?.addEventListener('click', () => {
        resetFilters();
        filtersModalContent.classList.add('-translate-x-full');
        setTimeout(() => {
            filtersModal.classList.add('hidden');
            restoreSidebarToOriginal();
        }, 300);
        document.body.style.overflow = '';
        try { document.getElementById('open-filters').setAttribute('aria-expanded', 'false'); } catch (e) {}
        if (_previousActiveElement) _previousActiveElement.focus();
    });

    document.getElementById('mobile-apply-filters')?.addEventListener('click', () => {
        filtersModalContent.classList.add('-translate-x-full');
        setTimeout(() => {
            filtersModal.classList.add('hidden');
            restoreSidebarToOriginal();
        }, 300);
        document.body.style.overflow = '';
        loadProducts();
        if (_previousActiveElement) _previousActiveElement.focus();
    });
    
    // Update title if category
    if (filters.categories.length === 1) {
        try {
            const response = await CategoriesApi.getCategory(filters.categories[0]);
            const category = response.data || response;
            if (category) {
                  pageTitle.textContent = category.name;
            }
        } catch (error) {
            // Use default
        }
    } else if (filters.categories.length > 1) {
        pageTitle.textContent = 'Filtered Products';
    }
    
    // Initial load
    updateActiveFilters();
    await loadFilters();
    loadProducts();
});
</script>
{% endblock %}
