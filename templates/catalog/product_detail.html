{% extends 'base.html' %}
{% load static %}
{% load currency_tags %}
{% load seo_tags %}

{% block page_id %}product{% endblock %}
{% block title %}{{ product.meta_title|default:product.name|seo_title }} - {{ SITE_NAME }}{% endblock %}
{% block meta_description %}{{ product.meta_description|default:product.short_description|seo_desc }}{% endblock %}
{% block og_title %}{{ product.meta_title|default:product.name|seo_title }}{% endblock %}
{% block og_description %}{{ product.meta_description|default:product.short_description|seo_desc }}{% endblock %}
{% block og_image %}{% if primary_image %}{{ primary_image.image.url }}{% else %}{% static 'images/og-image.jpg' %}{% endif %}{% endblock %}

{% block content %}
<div id="product-detail" class="container mx-auto px-4 py-8" data-product-slug="{{ product.slug }}" data-product-id="{{ product.id }}">
    <!-- Breadcrumb -->
    <nav id="breadcrumbs" class="mb-8">
        <ol class="flex items-center space-x-2 text-sm text-gray-500 dark:text-stone-500 transition-colors duration-500">
            <li><a href="{% url 'home' %}" class="hover:text-primary-600 dark:hover:text-amber-400 transition-colors duration-500">Home</a></li>
            <li><span class="mx-2">/</span></li>
            <li><a href="{% url 'catalog:product-list' %}" class="hover:text-primary-600 dark:hover:text-amber-400 transition-colors duration-500">Products</a></li>
            {% if product.primary_category %}
            <li><span class="mx-2">/</span></li>
            <li><a href="{% url 'catalog:category-detail' product.primary_category.get_slug_path %}" class="hover:text-primary-600 dark:hover:text-amber-400 transition-colors duration-500">{{ product.primary_category.name }}</a></li>
            {% endif %}
            <li><span class="mx-2">/</span></li>
            <li class="text-stone-900 dark:text-stone-100 transition-colors duration-500">{{ product.name }}</li>
        </ol>
    </nav>

    <!-- Structured Data: Product + Breadcrumb -->
    <script type="application/ld+json" data-ld="product">
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "name": "{{ product.name|escapejs }}",
      "image": [{% for img in gallery_images %}"{{ request.scheme }}://{{ request.get_host }}{{ img.image.url }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
      "description": "{{ product.short_description|default:''|truncatechars:300|escapejs }}",
      "sku": "{{ product.sku|default:'' }}",
      {% if product.brand %}
      "brand": { "@type": "Brand", "name": "{{ product.brand.name|escapejs }}" },
      {% endif %}
      "offers": {
        "@type": "Offer",
        "url": "{{ request.build_absolute_uri }}",
        "priceCurrency": "{{ currency_code|default:'BDT' }}",
        "price": "{{ product.current_price }}",
        "availability": "https://schema.org/{% if product.stock_quantity > 0 %}InStock{% else %}OutOfStock{% endif %}"
      }{% if product.average_rating %},
      "aggregateRating": { "@type": "AggregateRating", "ratingValue": "{{ product.average_rating }}", "reviewCount": "{{ product.reviews_count|default:0 }}" }
      {% endif %}
    }
    </script>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Product Images -->
        <div>
            <!-- Main Image -->
            <div class="aspect-square bg-gray-100 dark:bg-stone-800 rounded-lg overflow-hidden mb-4 shadow-sm hover:shadow-lg transition-all duration-500 relative">
                {% if primary_image %}
                <img id="main-image" src="{{ primary_image.image.url }}" alt="{{ primary_image.alt_text|default:product.name }}" loading="lazy" decoding="async" class="w-full h-full object-cover">
                <!-- zoom hint -->
                <div class="absolute bottom-3 right-3 bg-black/40 text-white p-1 rounded-md text-xs flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
                    <span>Zoom</span>
                </div>
                {% else %}
                <div class="w-full h-full flex items-center justify-center">
                    <svg class="w-24 h-24 text-gray-300 dark:text-stone-700 transition-colors duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                {% endif %}
            </div>
            
            <!-- Thumbnails -->
            {% if gallery_images.count > 1 %}
            <div class="grid grid-cols-5 gap-2" role="list" aria-label="Product images">
                {% for image in gallery_images %}
                <button onclick="changeImage('{{ image.image.url }}')" 
                        class="aspect-square bg-gray-100 dark:bg-stone-800 rounded-lg overflow-hidden border-2 border-transparent hover:border-primary-500 dark:hover:border-amber-500 focus:border-primary-500 dark:focus:border-amber-500 focus:outline-none transition-colors duration-500"
                        role="listitem" aria-label="View image {{ forloop.counter }}">
                    <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:product.name }}" loading="lazy" decoding="async" class="w-full h-full object-cover">
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div>
            <!-- Category -->
            <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-stone-500 mb-2 transition-colors duration-500">
                {% if product.primary_category %}
                <a href="{% url 'catalog:category-detail' product.primary_category.get_slug_path %}" class="hover:text-primary-600 dark:hover:text-amber-400 transition-colors duration-500">
                    {{ product.primary_category.name }}
                </a>
                {% endif %}
                {% if product.brand %}
                <span>â€¢</span>
                <span>{{ product.brand.name }}</span>
                {% endif %}
            </div>
            
            <!-- Title -->
            <h1 class="text-3xl font-bold text-stone-900 dark:text-stone-100 mb-2 transition-colors duration-500">{{ product.name }}</h1>

            <!-- Artisan Link -->
            {% if product.artisan %}
            <div class="mb-4">
                <span class="text-sm text-gray-500">By:</span>
                <a href="{{ product.artisan.get_absolute_url }}" class="text-lg font-semibold text-blue-600 hover:underline">
                    {{ product.artisan.name }}
                </a>
            </div>
            {% endif %}

            <!-- Badges -->
            <div class="flex flex-wrap items-center gap-2 mb-4" aria-hidden="false">
                {% if product.is_new %}
                <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">New</span>
                {% endif %}
                {% if product.sale_price %}
                <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold">On Sale</span>
                {% endif %}
                {% for badge in badges %}
                <span class="px-2 py-1 rounded text-xs font-semibold" style="background-color: {{ badge.background_color|default:'#f3f4f6' }}; color: {{ badge.text_color|default:'#374151' }};">
                    {{ badge.name }}
                </span>
                {% endfor %}
            </div>
            
            <!-- Rating -->
            {% if review_summary.average_rating %}
            <div class="flex items-center space-x-4 mb-4">
                <div class="flex items-center">
                    <div class="flex text-yellow-400">
                        {% for i in "12345" %}
                        {% if forloop.counter <= review_summary.average_rating %}
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5 fill-current text-gray-300 dark:text-stone-600" viewBox="0 0 20 20">
                            <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                        </svg>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <span class="ml-2 text-gray-600 dark:text-stone-400">{{ review_summary.average_rating }}</span>
                </div>
                <a href="#reviews" class="text-primary-600 hover:text-primary-700">
                    {{ review_summary.total_reviews }} reviews
                </a>
            </div>
            {% endif %}
            
            <!-- Price -->
            <div class="mb-6">
                {% if product.sale_price %}
                <div class="flex items-center space-x-4">
                    <span id="product-price" class="text-3xl font-bold text-red-600">{% format_price product.sale_price product.currency %}</span>
                    <span class="text-xl text-gray-400 line-through">{% format_price product.price product.currency %}</span>
                    {% if product.discount_percentage %}
                    <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-sm font-semibold">
                        {{ product.discount_percentage }}% off
                    </span>
                    {% endif %}
                </div>
                {% else %}
                <span id="product-price" class="text-3xl font-bold text-gray-900 dark:text-stone-100">{% format_price product.price product.currency %}</span>
                {% endif %}
            </div>
            
            <!-- Short Description -->
            {% if product.short_description %}
            <p class="text-gray-600 dark:text-stone-400 mb-6">{{ product.short_description }}</p>
            {% endif %}
            
            <!-- Variant Options -->
            {% if has_variants and variant_options %}
            <div class="mb-6">
                {% for option_name, option_values in variant_options.items %}
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ option_name }}</label>
                    <div class="flex flex-wrap gap-2">
                        {% for opt in option_values %}
                        <button type="button" 
                                onclick="selectVariant('{{ opt.variant_id }}', '{{ option_name }}', '{{ opt.value }}')"
                                class="variant-btn px-4 py-2 border border-gray-300 rounded-lg hover:border-primary-500 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-colors {% if not opt.in_stock %}opacity-50{% endif %}"
                                data-variant="{{ opt.variant_id }}"
                                data-price="{{ opt.price }}"
                                {% if not opt.in_stock %}disabled{% endif %}>
                            {{ opt.value }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Quantity & Add to Cart -->
            <div class="flex items-center space-x-4 mb-6">
                <div class="flex items-center border border-gray-300 dark:border-stone-700 rounded-lg">
                    <button id="decrease-qty" class="px-2 py-2 text-gray-600 dark:text-stone-300 hover:text-primary-600 dark:hover:text-amber-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                        </svg>
                    </button>
                    <input type="number" id="quantity" value="1" min="1" max="{{ product.stock_quantity }}"
                           class="w-16 text-center border-0 focus:ring-0">
                    <button id="increase-qty" class="px-2 py-2 text-gray-600 dark:text-stone-300 hover:text-primary-600 dark:hover:text-amber-400">
                        <svg class="w-6 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path>
                        </svg>
                    </button>
                </div>
                
                {% if product.stock_quantity > 0 %}
                <button id="add-to-cart-btn"
                        class="flex-1 bg-primary-600 hover:bg-primary-700 text-white py-3 px-6 rounded-lg font-semibold transition-colors"
                        data-product-id="{{ product.id }}">
                    Add to Cart
                </button>
                {% else %}
                <button class="flex-1 bg-gray-300 text-gray-500 py-3 px-6 rounded-lg font-semibold cursor-not-allowed" disabled>
                    Out of Stock
                </button>
                {% endif %}

                <button id="add-to-wishlist-btn"
                    class="p-2 border border-gray-300 rounded-lg hover:border-primary-500 hover:text-red-500 transition-colors"
                    data-product-id="{{ product.id }}"
                    title="Add to Wishlist" aria-pressed="false">
                    <svg class="w-7 h-7" stroke="currentColor" viewBox="0 0 24 24">
                        <path class="heart-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                        </path>
                    </svg>
                </button>
            </div>

            {% if product.can_be_customized %}
            <div class="mt-4">
                <button id="request-customization-btn" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold transition-colors"
                        data-product-id="{{ product.id }}">
                    Request a Customization
                </button>
            </div>
            {% endif %}

            <!-- Stock Status -->
            <div id="stock-status" class="mb-4" aria-live="polite">
                {% if product.stock_quantity > 10 %}
                <span class="text-green-600 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    In Stock
                </span>
                {% elif product.stock_quantity > 0 %}
                <span class="text-orange-500 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    Only {{ product.stock_quantity }} left
                </span>
                {% else %}
                <span class="text-red-600 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    Out of Stock
                    <button id="back-in-stock-btn" class="ml-3 text-sm text-primary-600 dark:text-amber-400 hover:underline">
                        Notify Me When Back in Stock
                    </button>
                </span>
                {% endif %}
            </div>

            <!-- Delivery Estimate - NEW ENHANCED SECTION -->
            <div id="delivery-estimate" class="mb-6">
                <!-- Populated by JS -->
            </div>

            <!-- Size Guide Button - NEW ENHANCED SECTION -->
            {% if product.has_size_variants or product.primary_category.slug == 'clothing' or product.primary_category.slug == 'apparel' %}
            <div class="mb-4">
                <button id="size-guide-btn" class="inline-flex items-center gap-2 text-sm text-primary-600 dark:text-amber-400 hover:underline">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    Size Guide
                </button>
            </div>
            {% endif %}
            
            <!-- SKU -->
            {% if product.sku %}
            <div class="text-sm text-gray-500 mb-6">
                <span>SKU: {{ product.sku }}</span>
            </div>
            {% endif %}
            
            <!-- Share -->
            <div class="flex items-center space-x-4 border-t pt-6">
                <span class="text-gray-600 dark:text-stone-400">Share:</span>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                   target="_blank" class="text-gray-400 dark:text-stone-400 hover:text-blue-600">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/>
                    </svg>
                </a>
                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ product.name }}" 
                   target="_blank" class="text-gray-400 hover:text-blue-400">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/>
                    </svg>
                </a>
                <a href="https://pinterest.com/pin/create/button/?url={{ request.build_absolute_uri }}&description={{ product.name }}" 
                   target="_blank" class="text-gray-400 hover:text-red-600">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.627 0-12 5.372-12 12 0 5.084 3.163 9.426 7.627 11.174-.105-.949-.2-2.405.042-3.441.218-.937 1.407-5.965 1.407-5.965s-.359-.719-.359-1.782c0-1.668.967-2.914 2.171-2.914 1.023 0 1.518.769 1.518 1.69 0 1.029-.655 2.568-.994 3.995-.283 1.194.599 2.169 1.777 2.169 2.133 0 3.772-2.249 3.772-5.495 0-2.873-2.064-4.882-5.012-4.882-3.414 0-5.418 2.561-5.418 5.207 0 1.031.397 2.138.893 2.738.098.119.112.224.083.345l-.333 1.36c-.053.22-.174.267-.402.161-1.499-.698-2.436-2.889-2.436-4.649 0-3.785 2.75-7.262 7.929-7.262 4.163 0 7.398 2.967 7.398 6.931 0 4.136-2.607 7.464-6.227 7.464-1.216 0-2.359-.631-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146 1.124.347 2.317.535 3.554.535 6.627 0 12-5.373 12-12 0-6.628-5.373-12-12-12z"/>
                    </svg>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Mobile Sticky Add-to-Cart -->
    <div id="mobile-sticky-atc" class="fixed inset-x-4 bottom-4 z-40 lg:hidden">
        <div class="bg-stone-50 dark:bg-stone-900 shadow-lg rounded-xl p-3 flex items-center gap-3 border border-stone-200 dark:border-stone-700 transition-colors duration-500">
            <div class="flex-1">
                {% if product.sale_price %}
                <div class="text-sm text-stone-500 dark:text-stone-400">Now</div>
                <div class="font-semibold text-lg text-red-600">{% format_price product.sale_price product.currency %} <span class="text-sm line-through text-stone-400 dark:text-stone-500">{% format_price product.price product.currency %}</span></div>
                {% else %}
                <div class="font-semibold text-lg text-stone-900 dark:text-stone-100">{% format_price product.price product.currency %}</div>
                {% endif %}
                <div id="mobile-stock" class="text-xs text-stone-500 dark:text-stone-400">{% if product.stock_quantity > 0 %}In stock{% else %}Out of stock{% endif %}</div>
            </div>
            {% if product.stock_quantity > 0 %}
            <button id="mobile-add-to-cart" class="bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-amber-700 transition-colors duration-500" data-product-id="{{ product.id }}">Add</button>
            {% else %}
            <button class="bg-stone-300 dark:bg-stone-700 text-stone-500 dark:text-stone-400 px-4 py-2 rounded-lg font-semibold cursor-not-allowed transition-colors duration-500" disabled>Out</button>
            {% endif %}
        </div>
    </div>

    <!-- Product Details Tabs -->
    <div class="mt-16">
        <div class="border-b border-stone-200 dark:border-stone-700">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button class="tab-btn border-b-2 border-amber-500 py-4 px-1 text-sm font-medium text-amber-600 dark:text-amber-400 transition-colors duration-500" data-tab="description">Description</button>
                {% if product.making_of_steps.exists %}
                <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 hover:border-stone-300 dark:hover:border-stone-500 transition-colors duration-500" data-tab="making-of">The Making Of</button>
                {% endif %}
                <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 hover:border-stone-300 dark:hover:border-stone-500 transition-colors duration-500" data-tab="reviews">Reviews ({{ review_summary.total_reviews|default:0 }})</button>
                {% if product.customer_photos.approved.exists %}
                <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 hover:border-stone-300 dark:hover:border-stone-500 transition-colors duration-500" data-tab="customer-photos">Customer Photos</button>
                {% endif %}
                <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 hover:border-stone-300 dark:hover:border-stone-500 transition-colors duration-500" data-tab="qa">Q&A</button>
            </nav>
        </div>
        
        <div id="description-tab" class="tab-content py-8">
            <div class="prose max-w-none dark:prose-invert">
                {{ product.description|safe }}
            </div>
        </div>

        {% if product.making_of_steps.exists %}
        <div id="making-of-tab" class="tab-content py-8 hidden">
            <div class="space-y-8">
                {% for step in product.making_of_steps.all %}
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="md:w-1/2">
                        {% if step.image %}
                        <img src="{{ step.image.url }}" alt="{{ step.title }}" class="rounded-lg shadow-md w-full">
                        {% elif step.video_url %}
                        <div class="aspect-w-16 aspect-h-9">
                            <iframe src="{{ step.video_url }}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen class="rounded-lg shadow-md w-full h-full"></iframe>
                        </div>
                        {% endif %}
                    </div>
                    <div class="md:w-1/2">
                        <h3 class="text-2xl font-bold mb-2">{{ step.title }}</h3>
                        <p class="text-gray-700">{{ step.description|linebreaks }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if product.customer_photos.approved.exists %}
        <div id="customer-photos-tab" class="tab-content py-8 hidden">
            <h3 class="text-xl font-bold mb-4">Customer Photos</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {% for photo in product.customer_photos.approved %}
                <div class="relative group aspect-square rounded-lg overflow-hidden shadow-md">
                    <img src="{{ photo.image.url }}" alt="{{ photo.description }}" class="w-full h-full object-cover">
                    {% if photo.description %}
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        {{ photo.description }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="mt-8 text-center">
                <button id="upload-customer-photo-btn" class="inline-flex items-center justify-center px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition-colors duration-500">
                    Upload Your Photo
                </button>
            </div>
        </div>
        {% endif %}
        
        <div id="reviews-tab" class="tab-content py-8 hidden">
            <div id="reviews-section">
                {% if recent_reviews %}
                <div class="space-y-6">
                    {% for review in recent_reviews %}
                    <div class="border-b border-stone-200 dark:border-stone-700 pb-6 transition-colors duration-500">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="flex text-yellow-400">
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                    <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                    </svg>
                                    {% else %}
                                    <svg class="w-4 h-4 fill-current text-stone-300 dark:text-stone-600" viewBox="0 0 20 20">
                                        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                    </svg>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="ml-2 text-sm font-medium text-stone-900 dark:text-stone-100 transition-colors duration-500">{{ review.user.get_display_name }}</span>
                            </div>
                            <span class="text-sm text-stone-500 dark:text-stone-400 transition-colors duration-500">{{ review.created_at|date:"M d, Y" }}</span>
                        </div>
                        {% if review.title %}
                        <h4 class="font-medium text-stone-900 dark:text-stone-100 mb-1 transition-colors duration-500">{{ review.title }}</h4>
                        {% endif %}
                        <p class="text-stone-600 dark:text-stone-400 transition-colors duration-500">{{ review.comment }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-stone-500 dark:text-stone-400 transition-colors duration-500">No reviews yet. Be the first to review this product!</p>
                {% endif %}
                
                <a href="{% url 'catalog:create-review' product.slug %}" class="mt-6 inline-flex items-center justify-center px-5 py-2 rounded-full bg-amber-600 dark:bg-amber-600 text-white text-sm font-medium hover:bg-amber-700 dark:hover:bg-amber-700 transition-colors duration-500">
                    Write a Review
                </a>
            </div>
        </div>

        <!-- Q&A Tab - NEW ENHANCED SECTION -->
        <div id="qa-tab" class="tab-content py-8 hidden">
            <div id="qa-section">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- ML-Powered: Frequently Bought Together -->
    <section id="ml-fbt" class="mt-16" data-ml-recommendations="fbt" data-product-id="{{ product.id }}" data-limit="5" data-layout="carousel" data-show-header="true" data-title="Frequently Bought Together">
        <!-- ML recommendations loaded by JavaScript -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            {% for i in "12345" %}
            <div class="skeleton h-64 rounded-2xl"></div>
            {% endfor %}
        </div>
    </section>
    
    <!-- ML-Powered: Similar Products -->
    <section id="ml-similar-products" class="mt-16" data-ml-recommendations="similar" data-product-id="{{ product.id }}" data-limit="8" data-show-header="true" data-title="You May Also Like" data-subtitle="Based on this product">
        <!-- ML recommendations loaded by JavaScript -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for i in "12345678" %}
            <div class="skeleton h-72 rounded-2xl"></div>
            {% endfor %}
        </div>
    </section>
    
    <!-- ML-Powered: Visually Similar Products -->
    <section id="ml-visually-similar-products" class="mt-16" data-ml-recommendations="visual" data-product-id="{{ product.id }}" data-limit="8" data-show-header="true" data-title="Visually Similar Products">
        <!-- Visually similar products loaded by JavaScript -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for i in "12345678" %}
            <div class="skeleton h-72 rounded-2xl"></div>
            {% endfor %}
        </div>
    </section>
    
    <!-- Related Products (Fallback) -->
    {% if related_products %}
    <section id="related-products" class="mt-16">
        <h2 class="text-2xl font-bold mb-8">Related Products</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% for related in related_products %}
            {% include 'catalog/partials/product_card.html' with product=related %}
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<!-- Customization Request Modal -->
<div id="customization-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Request Customization for <br> "{{ product.name }}"</h3>
            <div class="mt-2 px-7 py-3">
                <form id="customization-form" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="product" value="{{ product.id }}">
                    <div class="mb-4">
                        <label for="id_name" class="block text-sm font-medium text-gray-700 text-left">Your Name</label>
                        <input type="text" name="name" id="id_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="id_email" class="block text-sm font-medium text-gray-700 text-left">Your Email</label>
                        <input type="email" name="email" id="id_email" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="id_phone" class="block text-sm font-medium text-gray-700 text-left">Your Phone (Optional)</label>
                        <input type="text" name="phone" id="id_phone"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="id_message" class="block text-sm font-medium text-gray-700 text-left">Describe your customization</label>
                        <textarea name="message" id="id_message" rows="4" required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="submit-customization-btn" type="submit"
                                class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            Submit Request
                        </button>
                        <button id="cancel-customization-btn" type="button"
                                class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<!-- Customer Photo Upload Modal -->
<div id="customer-photo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Upload Your Photo for <br> "{{ product.name }}"</h3>
            <div class="mt-2 px-7 py-3">
                <form id="customer-photo-form" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="product" value="{{ product.id }}">
                    <div class="mb-4">
                        <label for="id_image" class="block text-sm font-medium text-gray-700 text-left">Photo</label>
                        <input type="file" name="image" id="id_image" accept="image/*" required
                               class="mt-1 block w-full text-sm text-gray-500
                               file:mr-4 file:py-2 file:px-4
                               file:rounded-full file:border-0
                               file:text-sm file:font-semibold
                               file:bg-blue-50 file:text-blue-700
                               hover:file:bg-blue-100">
                    </div>
                    <div class="mb-4">
                        <label for="id_description" class="block text-sm font-medium text-gray-700 text-left">Description (Optional)</label>
                        <textarea name="description" id="id_description" rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="submit-customer-photo-btn" type="submit"
                                class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            Upload Photo
                        </button>
                        <button id="cancel-customer-photo-btn" type="button"
                                class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Back in Stock Notification Modal -->
<div id="back-in-stock-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Notify Me When Back in Stock <br> "{{ product.name }}"</h3>
            <div class="mt-2 px-7 py-3">
                <form id="back-in-stock-form" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="product" value="{{ product.id }}">
                    <input type="hidden" name="variant" value="" id="back-in-stock-variant">
                    {% if not request.user.is_authenticated %}
                    <div class="mb-4">
                        <label for="id_back_in_stock_email" class="block text-sm font-medium text-gray-700 text-left">Your Email</label>
                        <input type="email" name="email" id="id_back_in_stock_email" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-600 mb-4">We'll notify you at your registered email: <strong>{{ request.user.email }}</strong></p>
                    {% endif %}
                    
                    <div class="items-center px-4 py-3">
                        <button id="submit-back-in-stock-btn" type="submit"
                                class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                            Submit Request
                        </button>
                        <button id="cancel-back-in-stock-btn" type="button"
                                class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/ml-recommendations.js' %}"></script>
<script>
    function changeImage(imageUrl) {
        var mainImage = document.getElementById('main-image');
        if (mainImage) {
            mainImage.src = imageUrl;
        }
    }
    
    function selectVariant(variantId, optionName, value) {
        document.querySelectorAll('.variant-btn').forEach(function(btn) {
            btn.classList.remove('border-primary-500', 'bg-primary-50', 'text-primary-700');
        });
        document.querySelectorAll('.variant-btn[data-variant="' + variantId + '"]').forEach(function(btn) {
            btn.classList.add('border-primary-500', 'bg-primary-50', 'text-primary-700');
        });
    }
    
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(function(b) {
                b.classList.remove('border-primary-500', 'text-primary-600');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(function(c) {
                c.classList.add('hidden');
            });
            this.classList.add('border-primary-500', 'text-primary-600');
            this.classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(this.dataset.tab + '-tab').classList.remove('hidden');
        });
    });
    
    // Quantity controls
    document.getElementById('decrease-qty')?.addEventListener('click', function() {
        var input = document.getElementById('quantity');
        if (parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
    });
    document.getElementById('increase-qty')?.addEventListener('click', function() {
        var input = document.getElementById('quantity');
        var max = parseInt(input.max) || 999;
        if (parseInt(input.value) < max) input.value = parseInt(input.value) + 1;
    });

    // Customization Request Modal Logic
    const customizationModal = document.getElementById('customization-modal');
    const requestCustomizationBtn = document.getElementById('request-customization-btn');
    const cancelCustomizationBtn = document.getElementById('cancel-customization-btn');
    const customizationForm = document.getElementById('customization-form');
    const productId = document.getElementById('product-detail').dataset.productId;

    if (requestCustomizationBtn) {
        requestCustomizationBtn.addEventListener('click', () => {
            customizationModal.classList.remove('hidden');
        });
    }

    if (cancelCustomizationBtn) {
        cancelCustomizationBtn.addEventListener('click', () => {
            customizationModal.classList.add('hidden');
            customizationForm.reset();
        });
    }

    if (customizationForm) {
        customizationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(customizationForm);
            const data = {
                product: productId,
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                message: formData.get('message'),
            };

            try {
                const response = await fetch('/api/v1/contacts/customization-requests/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    customizationModal.classList.add('hidden');
                    customizationForm.reset();
                } else {
                    alert('Error: ' + JSON.stringify(result.errors || result.message));
                }
            } catch (error) {
                console.error('Error submitting customization request:', error);
                alert('An unexpected error occurred. Please try again.');
            }
        });
    }

    // Customer Photo Upload Modal Logic
    const customerPhotoModal = document.getElementById('customer-photo-modal');
    const uploadCustomerPhotoBtn = document.getElementById('upload-customer-photo-btn');
    const cancelCustomerPhotoBtn = document.getElementById('cancel-customer-photo-btn');
    const customerPhotoForm = document.getElementById('customer-photo-form');

    if (uploadCustomerPhotoBtn) {
        uploadCustomerPhotoBtn.addEventListener('click', () => {
            customerPhotoModal.classList.remove('hidden');
        });
    }

    if (cancelCustomerPhotoBtn) {
        cancelCustomerPhotoBtn.addEventListener('click', () => {
            customerPhotoModal.classList.add('hidden');
            customerPhotoForm.reset();
        });
    }

    if (customerPhotoForm) {
        customerPhotoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(customerPhotoForm);
            formData.append('product', productId);

            try {
                const response = await fetch('/api/v1/catalog/customer-photos/upload/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: formData,
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    customerPhotoModal.classList.add('hidden');
                    customerPhotoForm.reset();
                    // Optionally, reload customer photos section or update dynamically
                } else {
                    alert('Error: ' + JSON.stringify(result.errors || result.message));
                }
            } catch (error) {
                console.error('Error submitting customer photo:', error);
                alert('An unexpected error occurred. Please try again.');
            }
        });
    }

    // Back in Stock Notification Modal Logic
    const backInStockModal = document.getElementById('back-in-stock-modal');
    const backInStockBtn = document.getElementById('back-in-stock-btn');
    const cancelBackInStockBtn = document.getElementById('cancel-back-in-stock-btn');
    const backInStockForm = document.getElementById('back-in-stock-form');
    const backInStockVariantInput = document.getElementById('back-in-stock-variant');

    if (backInStockBtn) {
        backInStockBtn.addEventListener('click', () => {
            // Check for selected variant if applicable
            const selectedVariantBtn = document.querySelector('.variant-btn.border-primary-500');
            if (selectedVariantBtn) {
                backInStockVariantInput.value = selectedVariantBtn.dataset.variant;
            } else {
                backInStockVariantInput.value = ''; // No specific variant selected
            }
            backInStockModal.classList.remove('hidden');
        });
    }

    if (cancelBackInStockBtn) {
        cancelBackInStockBtn.addEventListener('click', () => {
            backInStockModal.classList.add('hidden');
            backInStockForm.reset();
        });
    }

    if (backInStockForm) {
        backInStockForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(backInStockForm);
            const data = {
                product: productId,
                variant: formData.get('variant'),
                email: formData.get('email'),
            };

            try {
                const response = await fetch(`/api/v1/products/${productSlug}/request-back-in-stock/`, { // Use productSlug from data-product-slug
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.detail === 'You have already requested a notification for this product/variant.') {
                    alert(result.detail);
                } else if (result.success) {
                    alert(result.detail);
                    backInStockModal.classList.add('hidden');
                    backInStockForm.reset();
                } else {
                    alert('Error: ' + JSON.stringify(result.errors || result.detail));
                }
            } catch (error) {
                console.error('Error submitting back in stock request:', error);
                alert('An unexpected error occurred. Please try again.');
            }
        });
    }
</script>
{% endblock %}
