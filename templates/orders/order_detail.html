{% extends "base.html" %}
{% load static %}

{% block title %}Order Details - {{ site_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 py-12 px-4 sm:px-6 lg:px-8" x-data="orderDetailApp()" x-init="init('{{ order.id }}', '{{ order.can_be_cancelled }}')">
    <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 md:p-10">
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-gray-100 mb-6 text-center">
            Order #{{ order.order_number }}
        </h1>

        <!-- Order Status and Actions -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner">
            <div class="text-lg font-semibold">
                Status: <span class="{% if order.status.name == 'Pending' %}text-yellow-500{% elif order.status.name == 'Processing' %}text-blue-500{% elif order.status.name == 'Shipped' %}text-indigo-500{% elif order.status.name == 'Delivered' %}text-green-500{% elif order.status.name == 'Cancelled' %}text-red-500{% else %}text-gray-500{% endif %}" x-text="orderStatus"></span>
            </div>
            <div x-show="canCancelOrder">
                <button @click="confirmCancelOrder" class="mt-4 sm:mt-0 px-6 py-2 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 transform hover:scale-105">
                    Cancel Order
                </button>
            </div>
        </div>

        <!-- Order Details Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
                <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">Order Information</h2>
                <p class="text-gray-700 dark:text-gray-300"><strong>Order Date:</strong> {{ order.created_at|date:"F j, Y, P" }}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>Payment Method:</strong> {{ order.payment.method.name }}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>Payment Status:</strong> {{ order.payment.status }}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>Shipping Method:</strong> {{ order.shipping_method_name }}</p>
                {% if order.tracking_number %}
                    <p class="text-gray-700 dark:text-gray-300"><strong>Tracking Number:</strong> <a href="{{ order.tracking_link }}" target="_blank" class="text-blue-600 hover:underline">{{ order.tracking_number }} <i class="fas fa-external-link-alt text-xs"></i></a></p>
                {% endif %}
                {% if order.order_note %}
                    <p class="text-gray-700 dark:text-gray-300"><strong>Order Note:</strong> {{ order.order_note }}</p>
                {% endif %}
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">Shipping Address</h2>
                <p class="text-gray-700 dark:text-gray-300">{{ order.address.full_name }}</p>
                <p class="text-gray-700 dark:text-gray-300">{{ order.address.address_line_1 }}</p>
                {% if order.address.address_line_2 %}
                    <p class="text-gray-700 dark:text-gray-300">{{ order.address.upazila }}</p>
                {% endif %}
                <p class="text-gray-700 dark:text-gray-300">{{ order.address.city }}, {{ order.address.state }} {{ order.address.postal_code }}</p>
                <p class="text-gray-700 dark:text-gray-300">{{ order.address.country }}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>Phone:</strong> {{ order.address.phone_number }}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>Email:</strong> {{ order.user.email }}</p>
            </div>
        </div>

        <!-- Order Items -->
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">Order Items</h2>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner mb-8">
            {% for item in order.items.all %}
            <div class="flex items-center py-4 px-6 {% if not forloop.last %}border-b border-gray-200 dark:border-gray-600{% endif %}">
                <div class="flex-shrink-0 w-20 h-20 overflow-hidden rounded-md border border-gray-200">
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-center object-cover">
                    {% else %}
                        <img src="{% static 'images/default-product.png' %}" alt="Default Product Image" class="w-full h-full object-center object-cover">
                    {% endif %}
                </div>
                <div class="ml-4 flex-grow">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">{{ item.product_name }}</h3>
                    <p class="text-gray-700 dark:text-gray-300">Quantity: {{ item.quantity }}</p>
                    <p class="text-gray-700 dark:text-gray-300">Price: ৳{{ item.price|floatformat:2 }}</p>
                    {% if item.discount > 0 %}
                        <p class="text-gray-700 dark:text-gray-300">Discount: ৳{{ item.discount|floatformat:2 }}</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Order Totals -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Order Totals</h2>
            <div class="space-y-2 text-left">
                <p class="flex justify-between text-gray-700 dark:text-gray-300">
                    <span>Subtotal:</span>
                    <span>৳{{ order.total|floatformat:2 }}</span>
                </p>
                <p class="flex justify-between text-gray-700 dark:text-gray-300">
                    <span>Shipping:</span>
                    <span>৳{{ order.delivery_charge|floatformat:2 }}</span>
                </p>
                <p class="flex justify-between text-gray-700 dark:text-gray-300">
                    <span>VAT:</span>
                    <span>৳{{ order.tax|floatformat:2 }}</span>
                </p>
                {% if order.discount > 0 %}
                    <p class="flex justify-between text-gray-700 dark:text-gray-300">
                        <span>Discount:</span>
                        <span class="text-red-500">-৳{{ order.discount|floatformat:2 }}</span>
                    </p>
                {% endif %}
                <div class="border-t border-gray-300 dark:border-gray-600 pt-2 mt-2">
                    <p class="flex justify-between text-xl font-bold text-gray-900 dark:text-gray-100">
                        <span>Grand Total:</span>
                        <span>৳{{ order.grand_total|floatformat:2 }}</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Back to Orders Button -->
        <div class="mt-8 text-center">
            <a href="{% url 'orders:order_list' %}"
               class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 dark:border-gray-600 text-base font-medium rounded-full shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 transform hover:scale-105">
                <i class="fas fa-arrow-left mr-2"></i> Back to My Orders
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('orderDetailApp', () => ({
            orderId: null,
            orderStatus: '',
            canCancelOrder: false,

            init(orderId, canCancel) {
                this.orderId = orderId;
                // Initialize orderStatus from the Django context
                this.orderStatus = '{{ order.status.name }}';
                // Convert Django's boolean string to JS boolean
                this.canCancelOrder = (canCancel === 'True');
            },

            confirmCancelOrder() {
                if (confirm('Are you sure you want to cancel this order? This action cannot be undone.')) {
                    this.cancelOrder();
                }
            },

            async cancelOrder() {
                try {
                    const response = await fetch(`/orders/${this.orderId}/cancel/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').content,
                        },
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(data.message);
                        this.orderStatus = data.new_status; // Update status on UI
                        this.canCancelOrder = false; // Disable cancel button
                    } else {
                        alert(data.message || 'Failed to cancel order.');
                    }
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    alert('An error occurred while trying to cancel the order.');
                }
            },
        }));
    });
</script>
{% endblock %}
