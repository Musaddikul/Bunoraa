<div x-show="activeStep === 0" x-transition class="bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden">
  <div class="p-6 border-b border-gray-200 dark:border-gray-700">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Shipping Information</h2>
  </div>
  <form class="p-6 space-y-6" @submit.prevent="nextStep" novalidate>

    <!-- Your Saved Addresses -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Your Saved Addresses</h3>
      <p x-show="validationErrors.addressSelection" class="text-red-600 text-sm" x-text="validationErrors.addressSelection"></p>

      <div x-show="userAddresses.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <template x-for="address in userAddresses" :key="address.id">
          <label :for="`address-${address.id}`"
                 class="flex items-center p-4 border rounded-lg cursor-pointer"
                 :class="{'border-blue-500 ring-2 ring-blue-200': selectedShippingAddress === address.id, 'border-gray-300 dark:border-gray-600': selectedShippingAddress !== address.id}">
            <input type="radio" :id="`address-${address.id}`" :value="address.id" x-model="selectedShippingAddress" @change="selectAddress(address)" class="form-radio h-4 w-4 text-blue-600 transition duration-150 ease-in-out">
            <div class="ml-3 text-sm">
              <p class="font-medium text-gray-900 dark:text-white" x-text="address.full_name"></p>
              <p class="text-gray-600 dark:text-gray-400" x-text="address.address_line_1"></p>
              <p class="text-gray-600 dark:text-gray-400" x-text="`${address.upazila}, ${address.city}, ${address.state}`"></p>
              <p class="text-gray-600 dark:text-gray-400" x-text="address.postal_code"></p>
              <p class="text-gray-600 dark:text-gray-400" x-text="address.phone_number"></p>
            </div>
          </label>
        </template>
      </div>

      <div class="mt-4">
        <label for="new-address-toggle" class="flex items-center cursor-pointer">
          <input type="checkbox" id="new-address-toggle" x-model="showNewAddressForm" class="form-checkbox h-5 w-5 text-blue-600">
          <span class="ml-2 text-gray-700 dark:text-gray-300">Add a New Address</span>
        </label>
      </div>
    </div>

    <!-- New Address Form (conditionally displayed) -->
    <div x-show="showNewAddressForm || userAddresses.length === 0" x-transition class="space-y-6 border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">New Address Details</h3>
      <!-- Name & Phone -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <input
            type="text"
            x-model="shippingInfo.full_name"
            placeholder="Full Name"
            :required="showNewAddressForm || userAddresses.length === 0"
            class="input"
          />
          <p x-show="validationErrors.full_name" class="text-red-600 text-sm" x-text="validationErrors.full_name"></p>
        </div>
        <div>
          <input
            type="tel"
            x-model="shippingInfo.phone"
            placeholder="Phone Number"
            :required="showNewAddressForm || userAddresses.length === 0"
            class="input"
          />
          <p x-show="validationErrors.phone" class="text-red-600 text-sm" x-text="validationErrors.phone"></p>
        </div>
      </div>

      <!-- Email -->
      <div>
        <input
          type="email"
          x-model="shippingInfo.email"
          placeholder="Email Address"
          :required="showNewAddressForm || userAddresses.length === 0"
          class="input"
        />
        <p x-show="validationErrors.email" class="text-red-600 text-sm" x-text="validationErrors.email"></p>
      </div>

      <!-- Address -->
      <div>
        <input
          id="autocomplete"
          type="text"
          x-model="shippingInfo.address"
          placeholder="Complete Address"
          :required="showNewAddressForm || userAddresses.length === 0"
          class="input"
        />
        <p x-show="validationErrors.address" class="text-red-600 text-sm" x-text="validationErrors.address"></p>
      </div>

      <!-- Division & Country -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <select
            x-model="shippingInfo.division"
            :required="showNewAddressForm || userAddresses.length === 0"
            class="input"
          >
            <option value="" disabled selected>Select Division</option>
            <template x-for="division in availableDivisions" :key="division">
              <option :value="division" x-text="division"></option>
            </template>
          </select>
          <p x-show="validationErrors.division" class="text-red-600 text-sm" x-text="validationErrors.division"></p>
        </div>

        <div>
          <select
            x-model="shippingInfo.country"
            :required="showNewAddressForm || userAddresses.length === 0"
            class="input bg-gray-100 dark:bg-gray-700 cursor-not-allowed"
            disabled
          >
            <option value="Bangladesh">Bangladesh</option>
          </select>
        </div>
      </div>

      <!-- District & Thana -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <select
            x-model="shippingInfo.district"
            :disabled="!shippingInfo.division"
            :required="showNewAddressForm || userAddresses.length === 0"
            class="input"
          >
            <option value="" disabled selected>Select District</option>
            <template x-for="district in availableDistricts" :key="district">
              <option :value="district" x-text="district"></option>
            </template>
          </select>
          <p x-show="validationErrors.district" class="text-red-600 text-sm" x-text="validationErrors.district"></p>
        </div>

        <div>
          <select
            x-model="shippingInfo.thana"
            :disabled="!shippingInfo.district"
            :required="showNewAddressForm || userAddresses.length === 0"
            class="input"
          >
            <option value="" disabled selected>Select Thana/Upazila</option>
            <template x-for="upazila in availableUpazilas" :key="upazila">
              <option :value="upazila" x-text="upazila"></option>
            </template>
          </select>
          <p x-show="validationErrors.thana" class="text-red-600 text-sm" x-text="validationErrors.thana"></p>
        </div>
      </div>

      <!-- Postal Code -->
      <div>
        <input
          type="text"
          x-model="shippingInfo.postal_code"
          placeholder="Postal Code"
          :required="showNewAddressForm || userAddresses.length === 0"
          class="input"
        />
        <p x-show="validationErrors.postal_code" class="text-red-600 text-sm" x-text="validationErrors.postal_code"></p>
      </div>
    </div>

    <!-- Shipping Methods -->
    <div class="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Shipping Methods</h3>
      <p x-show="validationErrors.shippingMethod" class="text-red-600 text-sm" x-text="validationErrors.shippingMethod"></p>

      <div x-show="shippingMethods.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <template x-for="method in shippingMethods" :key="method.id">
          <label :for="`shipping-method-${method.id}`"
                 class="flex items-center p-4 border rounded-lg cursor-pointer"
                 :class="{'border-blue-500 ring-2 ring-blue-200': selectedShippingMethod === method.id, 'border-gray-300 dark:border-gray-600': selectedShippingMethod !== method.id}">
            <input type="radio" :id="`shipping-method-${method.id}`" :value="method.id" x-model="selectedShippingMethod" @change="updateShippingCost(method.base_charge)" class="form-radio h-4 w-4 text-blue-600 transition duration-150 ease-in-out" :checked="Number(selectedShippingMethod) === Number(method.id)">
            <div class="ml-3 text-sm">
              <p class="font-medium text-gray-900 dark:text-white" x-text="method.name"></p>
              <p class="text-gray-600 dark:text-gray-400" x-text="method.estimated_delivery_days ? `Est. Delivery: ${method.estimated_delivery_days}` : 'No estimated delivery'"></p>
              <p class="text-gray-600 dark:text-gray-400">Cost: à§³<span x-text="parseFloat(method.base_charge).toFixed(2)"></span></p>
            </div>
          </label>
        </template>
      </div>
      <p x-show="shippingMethods.length === 0" class="text-gray-600 dark:text-gray-400">No shipping methods available for your selected address.</p>
    </div>

    <!-- Continue Button -->
    <button
      type="submit"
      class="w-full py-3 px-6 text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all duration-200"
    >
      Continue to Payment
    </button>
  </form>
</div>