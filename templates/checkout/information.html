{% extends 'base.html' %}
{% load static %}

{% block page_id %}checkout{% endblock %}
{% block title %}Contact Information - Checkout | {{ SITE_NAME }}{% endblock %}

{% block content %}
{% with checkout_session as checkout %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <div class="container mx-auto px-4 py-8">
        
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-primary-600 text-white flex items-center justify-center font-semibold">1</div>
                    <span class="ml-2 font-medium text-gray-900 dark:text-white">Information</span>
                </div>
                <div class="w-12 md:w-16 h-0.5 mx-2 md:mx-4 bg-gray-300 dark:bg-gray-700"></div>
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-600 dark:text-gray-400 flex items-center justify-center font-semibold">2</div>
                    <span class="ml-2 text-gray-500 dark:text-gray-400 hidden md:inline">Shipping</span>
                </div>
                <div class="w-12 md:w-16 h-0.5 mx-2 md:mx-4 bg-gray-300 dark:bg-gray-700"></div>
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-600 dark:text-gray-400 flex items-center justify-center font-semibold">3</div>
                    <span class="ml-2 text-gray-500 dark:text-gray-400 hidden md:inline">Payment</span>
                </div>
                <div class="w-12 md:w-16 h-0.5 mx-2 md:mx-4 bg-gray-300 dark:bg-gray-700"></div>
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-600 dark:text-gray-400 flex items-center justify-center font-semibold">4</div>
                    <span class="ml-2 text-gray-500 dark:text-gray-400 hidden md:inline">Review</span>
                </div>
            </div>
        </div>
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Contact & Address Form -->
            <div class="flex-1">
                <form id="information-form" method="POST" action="{% url 'commerce:checkout_info' %}" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Contact Information -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Contact Information
                        </h2>
                        
                        {% if not user.is_authenticated %}
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Already have an account? <a href="{% url 'accounts:login' %}?next={% url 'commerce:checkout' %}" class="text-primary-600 hover:text-primary-700 font-medium">Log in</a>
                        </p>
                        {% endif %}
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email *</label>
                                <input type="email" name="email" id="email" 
                                       value="{{ checkout.email|default:checkout.shipping_email|default:user.email|default:'' }}" required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                       placeholder="your@email.com">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">We'll send your receipt and order updates here.</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone *</label>
                                <input type="tel" name="phone" id="phone" 
                                       value="{{ checkout.shipping_phone|default:'' }}" required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                       placeholder="+880 1XXX-XXXXXX">
                            </div>
                            
                            <div class="flex items-end">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="subscribe_newsletter" id="subscribe_newsletter" 
                                           {% if checkout.subscribe_newsletter %}checked{% endif %}
                                           class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">Email me with news and offers</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Shipping Address
                        </h2>
                        
                        {% if user.is_authenticated and saved_addresses %}
                        <!-- Saved Addresses -->
                        <div class="mb-6" id="saved-addresses">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Select a saved address</label>
                            <div class="grid md:grid-cols-2 gap-4">
                                {% for address in saved_addresses %}
                                <div class="relative">
                                    <input type="radio" name="saved_address" value="{{ address.id }}" id="address-{{ address.id }}"
                                           class="peer sr-only" {% if address.is_default %}checked{% endif %}
                                           data-full-name="{{ address.full_name }}"
                                           data-address-line1="{{ address.address_line_1 }}"
                                           data-address-line2="{{ address.address_line_2 }}"
                                           data-city="{{ address.city }}"
                                           data-state="{{ address.state }}"
                                           data-postal-code="{{ address.postal_code }}"
                                           data-country="{{ address.country }}"
                                           data-phone="{{ address.phone }}">
                                    <label for="address-{{ address.id }}" 
                                           class="block p-4 border-2 rounded-xl cursor-pointer transition-all peer-checked:border-primary-600 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20 hover:border-gray-400 dark:hover:border-gray-500 border-gray-200 dark:border-gray-700">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-gray-900 dark:text-white">{{ address.full_name }}</p>
                                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ address.address_line_1 }}</p>
                                                {% if address.address_line_2 %}
                                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ address.address_line_2 }}</p>
                                                {% endif %}
                                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ address.country_name|default:address.country }}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">{{ address.phone }}</p>
                                            </div>
                                            {% if address.is_default %}
                                            <span class="text-xs bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 px-2 py-1 rounded-full">Default</span>
                                            {% endif %}
                                        </div>
                                    </label>
                                    <div class="absolute top-3 right-3 hidden peer-checked:flex">
                                        <svg class="w-5 h-5 text-primary-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="relative">
                                    <input type="radio" name="saved_address" value="new" id="address-new" class="peer sr-only">
                                    <label for="address-new" 
                                           class="block p-4 border-2 border-dashed rounded-xl cursor-pointer transition-all peer-checked:border-primary-600 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20 hover:border-gray-400 dark:hover:border-gray-500 border-gray-300 dark:border-gray-600 h-full min-h-[120px] flex items-center justify-center">
                                        <div class="text-center">
                                            <svg class="w-8 h-8 text-gray-400 dark:text-stone-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            <span class="text-gray-600 dark:text-gray-400 font-medium">Add new address</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- New Address Form -->
                        <div id="new-address-form" class="{% if user.is_authenticated and saved_addresses %}hidden{% endif %}">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name *</label>
                                    <input type="text" name="full_name" id="full_name" required
                                           value="{% if checkout.shipping_first_name %}{{ checkout.shipping_first_name }} {{ checkout.shipping_last_name }}{% endif %}" 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                           placeholder="Enter your full name">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address Line 1 *</label>
                                    <input type="text" name="address_line1" id="address_line1" required
                                           value="{{ checkout.shipping_address_line_1|default:'' }}" 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                           placeholder="House number, street name">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address Line 2</label>
                                    <input type="text" name="address_line2" id="address_line2" 
                                           value="{{ checkout.shipping_address_line_2|default:'' }}"
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                           placeholder="Apartment, suite, unit, building, floor (optional)">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City *</label>
                                    <input type="text" name="city" id="city" 
                                           value="{{ checkout.shipping_city|default:'' }}" 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                           placeholder="City">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Division/State *</label>
                                    <input type="text" name="state" id="state" 
                                           value="{{ checkout.shipping_state|default:'' }}" 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                           placeholder="Division or State">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Postal Code *</label>
                                    <input type="text" name="postal_code" id="postal_code" 
                                           value="{{ checkout.shipping_postal_code|default:'' }}" 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                           placeholder="Postal code">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Country *</label>
                                    <select name="country" id="country" 
                                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                        <option value="">Select a country</option>
                                        <option value="BD" {% if checkout.shipping_country == 'BD' or not checkout.shipping_country %}selected{% endif %}>Bangladesh</option>
                                        {% for country in countries %}
                                        <option value="{{ country.code }}" {% if checkout.shipping_country == country.code %}selected{% endif %}>
                                            {{ country.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            {% if user.is_authenticated %}
                            <div class="mt-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="save_address" value="true"
                                           class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">Save this address for future orders</span>
                                </label>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Gift Options -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between cursor-pointer" onclick="toggleGiftOptions()">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                                <svg class="w-6 h-6 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                </svg>
                                Gift Options
                            </h2>
                            <svg id="gift-toggle-icon" class="w-5 h-5 text-gray-400 dark:text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        
                        <div id="gift-options-content" class="hidden mt-4 space-y-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="is_gift" id="is_gift" 
                                       {% if checkout.is_gift or cart_summary.gift_wrap_cost|default:0|floatformat:2 != '0.00' %}checked{% endif %}
                                       class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                                <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">This order is a gift</span>
                            </label>
                            
                            <div id="gift-details" class="{% if not checkout.is_gift and cart_summary.gift_wrap_cost|default:0|floatformat:2 == '0.00' %}hidden{% endif %} space-y-4 pl-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gift Message (optional)</label>
                                    <textarea name="gift_message" id="gift_message" rows="3"
                                              maxlength="200"
                                              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition"
                                              placeholder="Add a personal message (max 200 characters)">{{ checkout.gift_message|default:'' }}</textarea>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"><span id="gift-message-count">0</span>/200 characters</p>
                                </div>
                                
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="gift_wrap" id="gift_wrap" 
                                           {% if checkout.gift_wrap or cart_summary.gift_wrap_cost|default:0|floatformat:2 != '0.00' %}checked{% endif %}
                                           class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">Add gift wrapping {% if cart_summary.formatted_gift_wrap_amount %}(+{{ cart_summary.formatted_gift_wrap_amount }}){% endif %}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="mt-8 flex flex-col md:flex-row justify-between items-center gap-3">
                        <a href="{% url 'commerce:cart' %}" class="w-full md:w-auto text-center md:text-left flex items-center text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            <span class="ml-2">Back to Cart</span>
                        </a>
                        <button type="submit" id="continue-btn" 
                                class="w-full md:w-auto block md:inline-flex items-center justify-center bg-primary-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-primary-700 transition-colors shadow-lg shadow-primary-600/25 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="btn-text">Continue to Shipping</span>
                            <span id="btn-spinner" class="hidden ml-2">
                                <svg class="animate-spin w-5 h-5" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                            <svg class="w-5 h-5 ml-2" id="arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Order Summary Sidebar -->
            <div class="lg:w-96">
                <button id="order-summary-toggle" aria-expanded="false" class="w-full md:hidden mb-4 inline-flex items-center justify-between px-4 py-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-stone-700">
                    <span class="font-medium">Order Summary</span>
                    <span class="text-sm text-gray-500 dark:text-gray-400" data-order-items-count>{{ cart_items|length }} items</span>
                    <svg class="w-5 h-5 text-gray-500 dark:text-stone-400 transform transition-transform" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"></path></svg>
                </button>
                <div id="order-summary-block" class="hidden md:block bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 lg:sticky lg:top-24">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center justify-between">
                        <span>Order Summary</span>
                        <span class="text-sm font-normal text-gray-500 dark:text-gray-400" data-order-items-count>{{ cart_items|length }} items</span>
                    </h2>
                    
                    <div id="order-summary"
                         data-tax-rate="{{ cart_summary.tax_rate|default:tax_rate|default:0 }}"
                         data-gift-wrap-cost="{{ cart_summary.gift_wrap_cost|default:0 }}"
                         data-gift-wrap-amount="{{ cart_summary.gift_wrap_amount|default:0 }}">
                        <div data-order-items>
                            <!-- Cart Items (use converted summary items) -->
                            <div class="space-y-4 max-h-80 overflow-y-auto scrollbar-thin pr-2">
                                {% for it in cart_summary.items %}
                                <div class="flex items-start space-x-4 py-3 {% if not forloop.last %}border-b border-gray-100 dark:border-gray-700{% endif %}">
                                    <div class="relative flex-shrink-0">
                                        <img src="{{ it.image|default:'/static/images/placeholder.svg' }}" loading="lazy" decoding="async"
                                             alt="{{ it.product_name }}"
                                             class="w-16 h-16 object-cover rounded-lg">
                                        <span class="absolute -top-2 -right-2 w-5 h-5 bg-gray-600 text-white text-xs rounded-full flex items-center justify-center font-medium">
                                            {{ it.quantity }}
                                        </span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ it.product_name }}</p>
                                        {% if it.variant_name %}
                                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ it.variant_name }}</p>
                                        {% endif %}
                                        {% if it.original_total %}
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-sm font-medium text-primary-600">{{ it.formatted_total|default:it.total }}</span>
                                            <span class="text-xs text-gray-400 dark:text-stone-500 line-through">{{ cart_summary.currency.symbol|default:currency_symbol }}{{ it.original_total|default:'' }}</span>
                                        </div>
                                        {% else %}
                                        <p class="text-sm font-medium text-gray-900 dark:text-white mt-1">{{ it.formatted_total|default:it.total }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-gray-500 dark:text-gray-400 text-center py-4">Your cart is empty</p>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Coupon Code -->
                        <div class="border-t border-gray-200 dark:border-gray-700 mt-4 pt-4">
                            <div id="coupon-form" class="flex space-x-2 {% if cart_summary.coupon_code %}hidden{% endif %}">
                                <input type="text" id="coupon-code" placeholder="Coupon code" 
                                       value="{{ checkout.coupon_code|default:'' }}"
                                       class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition">
                                <button type="button" id="apply-coupon-btn" 
                                        class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium text-sm transition">
                                    Apply
                                </button>
                            </div>
                            <div id="coupon-applied" class="{% if not cart_summary.coupon_code %}hidden{% endif %}">
                                <div class="flex items-center justify-between bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-2 rounded-lg text-sm">
                                    <span>Coupon Applied: <span id="coupon-name">{{ cart_summary.coupon_code }}</span></span>
                                    <button type="button" id="remove-coupon-btn" class="text-green-700 dark:text-green-300 hover:text-green-900 dark:hover:text-green-100">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <p id="coupon-message" class="text-sm mt-2 hidden"></p>
                        </div>
                        
                        {% include 'checkout/includes/order_summary.html' %}
                    </div>
                    
                    <!-- Trust Badges -->
                    <div class="mt-6 space-y-3">
                        <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                            <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            Secure 256-bit SSL Encryption
                        </div>
                        <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                            <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            Multiple Payment Options
                        </div>
                        <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                            <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            7-Day Easy Returns
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endwith %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle new address form based on saved address selection
    const savedAddressInputs = document.querySelectorAll('input[name="saved_address"]');
    const newAddressForm = document.getElementById('new-address-form');
    const formFields = ['full_name', 'address_line1', 'address_line2', 'city', 'state', 'postal_code', 'country'];
    
    function applySavedAddress(input) {
        if (!input) return;
        if (input.value === 'new') {
            newAddressForm.classList.remove('hidden');
            formFields.forEach(field => {
                const el = document.getElementById(field);
                if (el) el.value = '';
            });
        } else {
            newAddressForm.classList.add('hidden');
            // Populate fields from selected address data attributes
            document.getElementById('full_name').value = input.dataset.fullName || '';
            document.getElementById('address_line1').value = input.dataset.addressLine1 || '';
            document.getElementById('address_line2').value = input.dataset.addressLine2 || '';
            document.getElementById('city').value = input.dataset.city || '';
            document.getElementById('state').value = input.dataset.state || '';
            document.getElementById('postal_code').value = input.dataset.postalCode || '';
            document.getElementById('country').value = input.dataset.country || '';
        }
    }

    savedAddressInputs.forEach(input => {
        input.addEventListener('change', function() {
            applySavedAddress(this);
        });
    });

    // Populate default saved address on load (if any)
    const checkedSaved = document.querySelector('input[name="saved_address"]:checked');
    if (checkedSaved) {
        applySavedAddress(checkedSaved);
    }
    
    // Gift options toggle
    window.toggleGiftOptions = function() {
        const content = document.getElementById('gift-options-content');
        const icon = document.getElementById('gift-toggle-icon');
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    };
    
    // Is gift checkbox toggle
    const isGiftCheckbox = document.getElementById('is_gift');
    const giftDetails = document.getElementById('gift-details');
    
    if (isGiftCheckbox) {
        isGiftCheckbox.addEventListener('change', function() {
            giftDetails.classList.toggle('hidden', !this.checked);
        });
    }
    
    // Gift message character count
    const giftMessage = document.getElementById('gift_message');
    const giftMessageCount = document.getElementById('gift-message-count');
    
    if (giftMessage && giftMessageCount) {
        giftMessage.addEventListener('input', function() {
            giftMessageCount.textContent = this.value.length;
        });
        giftMessageCount.textContent = giftMessage.value.length;
    }
    
    // Gift wrapping cost update
    const giftWrapCheckbox = document.getElementById('gift_wrap');
    function getGiftWrapMeta() {
        const row = document.getElementById('gift-wrap-row');
        const costEl = document.getElementById('gift-wrap-cost');
        const cost = parseFloat(costEl?.dataset.price || 0);
        const summaryEl = document.getElementById('order-summary');
        const amount = parseFloat(summaryEl?.dataset.giftWrapAmount || 0);
        return { row, costEl, cost, amount };
    }
    
    if (giftWrapCheckbox) {
        const { cost: giftWrapCost, amount: giftWrapAmount } = getGiftWrapMeta();
        if (giftWrapCost > 0 || giftWrapAmount > 0) {
            if (!giftWrapCheckbox.checked) {
                giftWrapCheckbox.checked = true;
            }
            if (isGiftCheckbox && !isGiftCheckbox.checked) {
                isGiftCheckbox.checked = true;
            }
            giftDetails?.classList.remove('hidden');
        }
        // Show/hide gift wrap row based on checkbox
        function updateGiftWrapVisibility() {
            const { row, costEl, cost, amount } = getGiftWrapMeta();
            if (!row) return;

            if (giftWrapCheckbox.checked) {
                row.style.display = 'flex';
                const nextCost = (cost > 0 ? cost : amount);
                if (costEl) {
                    costEl.dataset.price = String(nextCost || 0);
                    costEl.textContent = `+${Templates.formatPrice(nextCost || 0)}`;
                }
            } else {
                row.style.display = 'none';
                if (costEl) {
                    costEl.dataset.price = '0';
                    costEl.textContent = `+${Templates.formatPrice(0)}`;
                }
            }
        }
        
        // Initialize on page load
        updateGiftWrapVisibility();
        
        // Listen for checkbox changes
        giftWrapCheckbox.addEventListener('change', function() {
            updateGiftWrapVisibility();
            updateOrderSummary();
        });
    }
    
    function updateOrderSummary() {
        const subtotal = parseFloat(document.getElementById('subtotal')?.dataset.price || 0);
        const discount = parseFloat(document.getElementById('discount-amount')?.dataset.price || 0);
        const shipping = parseFloat(document.getElementById('shipping-cost')?.dataset.price || 0);
        const taxRate = parseFloat(document.querySelector('[data-tax-rate]')?.dataset.taxRate || 0);
        const giftMeta = getGiftWrapMeta();
        const giftWrapCost = giftMeta.cost;
        const giftWrapAmount = giftMeta.amount;
        const giftWrapValue = (giftWrapCheckbox?.checked ? (giftWrapCost > 0 ? giftWrapCost : giftWrapAmount) : 0);
        
        const taxable = Math.max(0, subtotal - discount);
        const tax = taxRate > 0 ? (taxable * taxRate / 100) : 0;
        const total = taxable + shipping + giftWrapValue + tax;
        
        const totalEl = document.getElementById('order-total');
        if (totalEl) {
            totalEl.textContent = Templates.formatPrice(total);
            totalEl.dataset.price = total;
        }
    }
    
    // Apply/remove coupon (Promotions API)
    const couponInput = document.getElementById('coupon-code');
    const couponForm = document.getElementById('coupon-form');
    const applyBtn = document.getElementById('apply-coupon-btn');
    const couponMessage = document.getElementById('coupon-message');
    const appliedBlock = document.getElementById('coupon-applied');
    const couponName = document.getElementById('coupon-name');
    const removeBtn = document.getElementById('remove-coupon-btn');
    const taxRate = parseFloat('{{ cart_summary.tax_rate|default:tax_rate }}') || 0;
    const getShippingCost = () => parseFloat(document.getElementById('shipping-cost')?.dataset.price || 0);
    
    function showCouponMessage(message, type) {
        if (!couponMessage) return;
        couponMessage.textContent = message;
        couponMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
        couponMessage.classList.add(type === 'success' ? 'text-green-600' : 'text-red-600');
    }

    function toggleCouponApplied(code) {
        if (couponName) couponName.textContent = code || '';
        if (couponForm) couponForm.classList.toggle('hidden', !!code);
        if (appliedBlock) appliedBlock.classList.toggle('hidden', !code);
    }

    function updateOrderSummaryFromCart(cart) {
        if (!cart) return;
        const subtotal = parseFloat(cart.subtotal || 0) || 0;
        const discount = parseFloat(cart.discount_amount || 0) || 0;
        const giftMeta = getGiftWrapMeta();
        const giftWrapCost = giftMeta.cost;
        const giftWrapAmount = giftMeta.amount;
        const giftWrapValue = (giftWrapCheckbox?.checked ? (giftWrapCost > 0 ? giftWrapCost : giftWrapAmount) : 0);
        const taxable = Math.max(0, subtotal - discount);
        const tax = taxRate > 0 ? (taxable * taxRate / 100) : 0;
        const shippingCost = getShippingCost();
        const total = taxable + shippingCost + giftWrapValue + tax;

        const subtotalEl = document.getElementById('subtotal');
        const discountRow = document.getElementById('discount-row');
        const discountEl = document.getElementById('discount-amount');
        const taxEl = document.getElementById('tax-amount');
        const totalEl = document.getElementById('order-total');

        if (subtotalEl) subtotalEl.textContent = Templates.formatPrice(subtotal);
        if (discountRow && discountEl) {
            if (discount > 0) {
                discountRow.classList.remove('hidden');
                discountEl.textContent = '-' + Templates.formatPrice(discount);
            } else {
                discountRow.classList.add('hidden');
            }
        }
        // Preserve gift wrap row visibility
        const { row, costEl, amount } = getGiftWrapMeta();
        if (row && giftWrapCheckbox) {
            if (giftWrapCheckbox.checked || giftWrapCost > 0 || amount > 0) {
                row.style.display = 'flex';
                if (giftWrapCheckbox.checked && amount > 0 && giftWrapCost <= 0 && costEl) {
                    costEl.dataset.price = String(amount);
                    costEl.textContent = `+${Templates.formatPrice(amount)}`;
                }
            } else {
                row.style.display = 'none';
            }
        }
        if (taxEl) taxEl.textContent = Templates.formatPrice(tax);
        if (totalEl) totalEl.textContent = Templates.formatPrice(total);
    }
    
    if (applyBtn) {
        applyBtn.addEventListener('click', async function() {
            const code = couponInput?.value.trim();
            if (!code) {
                showCouponMessage('Please enter a coupon code', 'error');
                return;
            }
            
            applyBtn.disabled = true;
            applyBtn.textContent = 'Applying...';
            
            try {
                const response = await fetch('/api/v1/promotions/coupons/apply/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ code })
                });
                
                const data = await response.json();
                console.log('Coupon apply response:', { status: response.status, ok: response.ok, data });
                
                if (response.ok && data.success) {
                    showCouponMessage(data.message || 'Coupon applied', 'success');
                    const appliedCode = data.cart?.coupon_code || code;
                    toggleCouponApplied(appliedCode);
                    updateOrderSummaryFromCart(data.cart);
                } else {
                    const errorMessage = data.message || data.error || 'Failed to apply coupon';
                    console.error('Coupon apply error:', { response, data, errorMessage });
                    showCouponMessage(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Coupon apply request failed:', error);
                showCouponMessage('Failed to apply coupon (network error)', 'error');
            } finally {
                applyBtn.disabled = false;
                applyBtn.textContent = 'Apply';
            }
        });
    }

    if (removeBtn) {
        removeBtn.addEventListener('click', async function() {
            removeBtn.disabled = true;
            try {
                const response = await fetch('/api/v1/commerce/cart/remove_coupon/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    showCouponMessage('Coupon removed', 'success');
                    toggleCouponApplied('');
                    updateOrderSummaryFromCart(data.cart);
                } else {
                    showCouponMessage(data.message || 'Failed to remove coupon', 'error');
                }
            } catch (error) {
                showCouponMessage('Failed to remove coupon', 'error');
            } finally {
                removeBtn.disabled = false;
            }
        });
    }
    
    // Form submission handling
    const form = document.getElementById('information-form');
    const continueBtn = document.getElementById('continue-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const arrowIcon = document.getElementById('arrow-icon');
    
    form.addEventListener('submit', function() {
        continueBtn.disabled = true;
        btnText.textContent = 'Processing...';
        btnSpinner.classList.remove('hidden');
        arrowIcon.classList.add('hidden');
    });
});
</script>
{% endblock %}
