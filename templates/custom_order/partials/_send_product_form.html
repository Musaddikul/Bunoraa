<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 fade-in" 
     x-show="currentStep === 2 && orderType === 'SEND_PRODUCT'"
     x-transition
     id="send-product-form"> {# Added ID for JavaScript to target #}
    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Product Details</h2>
    
    {# IMPORTANT: Render the management form for the item_formset #}
    {{ item_formset.management_form }}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div>
            <!-- Category Selection -->
            <div class="mb-4">
                <label for="product-category" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Product Category</label>
                <select id="product-category" name="category"
                        x-model="formData.category"
                        @change="loadSubcategories($event.target.value)"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-gray-700 dark:text-gray-300 bg-gray-300 dark:bg-gray-700 border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                        required>
                    <option value="">Select a category</option>
                    <template x-for="category in categories" :key="category.id">
                        <option :value="category.id" x-text="category.name"></option>
                    </template>
                </select>
            </div>

            <!-- Subcategory Selection -->
            <div class="mb-4">
                <label for="product-subcategory" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Product Subcategory</label>
                <select id="product-subcategory" name="subcategory"
                        x-model="formData.subcategory"
                        @change="calculatePrice()" {# Trigger calculatePrice on subcategory change #}
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-gray-700 dark:text-gray-300 bg-gray-300 dark:bg-gray-700 border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                        required>
                    <option value="">Select a subcategory</option>
                    <template x-for="subcategory in subcategories" :key="subcategory.id">
                        <option :value="subcategory.id" x-text="subcategory.name"></option>
                    </template>
                </select>
            </div>

            <!-- Fabric Type Selection -->
            <div class="mb-4">
                <label for="product-fabric-type" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Fabric Type</label>
                <select id="product-fabric-type" name="fabric_type"
                        x-model="formData.fabric_type"
                        @change="loadColors($event.target.value); calculatePrice()" {# Trigger loadColors and calculatePrice on fabric type change #}
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-gray-700 dark:text-gray-300 bg-gray-300 dark:bg-gray-700 border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                        required>
                    <option value="">Select a fabric type</option>
                    <template x-for="fabric in fabrics" :key="fabric.id">
                        <option :value="fabric.id" x-text="fabric.name"></option>
                    </template>
                </select>
            </div>
        </div>

        <!-- Right Column -->
        <div>
            <!-- Quantity -->
            <div class="mb-4">
                <label for="product-quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Quantity</label>
                <input type="number" id="product-quantity" name="quantity"
                       x-model.number="formData.quantity"
                       @input="calculatePrice()" {# Trigger calculatePrice on quantity change #}
                       min="1"
                       class="mt-1 block w-full text-gray-700 dark:text-gray-300 bg-gray-300 dark:bg-gray-700 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- Customer Item Description -->
            <div class="mb-4">
                <label for="customer-item-description" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Product Description</label>
                <textarea id="customer-item-description" name="customer_item_description" rows="4"
                          x-model="formData.customer_item_description"
                          class="mt-1 block w-full text-gray-700 dark:text-gray-300 bg-gray-300 dark:bg-gray-700 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                          placeholder="Describe the product you are sending..."
                          required></textarea>
            </div>

            <!-- Product Condition -->
            <div class="mb-6">
                <label for="product-condition" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Product Condition</label>
                <input type="text" id="product-condition" name="customer_item_condition"
                       x-model="formData.customer_item_condition"
                       class="mt-1 block w-full text-gray-700 dark:text-gray-300 bg-gray-300 dark:bg-gray-700 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                       placeholder="e.g. Good condition, needs alteration">
            </div>
        </div>
    </div>

    <!-- Image Upload -->
    {# Pass formsetType as 'customer_item' to the image upload partial #}
    {% include 'custom_order/partials/_image_upload.html' with formsetType='customer_item' %}

    <!-- Navigation Buttons -->
    <div class="mt-8 flex justify-between">
        <button type="button" 
                @click="currentStep--;" {# Ensure it's a function call #}
                class="inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
            Back
        </button>
        <button type="button" 
                @click="nextStep()" {# Ensure it's a function call #}
                class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
            Next
        </button>
    </div>
</div>
