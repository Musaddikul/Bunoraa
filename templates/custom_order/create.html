{% extends "base.html" %}
{% load static %}

{% block title %}Create Custom Order | {{ site_name }}{% endblock %}

{% block content %}
<div x-data="customOrderApp()" x-init="init()" @keydown.window.escape="currentStep = 1" class="min-h-full bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-inter">
    <!-- Progress Steps -->
    {% include 'custom_order/partials/_order_steps.html' %}
    
    <div class="lg:grid lg:grid-cols-12 lg:gap-8 px-4 py-8 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <!-- Main Form Column -->
        <div class="lg:col-span-8">
            <!-- Notification Banner -->
            <div x-data="{ showNotificationBanner: false, notificationMessage: '', notificationType: '' }"
                 @notify.window="showNotificationBanner = true; notificationMessage = $event.detail.message; notificationType = $event.detail.type; setTimeout(() => showNotificationBanner = false, 5000);"
                 class="fixed inset-x-0 top-0 z-50 flex items-end justify-center px-4 py-6 pointer-events-none sm:p-6 sm:items-start sm:justify-end">
                <div x-show="showNotificationBanner"
                    :class="{'bg-red-100 border-red-400 text-red-700 dark:bg-red-800 dark:border-red-600 dark:text-red-100': notificationType === 'error', 'bg-green-100 border-green-400 text-green-700 dark:bg-green-800 dark:border-green-600 dark:text-green-100': notificationType === 'success'}"
                    x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 transform -translate-y-4"
                    x-transition:enter-end="opacity-100 transform translate-y-0"
                    x-transition:leave="transition ease-in duration-200"
                    x-transition:leave-start="opacity-100 transform translate-y-0"
                    x-transition:leave-end="opacity-0 transform -translate-y-4"
                    class="border px-4 py-3 rounded-lg shadow-lg relative mb-4 pointer-events-auto w-full max-w-sm" role="alert">
                    <span class="block sm:inline" x-text="notificationMessage"></span>
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" @click="showNotificationBanner = false">
                        <svg class="fill-current h-6 w-6 text-red-500 dark:text-red-300" role="button" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 20 20">
                            <title>Close</title>
                            <path
                                d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15L6.22 7.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.029a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.697z" />
                        </svg>
                    </span>
                </div>
            </div>
            <!-- End Notification Banner -->

            <!-- Order Type Selection -->
            {% include 'custom_order/partials/_order_type.html' %}
            
            <!-- Design Form -->
            {% include 'custom_order/partials/_design_form.html' %}
            
            <!-- Send Product Form -->
            {% include 'custom_order/partials/_send_product_form.html' %}
            
            <!-- Contact Form -->
            {% include 'custom_order/partials/_contact_form.html' %}
            
            <!-- Shipping Form -->
            {% include 'custom_order/partials/_shipping_form.html' %}
            
            <!-- Payment Form -->
            {% include 'custom_order/partials/_payment_form.html' %}

            <!-- Submit Buttons for Draft and Final Order -->
            <div x-show="currentStep === 5" class="mt-8 flex justify-between">
                <button type="button" 
                        @click="prevStep()"
                        class="inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                    Back
                </button>
                <div class="flex space-x-3">
                    <button type="button" 
                            @click="submitOrder(true)"
                            class="inline-flex justify-center py-2 px-4 border border-indigo-300 dark:border-indigo-600 shadow-sm text-sm font-medium rounded-md text-indigo-700 dark:text-indigo-300 bg-indigo-100 dark:bg-indigo-900 hover:bg-indigo-200 dark:hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                        Save as Draft
                    </button>
                    <button type="submit" 
                            @click="submitOrder(false)"
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                        Submit Order
                    </button>
                </div>
            </div>

        </div>
        
        <!-- Sidebar Column -->
        <div class="lg:col-span-4 mt-8 lg:mt-0">
            <!-- Price Summary -->
            {% include 'custom_order/partials/_price_summary.html' %}
        </div>
    </div>
</div>

<script>
    function customOrderApp() {
        return {
            currentStep: 1,
            orderType: '',
            csrfToken: '{{ csrf_token }}',
            formData: {
                order_type: '',
                customer_name: '',
                phone: '',
                email: '',
                contact_method: 'whatsapp',
                category: '',
                subcategory: '',
                fabric_type: '',
                size_option: '',
                color_option: '',
                quantity: 1,
                design_description: '',
                customer_item_description: '',
                customer_item_condition: '',
                size_info: {},
                expected_date: '',
                additional_info: '',
                shipping_address: '',
                shipping_method: '', 
                payment_method: '',
                coupon: '', // This will store the coupon ID if applied successfully
                is_draft: false
            },
            orderSummary: {
                base_price: 0,
                shipping_cost: 0,
                vat_amount: 0,
                discount_amount: 0,
                total_amount: 0
            },
            categories: [],
            subcategories: [],
            fabrics: [],
            colors: [],
            sizes: [],
            shippingMethods: [], 
            paymentMethods: [],
            userAddresses: [],
            couponCode: '', // This is the input field for the coupon code
            couponApplied: false,
            couponError: false,
            couponMessage: '',
            termsAccepted: false,
            loading: false,
            dragover: false,
            apiErrors: {},
            selectedFabric: null,
            designImages: [],
            customerItemImages: [],
            
            parseSizeInfo(jsonString) {
                try {
                    this.formData.size_info = JSON.parse(jsonString);
                } catch (e) {
                    // Optionally, show a notification to the user about invalid JSON
                    console.error("Invalid JSON for size info:", e);
                    this.showNotification('Invalid JSON format for custom size information. Please check your input.', 'error');
                    // Keep the invalid string in the textarea but don't update the object
                }
            },

            loadSizes(subcategoryId, initialSizeId = '') {
                if (!subcategoryId) {
                    this.sizes = [];
                    this.formData.size_option = '';
                    return;
                }

                this.loading = true;
                fetch(`/custom-order/api/sizes/?subcategory_id=${subcategoryId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load sizes');
                        return response.json();
                    })
                    .then(data => {
                        this.sizes = Array.isArray(data) ? data : [];
                        this.apiErrors.sizes = null;
                        if (initialSizeId && this.sizes.some(size => String(size.id) === String(initialSizeId))) {
                            this.formData.size_option = initialSizeId;
                        } else {
                            // If initialSizeId is not provided or not found in the new list, clear the selection
                            this.formData.size_option = '';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching sizes:', error);
                        this.apiErrors.sizes = 'Failed to load sizes';
                        this.sizes = [];
                        this.formData.size_option = '';
                        this.showNotification('Failed to load available sizes.');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },

            init() {
                this.fetchCategories();
                this.fetchFabrics();
                this.fetchShippingMethods(); 
                this.fetchPaymentMethods();
                this.fetchUserAddresses();

                {% if object %}
                    this.formData.order_type = "{{ object.order_type|default:'' }}";
                    this.orderType = "{{ object.order_type|default:'' }}";
                    this.formData.customer_name = "{{ object.customer_name|default:'' }}";
                    this.formData.phone = "{{ object.phone|default:'' }}";
                    this.formData.email = "{{ object.email|default:'' }}";
                    this.formData.contact_method = "{{ object.contact_method|default:'whatsapp' }}";
                    this.formData.order_type = "{{ object.order_type|default:'' }}";
                    this.orderType = "{{ object.order_type|default:'' }}";
                    this.formData.customer_name = "{{ object.customer_name|default:'' }}";
                    this.formData.phone = "{{ object.phone|default:'' }}";
                    this.formData.email = "{{ object.email|default:'' }}";
                    this.formData.contact_method = "{{ object.contact_method|default:'whatsapp' }}";
                    this.formData.category = "{{ object.category.id|default:'' }}";
                    this.formData.subcategory = "{{ object.subcategory.id|default:'' }}";
                    this.formData.fabric_type = "{{ object.fabric_type.id|default:'' }}";
                    this.formData.size_option = "{{ object.size_option.id|default:'' }}";
                    this.formData.color_option = "{{ object.color_option.id|default:'' }}";
                    this.formData.quantity = {{ object.quantity|default:1 }};
                    this.formData.design_description = `{{ object.design_description|escapejs|default:'' }}`;
                    this.formData.customer_item_description = `{{ object.customer_item_description|escapejs|default:'' }}`;
                    this.formData.customer_item_condition = `{{ object.customer_item_condition|escapejs|default:'' }}`;
                    this.formData.size_info = {{ object.size_info|safe|default:'{}' }};
                    this.formData.expected_date = "{{ object.expected_date|date:'Y-m-d'|default:'' }}";
                    this.formData.additional_info = `{{ object.additional_info|escapejs|default:'' }}`;
                    this.formData.shipping_address = "{{ object.shipping_address.id|default:'' }}";
                    this.formData.shipping_method = "{{ object.shipping_method.id|default:'' }}";
                    this.formData.payment_method = "{{ object.payment_method.id|default:'' }}";
                    
                    // Populate couponCode for display and formData.coupon for submission
                    this.couponCode = "{{ object.coupon.code|default:'' }}";
                    this.formData.coupon = "{{ object.coupon.id|default:'' }}";

                    this.formData.is_draft = {{ object.is_draft|yesno:"true,false" }};

                    this.orderSummary.base_price = parseFloat("{{ object.base_price|default:0 }}");
                    this.orderSummary.shipping_cost = parseFloat("{{ object.shipping_cost|default:0 }}");
                    this.orderSummary.vat_amount = parseFloat("{{ object.vat_amount|default:0 }}");
                    this.orderSummary.discount_amount = parseFloat("{{ object.discount_amount|default:0 }}");
                    this.orderSummary.total_amount = parseFloat("{{ object.total_amount|default:0 }}");
                    
                    if (this.formData.coupon) { // Check if coupon ID is present
                        this.couponApplied = true;
                        this.couponMessage = `Coupon '${this.couponCode}' applied.`;
                    }

                    // Initialize image arrays before pushing
                    this.designImages = [];
                    {% for image in object.design_images.all %}
                        this.designImages.push({
                            id: {{ image.id }},
                            image_url: "{{ image.image.url }}",
                            description: `{{ image.description|escapejs }}`,
                            is_primary: {{ image.is_primary|yesno:"true,false" }},
                            _delete: false
                        });
                    {% endfor %}

                    this.customerItemImages = [];
                    {% for image in object.customer_item_images.all %}
                        this.customerItemImages.push({
                            id: {{ image.id }},
                            image_url: "{{ image.image.url }}",
                            description: `{{ image.description|escapejs }}`,
                            _delete: false
                        });
                    {% endfor %}

                    // Load subcategories and colors after setting initial form data
                    if (this.formData.category) {
                        this.loadSubcategories(this.formData.category, this.formData.subcategory);
                    }
                    if (this.formData.fabric_type) {
                        this.loadColors(this.formData.fabric_type, this.formData.color_option);
                    }
                    if (this.formData.subcategory) {
                        this.loadSizes(this.formData.subcategory, this.formData.size_option);
                    }
                    this.calculatePrice();
                {% endif %}


                this.$watch('formData.shipping_address', (value) => {
                    this.populateContactInfoFromAddress(value);
                    this.calculateShippingCost(); 
                });
                this.$watch('formData.shipping_method', (value) => {
                    this.calculateShippingCost(); 
                });
                this.$watch('orderSummary.base_price', (value) => {
                    this.calculateShippingCost(); 
                });
                this.$watch('formData.subcategory', (value) => {
                    this.formData.size_option = ''; 
                    this.calculatePrice();
                    this.loadSizes(value);
                });
                this.$watch('formData.quantity', (value) => {
                    this.calculatePrice();
                });
            },
            
            showNotification(message, type = 'error') {
                this.$dispatch('notify', { message, type });
            },
            
            selectOrderType(type) {
                this.orderType = type;
                this.formData.order_type = type;
                this.resetFormForType(type);
            },
            
            resetFormForType(type) {
                if (type === 'OWN_DESIGN') {
                    this.formData.customer_item_description = '';
                    this.formData.customer_item_condition = '';
                } else if (type === 'SEND_PRODUCT') {
                    this.formData.design_description = '';
                    this.formData.size_info = {};
                    this.formData.size_option = '';
                } else if (type === 'DIRECT_CONTACT') {
                    this.formData.design_description = '';
                    this.formData.customer_item_description = '';
                    this.formData.customer_item_condition = '';
                    this.formData.size_info = {};
                    this.formData.size_option = '';
                    this.formData.category = '';
                    this.formData.subcategory = '';
                    this.formData.fabric_type = '';
                    this.formData.color_option = '';
                    this.formData.quantity = 1;
                    this.formData.shipping_address = '';
                    this.formData.shipping_method = '';
                    this.formData.payment_method = '';
                    this.formData.coupon = '';
                    this.couponCode = '';
                    this.couponApplied = false;
                    this.couponError = false;
                    this.couponMessage = '';
                    this.orderSummary.base_price = 0;
                    this.orderSummary.shipping_cost = 0;
                    this.orderSummary.vat_amount = 0;
                    this.orderSummary.discount_amount = 0;
                    this.orderSummary.total_amount = 0;
                }
            },
            
            nextStep() {
                if (this.validateStep()) {
                    this.currentStep++;
                    this.calculatePrice();
                    this.calculateShippingCost();
                }
            },
            
            prevStep() {
                this.currentStep--;
            },
            
            validateStep() {
                let isValid = true;
                
                if (this.currentStep === 1) {
                    if (!this.orderType) {
                        this.showNotification('Please select an order type to proceed.');
                        isValid = false;
                    }
                } else if (this.currentStep === 2) {
                    if (this.orderType === 'OWN_DESIGN') {
                        if (!this.formData.category) {
                            this.showNotification('Please select a category.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.subcategory) {
                            this.showNotification('Please select a subcategory.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.fabric_type) {
                            this.showNotification('Please select a fabric type.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.size_option) {
                            this.showNotification('Please select a size option.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.color_option) {
                            this.showNotification('Please select a color option.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.quantity || this.formData.quantity < 1) {
                            this.showNotification('Please enter a valid quantity (at least 1).', 'error');
                            isValid = false;
                        }
                        if (!this.formData.design_description.trim()) {
                            this.showNotification('Please provide a design description.', 'error');
                            isValid = false;
                        }
                        if (this.designImages.filter(img => !img._delete).length === 0) {
                            this.showNotification('Please upload at least one design image.', 'error');
                            isValid = false;
                        }
                    } else if (this.orderType === 'SEND_PRODUCT') {
                        if (!this.formData.category) {
                            this.showNotification('Please select a category.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.subcategory) {
                            this.showNotification('Please select a subcategory.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.fabric_type) {
                            this.showNotification('Please select a fabric type.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.quantity || this.formData.quantity < 1) {
                            this.showNotification('Please enter a valid quantity (at least 1).', 'error');
                            isValid = false;
                        }
                        if (!this.formData.customer_item_description.trim()) {
                            this.showNotification('Please provide a description of the item you are sending.', 'error');
                            isValid = false;
                        }
                        if (this.customerItemImages.filter(img => !img._delete).length === 0) {
                            this.showNotification('Please upload at least one image of your item.', 'error');
                            isValid = false;
                        }
                    } else if (this.orderType === 'DIRECT_CONTACT') {
                    }
                } else if (this.currentStep === 3) {
                    const requiredContactFields = ['customer_name', 'phone'];
                    const missingContactFields = requiredContactFields.filter(field => !this.formData[field] || this.formData[field].trim() === '');
                    
                    if (missingContactFields.length > 0) {
                        this.showNotification(`Please fill in: ${missingContactFields.map(f => f.replace('_', ' ')).join(', ')}.`, 'error');
                        isValid = false;
                    }
                    if (this.formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.formData.email)) {
                        this.showNotification('Please enter a valid email address.', 'error');
                        isValid = false;
                    }
                } else if (this.currentStep === 4) {
                    if (this.orderType !== 'DIRECT_CONTACT') {
                        if (!this.formData.shipping_address) {
                            this.showNotification('Please select a shipping address.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.shipping_method) {
                            this.showNotification('Please select a shipping method.', 'error');
                            isValid = false;
                        }
                        if (!this.formData.payment_method) {
                            this.showNotification('Please select a payment method.', 'error');
                            isValid = false;
                        }
                    }
                }
                
                return isValid;
            },
            
            fetchCategories() {
                this.loading = true;
                fetch('/custom-order/api/categories/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load categories');
                        return response.json();
                    })
                    .then(data => {
                        this.categories = data.results;
                        this.apiErrors.categories = null;
                    })
                    .catch(error => {
                        console.error('Error fetching categories:', error);
                        this.apiErrors.categories = 'Failed to load categories';
                        this.showNotification('Failed to load categories');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },
            
            loadSubcategories(categoryId, initialSubcategoryId = '') {
                if (!categoryId) {
                    this.subcategories = [];
                    this.formData.subcategory = '';
                    this.sizes = [];
                    this.formData.size_option = '';
                    return;
                }
                
                this.loading = true;
                fetch(`/custom-order/api/subcategories/${categoryId}/`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load subcategories');
                        return response.json();
                    })
                    .then(data => {
                        this.subcategories = Array.isArray(data) ? data : [];
                        this.apiErrors.subcategories = null;
                        
                        let currentSubcategorySet = false;
                        if (initialSubcategoryId && this.subcategories.some(sub => String(sub.id) === String(initialSubcategoryId))) {
                            this.formData.subcategory = initialSubcategoryId;
                            currentSubcategorySet = true;
                        } else {
                            this.formData.subcategory = '';
                        }

                        if (!currentSubcategorySet) {
                            this.formData.size_option = '';
                        }

                        this.calculatePrice();
                        this.loadSizes(this.formData.subcategory, this.formData.size_option); // Pass current size_option for re-validation
                    })
                    .catch(error => {
                        console.error('Error loading subcategories:', error);
                        this.apiErrors.subcategories = 'Failed to load subcategories';
                        this.subcategories = [];
                        this.formData.subcategory = '';
                        this.sizes = [];
                        this.formData.size_option = '';
                        this.showNotification('Failed to load subcategories.');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },
            
            fetchFabrics() {
                this.loading = true;
                fetch('/custom-order/api/fabrics/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load fabrics');
                        return response.json();
                    })
                    .then(data => {
                        this.fabrics = data.results;
                        this.apiErrors.fabrics = null;
                    })
                    .catch(error => {
                        console.error('Error fetching fabrics:', error);
                        this.apiErrors.fabrics = 'Failed to load fabrics';
                        this.fabrics = [];
                        this.showNotification('Failed to load fabric types.');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },
            
            loadColors(fabricId, initialColorId = '') {
                if (!fabricId) {
                    this.selectedFabric = null;
                    this.colors = [];
                    this.formData.color_option = '';
                    this.calculatePrice();
                    return;
                }
                
                fetch(`/custom-order/api/colors/${fabricId}/`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load colors');
                        return response.json();
                    })
                    .then(data => {
                        this.colors = Array.isArray(data) ? data : [];
                        this.selectedFabric = this.fabrics.find(f => String(f.id) === String(fabricId)) || null;
                        if (initialColorId && this.colors.some(color => String(color.id) === String(initialColorId))) {
                            this.formData.color_option = initialColorId;
                        } else {
                            this.formData.color_option = '';
                        }
                        this.calculatePrice();
                    })
                    .catch(error => {
                        console.error('Error loading colors:', error);
                        this.selectedFabric = null;
                        this.colors = [];
                        this.formData.color_option = '';
                        this.showNotification('Failed to load colors for selected fabric.');
                    });
            },
            
            fetchShippingMethods() {
                this.loading = true;
                fetch('/shipping/api/methods/') 
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load shipping methods');
                        return response.json();
                    })
                    .then(data => {
                        this.shippingMethods = data.results; 
                        this.apiErrors.shippingMethods = null;

                        if (this.formData.shipping_method) {
                            const preselectedId = String(this.formData.shipping_method);
                            const foundMethod = this.shippingMethods.find(method => String(method.id) === preselectedId);
                            if (foundMethod) {
                                this.formData.shipping_method = preselectedId;
                            } else {
                                console.warn('Pre-selected shipping method not found in fetched methods:', preselectedId);
                                this.formData.shipping_method = '';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching shipping methods:', error);
                        this.apiErrors.shippingMethods = 'Failed to load shipping methods';
                        this.shippingMethods = [];
                        this.showNotification('Failed to load shipping methods.');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },
            
            fetchPaymentMethods() {
                this.loading = true;
                fetch('/payments/api/methods/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load payment methods');
                        return response.json();
                    })
                    .then(data => {
                        this.paymentMethods = data.results;
                        this.apiErrors.paymentMethods = null;
                    })
                    .catch(error => {
                        console.error('Error fetching payment methods:', error);
                        this.apiErrors.paymentMethods = 'Failed to load payment options';
                        this.paymentMethods = [];
                        this.showNotification('Failed to load payment options.');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },
            
            fetchUserAddresses() {
                this.loading = true;
                fetch('/accounts/api/addresses/', { 
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': this.csrfToken
                    },
                    credentials: 'include'
                })
                .then(response => {
                    if (response.status === 401) {
                        throw new Error('Please login to view your addresses');
                    }
                    if (!response.ok) throw new Error('Failed to load addresses');
                    return response.json();
                })
                .then(data => {
                    this.userAddresses = data.results;
                    this.apiErrors.userAddresses = null;
                    const defaultAddress = this.userAddresses.find(addr => addr.is_default);
                    if (defaultAddress) {
                        this.formData.shipping_address = defaultAddress.id;
                        this.populateContactInfoFromAddress(defaultAddress.id);
                    } else if (this.userAddresses.length > 0) {
                        this.formData.shipping_address = this.userAddresses[0].id;
                        this.populateContactInfoFromAddress(this.userAddresses[0].id);
                    }
                })
                .catch(error => {
                    console.error('Error fetching user addresses:', error);
                    this.apiErrors.userAddresses = error.message;
                    this.userAddresses = [];
                    if (error.message !== 'Please login to view your addresses') {
                        this.showNotification(error.message);
                    }
                })
                .finally(() => {
                    this.loading = false;
                });
            },

            populateContactInfoFromAddress(addressId) {
                const selectedAddress = this.userAddresses.find(addr => String(addr.id) === String(addressId));
                if (selectedAddress) {
                    this.formData.customer_name = selectedAddress.full_name || ''; 
                    this.formData.phone = selectedAddress.phone_number || '';
                    this.formData.email = selectedAddress.user_email || '';
                } else {
                    if (!addressId) {
                        this.formData.customer_name = '';
                        this.formData.phone = '';
                        this.formData.email = '';
                    }
                }
            },
            
            calculatePrice() {
                if (!this.formData.fabric_type || !this.formData.subcategory || this.formData.quantity === null || this.formData.quantity === undefined || this.formData.quantity <= 0) {
                    this.resetPriceSummary();
                    return;
                }
                
                this.loading = true;
                const data = {
                    fabric_id: this.formData.fabric_type,
                    subcategory_id: this.formData.subcategory,
                    quantity: parseInt(this.formData.quantity),
                    code: this.couponCode || null
                };
                
                fetch('/custom-order/api/calculate-price/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error('calculatePrice - Error response from API:', err);
                            throw new Error(err.error || 'Price calculation failed');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    this.orderSummary.base_price = parseFloat(data.base_price) || 0;
                    this.orderSummary.vat_amount = parseFloat(data.vat_amount) || 0;
                    this.orderSummary.discount_amount = parseFloat(data.discount_amount) || 0;
                    this.orderSummary.total_amount = parseFloat(data.total_amount) || 0;
                    this.apiErrors.priceCalculation = null;
                    this.updateTotalOrderPrice(); 
                })
                .catch(error => {
                    console.error('Error calculating price:', error);
                    this.apiErrors.priceCalculation = 'Failed to calculate price';
                    this.resetPriceSummary();
                    this.showNotification(error.message);
                })
                .finally(() => {
                    this.loading = false;
                });
            },
            
            resetPriceSummary() {
                this.orderSummary.base_price = 0;
                this.orderSummary.shipping_cost = 0;
                this.orderSummary.vat_amount = 0;
                this.orderSummary.discount_amount = 0;
                this.orderSummary.total_amount = 0;
            },
            
            calculateShippingCost() {
                if (!this.formData.shipping_method || !this.formData.shipping_address || this.orderSummary.base_price <= 0) {
                    this.orderSummary.shipping_cost = 0;
                    this.updateTotalOrderPrice();
                    return;
                }

                const shippingAddressId = parseInt(this.formData.shipping_address);
                if (isNaN(shippingAddressId) || shippingAddressId <= 0) {
                    this.showNotification('Please select a valid shipping address.', 'error');
                    this.orderSummary.shipping_cost = 0;
                    this.updateTotalOrderPrice();
                    return;
                }

                this.loading = true;
                const data = {
                    shipping_method_id: this.formData.shipping_method, 
                    shipping_address_id: shippingAddressId, 
                    weight_kg: 1, 
                    order_total: this.orderSummary.base_price,
                };

                fetch('/shipping/api/calculate-cost/', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error('calculateShippingCost - Error response from shipping API:', err);
                            throw new Error(err.error || 'Shipping calculation failed');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    this.orderSummary.shipping_cost = parseFloat(data.shipping_cost) || 0;
                    this.updateTotalOrderPrice();
                })
                .catch(error => {
                    console.error('Error calculating shipping cost:', error);
                    this.orderSummary.shipping_cost = 0;
                    this.showNotification(error.message || 'Failed to calculate shipping cost.');
                    this.updateTotalOrderPrice();
                })
                .finally(() => {
                    this.loading = false;
                });
            },

            updateTotalOrderPrice() {
                this.orderSummary.total_amount = (
                    this.orderSummary.base_price +
                    this.orderSummary.vat_amount +
                    this.orderSummary.shipping_cost -
                    this.orderSummary.discount_amount
                ).toFixed(2);
            },
            
            // In your Alpine.js component
            applyCoupon() {
                if (!this.couponCode || !this.orderSummary.base_price) {
                    this.showNotification('No amount found to apply Coupon', 'error');
                    return;
                }

                this.loading = true;
                
                const requestData = {
                    code: this.couponCode,
                    target_amount: this.orderSummary.base_price
                };

                fetch('/promotions/api/coupons/apply/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.detail || 'Failed to apply coupon');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    this.couponApplied = true;
                    this.couponError = false;
                    this.couponMessage = `Coupon applied: ${data.discount_amount} BDT discount`;
                    this.formData.coupon = data.coupon.id;
                    this.orderSummary.discount_amount = parseFloat(data.discount_amount);
                    this.updateTotalOrderPrice();
                    this.showNotification('Coupon applied successfully!', 'success');
                })
                .catch(error => {
                    console.error('Coupon apply catch error:', error);
                    this.couponError = true;
                    this.couponApplied = false;
                    this.couponMessage = error.message;
                    this.formData.coupon = '';
                    this.orderSummary.discount_amount = 0;
                    this.updateTotalOrderPrice();
                    this.showNotification(error.message, 'error');
                })
                .finally(() => {
                    this.loading = false;
                });
            },
            
            handleFileSelect(event, type) {
                const files = event.target.files;
                this.previewImages(files, type);
            },
            
            handleDrop(event, type) {
                event.preventDefault();
                this.dragover = false;
                const files = event.dataTransfer.files;
                this.previewImages(files, type);
            },
            
            previewImages(files, type) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.match('image.*')) continue;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageData = {
                            file: file,
                            preview: e.target.result,
                            description: '',
                            is_primary: false,
                            _delete: false
                        };
                        if (type === 'design') {
                            this.designImages.push(imageData);
                        } else if (type === 'customer_item') {
                            this.customerItemImages.push(imageData);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            },

            removeImage(index, type) {
                if (type === 'design') {
                    if (this.designImages[index].id) {
                        this.designImages[index]._delete = true;
                    } else {
                        this.designImages.splice(index, 1);
                    }
                    if (this.designImages.filter(img => !img._delete).length === 0 && this.designImages.filter(img => !img._delete).length > 0) {
                        this.designImages.filter(img => !img._delete)[0].is_primary = true;
                    }
                } else if (type === 'customer_item') {
                    if (this.customerItemImages[index].id) {
                        this.customerItemImages[index]._delete = true;
                    } else {
                        this.customerItemImages.splice(index, 1);
                    }
                }
                this.showNotification('Image removed from selection.', 'success');
            },
            
            async submitOrder(isDraft) {
                this.formData.is_draft = isDraft;

                if (!isDraft && !this.validateBeforeSubmit()) {
                    return;
                }

                this.loading = true;
                const formData = new FormData();

                // Append all formData properties
                for (const key in this.formData) {
                    if (this.formData[key] !== null && this.formData[key] !== undefined) {
                        if (typeof this.formData[key] === 'object' && key !== 'size_info') {
                            formData.append(key, JSON.stringify(this.formData[key]));
                        } else if (key === 'size_info') {
                            formData.append(key, JSON.stringify(this.formData[key]));
                        } else if (key === 'coupon') {
                            // Do NOT append formData.coupon (which is the ID) directly.
                            // The form expects coupon_code (the string).
                            // We will append coupon_code separately below.
                            continue; // Skip appending the 'coupon' ID here
                        } else {
                            formData.append(key, this.formData[key]);
                        }
                    }
                }

                // Append the coupon code from the input field, which the Django form expects
                if (this.couponCode) {
                    formData.append('coupon_code', this.couponCode);
                }

                formData.append('csrfmiddlewaretoken', this.csrfToken);

                let designImageCount = 0;
                let initialDesignForms = 0;
                this.designImages.forEach((image, index) => {
                    if (!image._delete) {
                        if (image.file) {
                            formData.append(`design_images-${designImageCount}-image`, image.file);
                        } else if (image.id) {
                            formData.append(`design_images-${designImageCount}-id`, image.id);
                            initialDesignForms++;
                        }
                        formData.append(`design_images-${designImageCount}-description`, image.description || '');
                        formData.append(`design_images-${designImageCount}-is_primary`, image.is_primary ? 'on' : '');
                        designImageCount++;
                    } else if (image.id) {
                        formData.append(`design_images-${designImageCount}-id`, image.id);
                        formData.append(`design_images-${designImageCount}-DELETE`, 'on');
                        initialDesignForms++;
                        designImageCount++;
                    }
                });
                formData.append('design_images-TOTAL_FORMS', designImageCount);
                formData.append('design_images-INITIAL_FORMS', initialDesignForms);
                formData.append('design_images-MAX_NUM_FORMS', 10);

                let customerItemImageCount = 0;
                let initialCustomerItemForms = 0;
                this.customerItemImages.forEach((image, index) => {
                    if (!image._delete) {
                        if (image.file) {
                            formData.append(`customer_item_images-${customerItemImageCount}-image`, image.file);
                        } else if (image.id) {
                            formData.append(`customer_item_images-${customerItemImageCount}-id`, image.id);
                            initialCustomerItemForms++;
                        }
                        formData.append(`customer_item_images-${customerItemImageCount}-description`, image.description || '');
                        customerItemImageCount++;
                    } else if (image.id) {
                        formData.append(`customer_item_images-${customerItemImageCount}-id`, image.id);
                        formData.append(`customer_item_images-${customerItemImageCount}-DELETE`, 'on');
                        initialCustomerItemForms++;
                        customerItemImageCount++;
                    }
                });
                formData.append('customer_item_images-TOTAL_FORMS', customerItemImageCount);
                formData.append('customer_item_images-INITIAL_FORMS', initialCustomerItemForms);
                formData.append('customer_item_images-MAX_NUM_FORMS', 10);
                
                const url = "{% if object %}{% url 'custom_order:update' order_id=object.order_id %}{% else %}{% url 'custom_order:create' %}{% endif %}";

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': this.csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (jsonError) {
                            const errorText = await response.text();
                            console.error("Server returned non-JSON error:", errorText);
                            this.showNotification('An unexpected server error occurred. Please try again.', 'error');
                            return;
                        }

                        let earliestErrorStep = 5;

                        const processErrors = (errorsJson, step, prefix = '') => {
                            try {
                                const errors = JSON.parse(errorsJson);
                                if (Array.isArray(errors)) {
                                    if (errors.length > 0) {
                                        earliestErrorStep = Math.min(earliestErrorStep, step);
                                        errors.forEach(message => {
                                            this.showNotification(`${prefix}${message}`, 'error');
                                        });
                                    }
                                } else {
                                    for (const field in errors) {
                                        errors[field].forEach(errorObj => {
                                            const message = errorObj.message || errorObj;
                                            this.showNotification(`${prefix}${field.replace(/_/g, ' ')}: ${message}`, 'error');
                                            earliestErrorStep = Math.min(earliestErrorStep, step);
                                        });
                                    }
                                }
                            } catch (parseError) {
                                console.error("Failed to parse errors:", parseError);
                            }
                        };


                        if (errorData.errors) {
                            if (errorData.errors.form_errors) {
                                try {
                                    const formErrors = JSON.parse(errorData.errors.form_errors);
                                    for (const field in formErrors) {
                                        if (['category', 'subcategory', 'fabric_type', 'size_option', 'color_option', 'quantity', 'design_description', 'customer_item_description'].includes(field)) {
                                            earliestErrorStep = Math.min(earliestErrorStep, 2);
                                        } else if (['customer_name', 'phone', 'email'].includes(field)) {
                                            earliestErrorStep = Math.min(earliestErrorStep, 3);
                                        } else if (['shipping_address', 'shipping_method', 'payment_method', 'coupon_code', 'is_draft'].includes(field)) { // Added coupon_code and is_draft
                                            earliestErrorStep = Math.min(earliestErrorStep, 4);
                                        }
                                        formErrors[field].forEach(errorObj => {
                                            const message = errorObj.message || errorObj;
                                            this.showNotification(`${field.replace(/_/g, ' ')}: ${message}`, 'error');
                                        });
                                    }
                                } catch (parseError) {
                                    console.error("Failed to parse form_errors:", parseError);
                                }
                            }


                            processErrors(errorData.errors.non_field_errors, this.currentStep);

                            if (errorData.errors.design_images_errors) {
                                try {
                                    // design_images_errors is now an array of JSON strings
                                    errorData.errors.design_images_errors.forEach((formErrorsJson, index) => {
                                        const formErrors = JSON.parse(formErrorsJson);
                                        if (Object.keys(formErrors).length > 0) {
                                            for (const field in formErrors) {
                                                formErrors[field].forEach(errorObj => {
                                                    const message = errorObj.message || errorObj;
                                                    this.showNotification(`Design Image ${index + 1} - ${field.replace(/_/g, ' ')}: ${message}`, 'error');
                                                    earliestErrorStep = Math.min(earliestErrorStep, 2);
                                                });
                                            }
                                        }
                                    });
                                } catch (parseError) {
                                    console.error("Failed to parse design_images_errors:", parseError);
                                }
                            }

                            if (errorData.errors.customer_item_images_errors) {
                                try {
                                    // customer_item_images_errors is now an array of JSON strings
                                    errorData.errors.customer_item_images_errors.forEach((formErrorsJson, index) => {
                                        const formErrors = JSON.parse(formErrorsJson);
                                        if (Object.keys(formErrors).length > 0) {
                                            for (const field in formErrors) {
                                                formErrors[field].forEach(errorObj => {
                                                    const message = errorObj.message || errorObj;
                                                    this.showNotification(`Customer Item Image ${index + 1} - ${field.replace(/_/g, ' ')}: ${message}`, 'error');
                                                    earliestErrorStep = Math.min(earliestErrorStep, 2);
                                                });
                                            }
                                        }
                                    });
                                } catch (parseError) {
                                    console.error("Failed to parse customer_item_images_errors:", parseError);
                                }
                            }

                            processErrors(errorData.errors.design_formset_non_form_errors, 2, 'Design Images (General): ');
                            processErrors(errorData.errors.customer_item_images_formset_non_form_errors, 2, 'Customer Item Images (General): ');
                            
                            if (earliestErrorStep <= 4) {
                                this.currentStep = earliestErrorStep;
                            } else {
                                this.showNotification(errorData.message || 'Validation failed. Please review your input.', 'error');
                            }

                        } else {
                            this.showNotification(errorData.message || errorData.error || 'Order submission failed.', 'error');
                        }
                    } else {
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.showNotification(data.message || 'Order processed successfully!', 'success');
                            setTimeout(() => {
                                window.location.href = data.redirect_url;
                            }, 1000); 
                        } else {
                            this.showNotification(data.message || 'Order submission failed (non-success status from backend)', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error submitting order:', error);
                    if (!error.message.includes('Validation failed')) {
                        this.showNotification(error.message || 'An unexpected error occurred during order submission.', 'error');
                    }
                } finally {
                    this.loading = false;
                }
            },

            validateBeforeSubmit() {
                const requiredContactFields = ['customer_name', 'phone'];
                const missingContactFields = requiredContactFields.filter(field => !this.formData[field] || this.formData[field].trim() === '');
                
                if (missingContactFields.length > 0) {
                    this.showNotification(`Please fill in: ${missingContactFields.map(f => f.replace('_', ' ')).join(', ')}.`, 'error');
                    return false;
                }
                if (this.formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.formData.email)) {
                    this.showNotification('Please enter a valid email address.', 'error');
                    return false;
                }

                if (this.orderType === 'OWN_DESIGN') {
                    if (!this.formData.design_description || this.formData.design_description.trim() === '') {
                        this.showNotification('Please provide a design description for your custom design.', 'error');
                        return false;
                    }
                    if (!this.formData.size_option) {
                        this.showNotification('Please select a size option for your custom design.', 'error');
                        return false;
                    }
                    if (this.designImages.filter(img => !img._delete).length === 0) {
                        this.showNotification('Please upload at least one design image.', 'error');
                        return false;
                    }
                } else if (this.orderType === 'SEND_PRODUCT') {
                    if (!this.formData.customer_item_description || this.formData.customer_item_description.trim() === '') {
                        this.showNotification('Please provide a description of the item you are sending.', 'error');
                        return false;
                    }
                    if (this.customerItemImages.filter(img => !img._delete).length === 0) {
                        this.showNotification('Please upload at least one image of your item.', 'error');
                        return false;
                    }
                }
                
                if (this.orderType !== 'DIRECT_CONTACT') {
                    const requiredOrderFields = ['category', 'subcategory', 'fabric_type'];
                    const missingOrderFields = requiredOrderFields.filter(field => !this.formData[field] || this.formData[field].trim() === '');
                    
                    if (missingOrderFields.length > 0) {
                        this.showNotification(`Please select: ${missingOrderFields.map(f => f.replace('_', ' ')).join(', ')}.`, 'error');
                        return false;
                    }

                    if (!this.formData.quantity || this.formData.quantity < 1) {
                        this.showNotification('Quantity must be at least 1.', 'error');
                        return false;
                    }

                    if (!this.formData.shipping_address) {
                        this.showNotification('Please select a shipping address.', 'error');
                        return false;
                    }
                    if (!this.formData.shipping_method) {
                        this.showNotification('Please select a shipping method.', 'error');
                        return false;
                    }
                    if (!this.formData.payment_method) {
                        this.showNotification('Please select a payment method.', 'error');
                        return false;
                    }
                }

                if (!this.termsAccepted) {
                    this.showNotification('Please accept the terms and conditions to proceed.', 'error');
                    return false;
                }
                
                return true;
            },

            getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        }
    }
</script>
{% endblock %}
