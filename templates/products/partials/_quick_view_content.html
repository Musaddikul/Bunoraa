{% load static %}
{% load i18n %}
{% load currency_filters %}

<div class="flex flex-col lg:flex-row gap-8 p-6 bg-white dark:bg-gray-900 rounded-lg shadow-xl animate-fade-in">
    <!-- Product Image Gallery -->
    <div class="lg:w-1/2 flex flex-col items-center">
        <div class="relative w-full aspect-square rounded-lg overflow-hidden shadow-md mb-4">
            <img id="quick-view-main-image" src="{{ product.image.url }}" alt="{{ product.name }}"
                 class="w-full h-full object-cover object-center transition-transform duration-300 hover:scale-105">
            {% if product.is_discounted and product.discount_percentage > 0 %}
            <span class="absolute top-3 left-3 bg-red-600 text-white text-xs font-semibold px-2.5 py-1 rounded-full shadow-lg">-{{ product.discount_percentage }}%</span>
            {% endif %}
        </div>
        {% if product.images.all|length > 1 %}
        <div class="flex gap-3 overflow-x-auto pb-2 custom-scrollbar">
            {% for img in product.images.all %}
            <img src="{{ img.image.url }}" alt="{{ product.name }} thumbnail {{ forloop.counter }}"
                 class="quick-view-thumbnail w-20 h-20 object-cover rounded-md border-2 border-transparent hover:border-pink-500 cursor-pointer transition-all duration-200"
                 data-image-url="{{ img.image.url }}">
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Product Details -->
    <div class="lg:w-1/2 space-y-5">
        <p class="text-base lg:text-lg font-semibold text-gray-900 dark:text-white leading-tight">{{ product.name }}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wider">{{ product.category.name }} {% if product.brand %}â€¢ {{ product.brand.name }}{% endif %}</p>

        <!-- Price Section -->
        <div class="flex items-center gap-4">
            {% if product.is_discounted %}
                <span class="text-base lg:text-lg font-bold text-green-600 dark:text-green-400">{{ product.discounted_price|convert_price:selected_currency }}</span>
                <span class="text-sm text-gray-500 dark:text-gray-400 line-through">{{ product.price|convert_price:selected_currency }}</span>
                <span class="text-xs font-semibold text-red-500 bg-red-100 px-2 py-0.5 rounded-full">{% translate "Save" %} {{ product.discount_percentage }}%</span>
            {% else %}
                <span class="text-3xl font-bold text-gray-900 dark:text-white">{{ product.price|convert_price:selected_currency }}</span>
            {% endif %}
        </div>

        <p class="text-gray-700 dark:text-gray-300 leading-relaxed">{{ product.short_description }}</p>

        <!-- Stock and Availability -->
        <div class="flex items-center space-x-2 text-base font-medium">
            {% if product.stock > 0 %}
                <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-green-600 dark:text-green-400">{% translate "In Stock" %}</span>
                <span class="text-gray-500 dark:text-gray-400">({{ product.stock }} {% translate "available" %})</span>
            {% else %}
                <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span class="text-red-600 dark:text-red-400">{% translate "Out of Stock" %}</span>
            {% endif %}
        </div>

        <!-- Add to Cart Form -->
        <div class="quick-view-cart-form flex flex-col sm:flex-row items-stretch sm:items-center gap-4 mt-6" data-product-id="{{ product.id }}" data-max-stock="{{ product.stock }}">
            <div class="flex items-center border border-gray-300 dark:border-gray-700 rounded-lg overflow-hidden flex-shrink-0">
                <button type="button" class="quick-view-qty-minus px-2 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 transition-colors duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                    </svg>
                </button>
                <input type="number" class="quick-view-qty-input w-16 h-auto font-semibold text-center border-x border-gray-300 dark:border-gray-700 focus:ring-0 focus:outline-none bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-sm py-2" 
                       value="1" min="1" max="{{ product.stock }}">
                <button type="button" class="quick-view-qty-plus px-2 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 transition-colors duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
            </div>

            <button type="button"
                    class="quick-view-add-to-cart flex-1 bg-pink-600 text-white py-3 px-2 rounded-lg hover:bg-pink-700 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center
                           {% if product.stock == 0 %}opacity-50 cursor-not-allowed{% endif %}"
                    data-product-id="{{ product.id }}"
                    {% if product.stock == 0 %}disabled{% endif %}>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                {% translate "Add to Cart" %}
            </button>
        </div>

        <!-- Go to Product Page -->
        <a href="{{ product.get_absolute_url }}" class="block text-center text-pink-600 dark:text-pink-400 hover:underline mt-5 text-base font-medium flex items-center justify-center">
            {% translate "View Full Product Details" %}
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
            </svg>
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quick view thumbnail gallery
    document.querySelectorAll('.quick-view-thumbnail').forEach(thumb => {
        thumb.addEventListener('click', function() {
            const mainImage = document.getElementById('quick-view-main-image');
            if (mainImage) {
                mainImage.src = this.dataset.imageUrl;
            }
        });
    });
    
    // Quick view quantity controls
    const qtyContainer = document.querySelector('.quick-view-cart-form');
    if (qtyContainer) {
        const qtyInput = qtyContainer.querySelector('.quick-view-qty-input');
        const maxStock = parseInt(qtyContainer.dataset.maxStock) || 999;
        
        qtyContainer.querySelector('.quick-view-qty-minus')?.addEventListener('click', () => {
            const current = parseInt(qtyInput.value) || 1;
            qtyInput.value = Math.max(1, current - 1);
        });
        
        qtyContainer.querySelector('.quick-view-qty-plus')?.addEventListener('click', () => {
            const current = parseInt(qtyInput.value) || 1;
            qtyInput.value = Math.min(maxStock, current + 1);
        });
        
        // Add to cart from quick view
        qtyContainer.querySelector('.quick-view-add-to-cart')?.addEventListener('click', async function() {
            if (this.disabled) return;
            
            const productId = this.dataset.productId;
            const quantity = parseInt(qtyInput.value) || 1;
            
            try {
                this.disabled = true;
                const response = await fetch('/api/cart/add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ product_id: productId, quantity: quantity })
                });
                
                const data = await response.json();
                if (response.ok) {
                    window.dispatchEvent(new CustomEvent('cart-updated', { detail: data }));
                    window.BunoraaApp?.showToast?.('{% translate "Added to cart!" %}', 'success');
                } else {
                    window.BunoraaApp?.showToast?.(data.error || '{% translate "Failed to add to cart" %}', 'error');
                }
            } catch (error) {
                console.error('Add to cart error:', error);
                window.BunoraaApp?.showToast?.('{% translate "Failed to add to cart" %}', 'error');
            } finally {
                this.disabled = false;
            }
        });
    }
});
</script>
