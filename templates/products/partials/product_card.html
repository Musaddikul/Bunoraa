{% load static %}
<div class="group relative bg-white dark:bg-gray-900 rounded-xl shadow hover:shadow-lg overflow-hidden transition-all duration-300 border border-gray-100 dark:border-gray-800">
  
  <!-- Image & Badges -->
  <a href="{{ product.get_absolute_url }}">
  <div class="relative aspect-[4/4] overflow-hidden bg-gray-100 dark:bg-gray-800">
    <img src="{{ product.image.url }}" alt="{{ product.name }}"
      class="w-full h-full object-cover object-center transition-transform duration-300 group-hover:scale-105">

    <!-- Discount Badge -->
    {% if product.is_discounted and product.discount_percentage > 0 %}
    <span class="absolute top-2 left-2 bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded shadow z-20">
      {{ product.discount_percentage }}% OFF
    </span>
    {% endif %}

    <!-- Wishlist -->
    <div x-data="{
        wished: {{ product.is_wished|yesno:'true,false' }},
        toggle() {
          fetch('{% url 'wishlist:toggle' product.id %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(res => {
              // Crucial: Check if response is OK before parsing JSON
              if (!res.ok) {
                  // Attempt to parse JSON error message, or use generic error
                  return res.json().then(err => { 
                      throw new Error(err.error || `HTTP error! status: ${res.status}`); 
                  }).catch(() => {
                      // Fallback if response is not JSON or parsing fails
                      throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}`);
                  });
              }
              return res.json();
          })
          .then(data => {
            this.wished = data.added;
            
            // Dispatch the 'wishlist-count-updated' event with all necessary details
            const message = data.message || 
                            (data.added ? 'Product added to wishlist!' : 'Product removed from wishlist!');

            document.dispatchEvent(new CustomEvent('wishlist-count-updated', {
                bubbles: true, // Ensure event bubbles up
                detail: {
                    count: data.wishlist_count,
                    productId: {{ product.id }},
                    added: data.added,
                    message: message
                }
            }));
            showToast(message, 'success');
          })
          .catch(error => {
              console.error('Product Grid: Error toggling wishlist:', error);
              showToast(error.message || 'Failed to update wishlist.', 'error');
          });
        }
      }" 
      x-init="wished = {{ product.is_wished|yesno:'true,false' }}"
      class="absolute top-2 right-2 z-20">
      <button type="button" aria-label="Add to wishlist" x-on:click.prevent.stop="toggle()">
        <i :class="wished ? 'fas fa-heart text-red-600' : 'far fa-heart text-gray-400 dark:text-gray-500'" class="text-lg transition"></i>
      </button>
    </div>

    <!-- Status Tags
    {% if product.is_low_stock %}
    <span class="absolute top-2 right-2 bg-yellow-400 text-black text-xs px-2 py-0.5 rounded shadow z-20">Low Stock</span>
    {% elif not product.available %}
    <span class="absolute top-2 right-2 bg-gray-500 text-white text-xs px-2 py-0.5 rounded shadow z-20">Out of Stock</span>
    {% endif %}

    {% if product.new_collection %}
    <span class="absolute bottom-2 left-2 bg-blue-600 text-white text-xs px-2 py-0.5 rounded z-20">New</span>
    {% elif product.festive_collection %}
    <span class="absolute bottom-2 left-2 bg-green-600 text-white text-xs px-2 py-0.5 rounded z-20">Festive</span>
    {% elif product.is_featured %}
    <span class="absolute bottom-2 left-2 bg-indigo-600 text-white text-xs px-2 py-0.5 rounded z-20">Featured</span>
    {% endif %} -->
  </div>
  </a>

  <!-- Product Info -->
  <div class="p-4 space-y-2 text-sm">
    <div class="flex justify-between items-center">
      {% if product.category %}
      <p class="text-xs uppercase tracking-wide text-gray-400 dark:text-gray-500">{{ product.category.name }}</p>
      {% endif %}
    </div>

    <h3 class="text-base font-medium text-gray-900 dark:text-white truncate"><a href="{{ product.get_absolute_url }}">{{ product.name }}</a></h3>

    <!-- Rating -->
    <div class="flex items-center space-x-1 text-yellow-400 text-xs">
      {% with rating=product.average_rating|default:0 %}
      {% for i in "12345"|make_list %}
      {% if rating >= forloop.counter %}
      <i class="fas fa-star"></i>
      {% elif rating >= forloop.counter0|add:"0.5" %}
      <i class="fas fa-star-half-alt"></i>
      {% else %}
      <i class="far fa-star"></i>
      {% endif %}
      {% endfor %}
      {% endwith %}
      <span class="text-gray-500 dark:text-gray-400 ml-1">({{ product.reviews.count }})</span>
    </div>

    <!-- Price -->
    <div class="flex items-center gap-2">
      {% if product.is_discounted %}
      <span class="text-pink-600 font-semibold text-lg">৳{{ product.discounted_price|floatformat:2 }}</span>
      <span class="line-through text-gray-400 text-sm">৳{{ product.price|floatformat:2 }}</span>
      {% else %}
      <span class="text-gray-800 dark:text-gray-100 font-semibold text-lg">৳{{ product.price|floatformat:2 }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Actions -->
  <div class="p-4 pt-0 flex justify-between items-center relative z-20">
    {% if product.available %}
    <form class="add-to-cart-form" data-product-id="{{ product.id }}">
      {% csrf_token %}
      <input type="hidden" name="quantity" value="1">
      <button type="submit"
        class="bg-primary-600 hover:bg-primary-700 text-white font-semibold px-8 py-3 rounded-lg shadow transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
        {% if product.stock == 0 %}disabled{% endif %}>
        {% if product.stock == 0 %}Out of Stock{% else %}
          <span id="add-to-cart-text-{{ product.id }}">Add to Cart</span>
          <i id="add-to-cart-spinner-{{ product.id }}" class="fas fa-spinner fa-spin ml-2" style="display: none;"></i>
        {% endif %}
    </form>
    {% else %}
    <span class="text-sm text-red-500 font-medium">Unavailable</span>
    {% endif %}

    <!-- Quick View -->
    <button
      type="button"
      class="text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 text-sm transition"
      onclick="showQuickView({{ product.id }})"
      aria-label="Quick View">
      <i class="fas fa-eye"></i>
    </button>
  </div>
</div>