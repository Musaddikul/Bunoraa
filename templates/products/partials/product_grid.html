<!-- templates/products/product_grid.html -->
{% load product_tags %}
{% load static %}

<!-- Product Grid -->
<div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
  {% for product in products %}
  <article tabindex="0" class="group relative bg-gray-200 dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition duration-300">
    <a href="{{ product.get_absolute_url }}" class="block rounded-t-lg overflow-hidden relative">
      <div class="aspect-[4/5] w-full overflow-hidden bg-gray-100 dark:bg-gray-800">
        {% if product.images.all %}
          <img src="{{ product.images.all.0.image.url }}"
                alt="{{ product.name|escape }}"
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy"
                data-secondary-image="{% if product.images.all|length > 1 %}{{ product.images.all.1.image.url }}{% else %}{{ product.images.all.0.image.url }}{% endif %}"
                onmouseenter="this.src=this.getAttribute('data-secondary-image')"
                onmouseleave="this.src='{{ product.images.all.0.image.url }}'">
        {% else %}
          <img src="{% static 'img/placeholder.webp' %}" alt="No Image" class="w-full h-full object-cover">
        {% endif %}
      </div>

      <!-- Wishlist -->
      <div x-data="{
          wished: {{ product.is_wished|yesno:'true,false' }},
          toggle() {
            fetch('{% url 'wishlist:toggle' product.id %}', {
              method: 'POST',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
              }
            })
            .then(res => {
                // Crucial: Check if response is OK before parsing JSON
                if (!res.ok) {
                    // Attempt to parse JSON error message, or use generic error
                    return res.json().then(err => { 
                        throw new Error(err.error || `HTTP error! status: ${res.status}`); 
                    }).catch(() => {
                        // Fallback if response is not JSON or parsing fails
                        throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}`);
                    });
                }
                return res.json();
            })
            .then(data => {
              this.wished = data.added;
              
              // Dispatch the 'wishlist-count-updated' event with all necessary details
              const message = data.message || 
                              (data.added ? 'Product added to wishlist!' : 'Product removed from wishlist!');

              document.dispatchEvent(new CustomEvent('wishlist-count-updated', {
                  bubbles: true,
                  detail: {
                      count: data.wishlist_count,
                      productId: {{ product.id }},
                      added: data.added,
                      message: message
                  }
              }));
              showToast(message, 'success');
            })
            .catch(error => {
                console.error('Product Grid: Error toggling wishlist:', error);
                showToast(error.message || 'Failed to update wishlist.', 'error');
            });
          }
        }" 
        x-init="wished = {{ product.is_wished|yesno:'true,false' }}"
        class="absolute top-2 right-2 z-20">
        <button type="button" aria-label="Add to wishlist" x-on:click.prevent.stop="toggle()">
          <i :class="wished ? 'fas fa-heart text-red-600' : 'far fa-heart text-gray-400 dark:text-gray-500'" class="text-lg transition"></i>
        </button>
      </div>

      <!-- Badges -->
      <div class="absolute top-3 left-3 space-y-1 z-20">
        {% if product.festive_collection %}<span class="bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded">Eid</span>{% endif %}
        {% if product.trending %}<span class="bg-yellow-400 text-black text-xs font-semibold px-2 py-0.5 rounded">Trending</span>{% endif %}
        {% if product.new_collection %}<span class="bg-green-600 text-white text-xs font-semibold px-2 py-0.5 rounded">New</span>{% endif %}
        {% if product.is_featured %}<span class="bg-indigo-700 text-white text-xs font-semibold px-2 py-0.5 rounded">Featured</span>{% endif %}
        {% if product.stock == 0 %}<span class="bg-gray-700 text-white text-xs font-semibold px-2 py-0.5 rounded">Out of Stock</span>{% endif %}
      </div>

      <!-- Info -->
      <div class="p-3 text-sm">
        <h3 class="text-xs text-gray-800 dark:text-gray-100 leading-tight mt-2 mb-1 line-clamp-2">{{ product.name }}</h3>
        <div class="flex items-center gap-1 text-yellow-400 text-xs mb-1">
          {% with rating=product.average_rating|default:0 %}
            {% for i in "12345"|make_list %}
              {% if rating >= forloop.counter %}<i class="fas fa-star"></i>
              {% elif rating >= forloop.counter0|add:"0.5" %}<i class="fas fa-star-half-alt"></i>
              {% else %}<i class="far fa-star"></i>
              {% endif %}
            {% endfor %}
            <span class="text-gray-500 dark:text-gray-400 ml-1">({{ product.reviews.count }})</span>
          {% endwith %}
        </div>
        <div class="text-left mt-1">
          {% if product.is_discounted %}
            <span class="text-pink-600 font-bold text-base">৳{{ product.discounted_price|floatformat:2 }}</span>
            <span class="line-through text-gray-400 text-xs ml-1">৳{{ product.price|floatformat:2 }}</span>
            <span class="bg-red-600 text-white text-xs font-semibold ml-3 px-2 py-0.5 rounded shadow">
              {{ product.discount_percentage }}% OFF
            </span>
          {% else %}
            <span class="text-gray-800 dark:text-gray-100 font-semibold text-base">৳{{ product.price|floatformat:2 }}</span>
          {% endif %}
        </div>
        {% if product.free_shipping %}
          <div class="text-xs text-teal-600 mt-1">Free Shipping</div>
        {% endif %}
      </div>
    </a>
  </article>
  {% empty %}
  <p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No products found matching your filters.</p>
  {% endfor %}
</div>
