{% load static %}

<div x-data="{ isWishlisted: true }"
     class="product-card bg-white dark:bg-dark/70 rounded-3xl shadow-xl overflow-hidden transform transition duration-300 hover:scale-[1.02] hover:shadow-2xl flex flex-col justify-between animate-fadeIn">
    
    {% with product_url=product.get_absolute_url %}
    <a href="{% if product_url %}{{ product_url }}{% else %}{% url 'products:all_products' %}{% endif %}"
       class="block relative h-60 overflow-hidden group">

        <img src="{{ product.image.url|default:'https://placehold.co/600x400/E0E0E0/4A4A4A?text=No+Image' }}"
             alt="{{ product.name }}"
             class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
             onerror="this.onerror=null;this.src='https://placehold.co/600x400/E0E0E0/4A4A4A?text=No+Image';">

        <!-- Wishlist -->
        <div x-data="{
            wished: {{ product.is_wished|yesno:'true,false' }},
            toggle() {
            fetch('{% url 'wishlist:toggle' product.id %}', {
                method: 'POST',
                headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(res => {
                // Crucial: Check if response is OK before parsing JSON
                if (!res.ok) {
                    // Attempt to parse JSON error message, or use generic error
                    return res.json().then(err => { 
                        throw new Error(err.error || `HTTP error! status: ${res.status}`); 
                    }).catch(() => {
                        // Fallback if response is not JSON or parsing fails
                        throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}`);
                    });
                }
                return res.json();
            })
            .then(data => {
                this.wished = data.added;
                
                // Dispatch the 'wishlist-count-updated' event with all necessary details
                const message = data.message || 
                                (data.added ? 'Product added to wishlist!' : 'Product removed from wishlist!');

                document.dispatchEvent(new CustomEvent('wishlist-count-updated', {
                    bubbles: true, // Ensure event bubbles up
                    detail: {
                        count: data.wishlist_count,
                        productId: {{ product.id }},
                        added: data.added,
                        message: message
                    }
                }));
                showToast(message, 'success');
            })
            .catch(error => {
                console.error('Product Grid: Error toggling wishlist:', error);
                showToast(error.message || 'Failed to update wishlist.', 'error');
            });
            }
        }" 
        x-init="wished = {{ product.is_wished|yesno:'true,false' }}"
        class="absolute top-2 right-2 z-20">
        <button type="button" aria-label="Add to wishlist" x-on:click.prevent.stop="toggle()">
            <i :class="wished ? 'fas fa-heart text-red-600' : 'far fa-heart text-gray-400 dark:text-gray-500'" class="text-lg transition"></i>
        </button>
        </div>
    </a>
    {% endwith %}

    <div class="p-5 flex-grow flex flex-col justify-between">
        <h2 class="text-lg md:text-xl font-semibold text-gray-800 dark:text-light font-display mb-3 leading-snug tracking-tight">
            {{ product.name|truncatechars:35 }}
        </h2>

        <div class="flex items-center justify-between">
            {% if product.is_discounted %}
            <div class="flex flex-col">
                <span class="text-sm text-gray-500 dark:text-gray-400 line-through">${{ product.price }}</span>
                <span class="text-2xl font-bold text-primary dark:text-accent">${{ product.discounted_price }}</span>
            </div>
            {% else %}
            <span class="text-2xl font-bold text-primary dark:text-accent">${{ product.price }}</span>
            {% endif %}

            {% with product_url=product.get_absolute_url %}
            <a href="{% if product_url %}{{ product_url }}{% else %}{% url 'products:all_products' %}{% endif %}"
               class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-secondary hover:bg-secondary-700 text-white shadow transition duration-200">
                View
                <svg class="ml-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" />
                </svg>
            </a>
            {% endwith %}
        </div>
    </div>
</div>
