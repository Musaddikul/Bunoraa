{% load static %}
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <!-- Theme Initialization (must be first to prevent flashing) -->
    <script src="{% static 'js/theme-init.js' %}"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}{{ SITE_NAME }} - {{ SITE_TAGLINE }}{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}ecommerce, shop, store, premium, fashion, electronics{% endblock %}">
    <meta name="theme-color" content="#7c3aed">
    <meta name="robots" content="index, follow">
    {% if SITE_FAVICON %}
    <link rel="icon" href="{{ SITE_FAVICON }}" sizes="any">
    {% else %}
    <link rel="icon" href="{% static 'images/favicon.ico' %}" sizes="any">
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}">
    {% endif %}
    
    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}{{ SITE_NAME }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ SITE_TAGLINE }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% static 'images/og-image.jpg' %}{% endblock %}">
    <meta property="og:type" content="website">
    
    <title>{% block title %}{{ SITE_NAME }}{% endblock %}</title>
    
    <!-- Loader Shim (for early loading states) -->
    <script>
        window.Loader = window.Loader || {
            show(target) {
                const host = target && target.appendChild ? target : document.body;
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-black/20 z-50 flex items-center justify-center';
                overlay.setAttribute('data-loader-overlay', '');
                const spinner = document.createElement('div');
                spinner.className = 'w-8 h-8 border-4 border-white/60 border-t-transparent rounded-full animate-spin';
                overlay.appendChild(spinner);
                host.appendChild(overlay);
                return overlay;
            },
            hide(target) {
                const root = target && target.querySelector ? target : document;
                const el = root.querySelector('[data-loader-overlay]');
                if (el && el.parentNode) el.parentNode.removeChild(el);
            }
        };
    </script>

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-white dark:bg-stone-950 text-stone-900 dark:text-stone-100">
    <!-- Announcement Bar -->
    <div id="announcement-bar" class="bg-gradient-to-r from-amber-800 via-amber-700 to-amber-800 text-white py-2.5 text-center text-sm relative overflow-hidden hidden">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2020%2020%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M0%200h20v20H0V0zm10%2017a7%207%200%20100-14%207%207%200%20000%2014z%22%20fill%3D%22%23fff%22%20fill-opacity%3D%22.03%22%2F%3E%3C%2Fsvg%3E')] opacity-50"></div>
        <div class="container mx-auto px-4 relative">
            <p id="announcement-text" class="font-medium flex items-center justify-center gap-2">
                <span class="sr-only">Announcement</span>
            </p>
        </div>
        <button onclick="document.getElementById('announcement-bar')?.remove()" class="absolute right-4 top-1/2 -translate-y-1/2 p-1.5 hover:bg-white/10 rounded-full transition-colors" aria-label="Close announcement">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <!-- Header: Rendered by JavaScript -->
    <header id="main-header" class="min-h-[66px]"></header>

    <!-- Config for JS (must come before scripts that use it) -->
    {% with logo_dark=SITE_LOGO_DARK|default:'' logo=SITE_LOGO|default:'' %}
    <script id="header-config" type="application/json">{"siteName":"{{SITE_NAME|escapejs}}","siteLogo":"{{logo|escapejs}}","siteLogoDark":"{{logo_dark|default:logo|escapejs}}","authenticated":{{request.user.is_authenticated|yesno:"true,false"}}}</script>
    {% endwith %}
    {% if request.user.is_authenticated %}
    <script type="application/json" id="user-json">{"first_name":"{{request.user.first_name|escapejs}}","last_name":"{{request.user.last_name|escapejs}}","email":"{{request.user.email|escapejs}}","avatar":{% if request.user.avatar %}"{{ request.user.avatar.url|escapejs }}"{% else %}null{% endif %}}</script>
    {% else %}
    <script type="application/json" id="user-json">null</script>
    {% endif %}
    <script>
    window.BUNORAA_ROUTES = { 'home': '{% url "home" %}', 'categoryDetail': '{% url "categories:detail" slug="__slug__" %}', 'productDetail': '{% url "products:detail" slug="__slug__" %}', 'productsList': '{% url "products:list" %}', 'accountsDashboard': '{% url "accounts:dashboard" %}', 'accountsProfile': '{% url "accounts:profile" %}', 'accountsLogin': '{% url "accounts:login" %}', 'accountsRegister': '{% url "accounts:register" %}', 'accountsLogout': '{% url "accounts:logout" %}', 'ordersList': '{% url "orders:list" %}', 'wishlistList': '{% url "wishlist:list" %}', 'cartView': '{% url "cart:view" %}' };
    </script>

    <!-- Main Content -->
    <main id="main-content" class="min-h-screen page-enter bg-stone-50 dark:bg-stone-950">
        {% block content %}{% endblock %}
    </main>

    <!-- Cart Drawer & Other Overlays -->
    {% include 'includes/cart_drawer.html' %}
    <div id="mobile-search-overlay" class="hidden fixed inset-0 z-50 bg-white dark:bg-stone-900"></div>

    <!-- Footer: Rendered by JavaScript -->
    <footer id="main-footer" class="bg-stone-900 text-stone-300 mt-auto"></footer>

    <!-- Scroll to Top Button -->
    <button data-scroll-top class="hidden fixed bottom-6 right-6 z-40 p-3 bg-amber-600 text-white rounded-xl shadow-lg hover:bg-amber-700 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 items-center justify-center" aria-label="Scroll to top">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </button>

    <!-- Toast Proxy for early calls -->
    <script>
        (function() {
            const queue = [];
            window.Toast = {
                _queue: queue,
                success: (msg, opts) => queue.push({ type: 'success', msg, opts }),
                error: (msg, opts) => queue.push({ type: 'error', msg, opts }),
                warning: (msg, opts) => queue.push({ type: 'warning', msg, opts }),
                info: (msg, opts) => queue.push({ type: 'info', msg, opts }),
            };
        })();
    </script>

    <!-- Core App Scripts (DEFERRED) -->
    <!-- Utility Libraries -->
    <script src="{% static 'js/utils/dom.js' %}" defer></script>
    <script src="{% static 'js/utils/storage.js' %}" defer></script>
    <script src="{% static 'js/utils/debounce.js' %}" defer></script>
    <script src="{% static 'js/utils/authGuard.js' %}" defer></script>
    <script src="{% static 'js/utils/router.js' %}" defer></script>
    <script src="{% static 'js/utils/templates.js' %}" defer></script>

    <!-- API Client Layer -->
    <script src="{% static 'js/api/client.js' %}" defer></script>
    <script src="{% static 'js/api/localization.js' %}" defer></script>
    <script src="{% static 'js/api/auth.js' %}" defer></script>
    <script src="{% static 'js/api/products.js' %}" defer></script>
    <script src="{% static 'js/api/categories.js' %}" defer></script>
    <script src="{% static 'js/api/cart.js' %}" defer></script>
    <script src="{% static 'js/api/checkout.js' %}" defer></script>
    <script src="{% static 'js/api/orders.js' %}" defer></script>
    <script src="{% static 'js/api/wishlist.js' %}" defer></script>
    <script src="{% static 'js/api/shipping.js' %}" defer></script>
    <script src="{% static 'js/api/support.js' %}" defer></script>
    <script src="{% static 'js/api/pages.js' %}" defer></script>
    <script src="{% static 'js/api/preorders.js' %}" defer></script>
    
    <!-- Main Components -->
    <script src="{% static 'js/components/header.js' %}" defer></script>
    <script src="{% static 'js/components/footer.js' %}" defer></script>
    <script src="{% static 'js/components/cart-drawer.js' %}" defer></script>
    <script src="{% static 'js/components/toast-init.js' %}" defer></script>

    <!-- Page-Specific Scripts -->
    <script src="{% static 'js/pages/home.js' %}" defer></script>
    <script src="{% static 'js/pages/category.js' %}" defer></script>
    <script src="{% static 'js/pages/product.js' %}" defer></script>
    <script src="{% static 'js/pages/cart.js' %}" defer></script>
    <script src="{% static 'js/pages/checkout.js' %}" defer></script>
    <script src="{% static 'js/pages/account.js' %}" defer></script>
    <script src="{% static 'js/pages/orders.js' %}" defer></script>
    <script src="{% static 'js/pages/search.js' %}" defer></script>
    <script src="{% static 'js/pages/contact.js' %}" defer></script>
    <script src="{% static 'js/pages/wishlist.js' %}" defer></script>
    <script src="{% static 'js/pages/faq.js' %}" defer></script>
    <script src="{% static 'js/pages/legal.js' %}" defer></script>
    <script src="{% static 'js/pages/preorders.js' %}" defer></script>

    <!-- App Entry Point -->
    <script src="{% static 'js/app.js' %}" defer></script>
    
    <!-- Other deferred scripts -->
    <script src="{% static 'js/theme-toggle.js' %}" defer></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>