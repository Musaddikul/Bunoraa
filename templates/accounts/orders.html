{% extends 'base.html' %}
{% load static currency_tags %}

{% block page_id %}orders{% endblock %
{% block title %}My Orders - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Sidebar Navigation -->
        <aside class="lg:w-64 flex-shrink-0">
            {% include 'accounts/partials/sidebar.html' with active='orders' %}
        </aside>
        
        <!-- Main Content -->
        <div class="flex-1">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- Header -->
                <div class="p-6 border-b border-gray-200">
                    <h1 class="text-2xl font-bold text-gray-900">My Orders</h1>
                    <p class="text-gray-600 mt-1">Track and manage your orders</p>
                </div>
                
                <!-- Filters -->
                <div class="p-4 border-b border-gray-200 flex flex-wrap gap-2">
                    <a href="{% url 'orders:list' %}" 
                       class="px-4 py-2 rounded-full text-sm {% if not status %}bg-primary-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        All
                    </a>
                    <a href="{% url 'orders:list' %}?status=pending" 
                       class="px-4 py-2 rounded-full text-sm {% if status == 'pending' %}bg-primary-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        Pending
                    </a>
                    <a href="{% url 'orders:list' %}?status=processing" 
                       class="px-4 py-2 rounded-full text-sm {% if status == 'processing' %}bg-primary-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        Processing
                    </a>
                    <a href="{% url 'orders:list' %}?status=shipped" 
                       class="px-4 py-2 rounded-full text-sm {% if status == 'shipped' %}bg-primary-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        Shipped
                    </a>
                    <a href="{% url 'orders:list' %}?status=delivered" 
                       class="px-4 py-2 rounded-full text-sm {% if status == 'delivered' %}bg-primary-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        Delivered
                    </a>
                </div>
                
                <!-- Orders List -->
                {% if orders %}
                <div class="divide-y divide-gray-200">
                    {% for order in orders %}
                    <div class="p-6 hover:bg-gray-50 transition-colors">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                            <div>
                                <div class="flex items-center space-x-3">
                                    <a href="{% url 'orders:detail' order.id %}" class="font-semibold text-gray-900 hover:text-primary-600">
                                        Order #{{ order.order_number }}
                                    </a>
                                    <span class="inline-block px-2 py-1 text-xs rounded-full
                                        {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800
                                        {% elif order.status == 'processing' %}bg-blue-100 text-blue-800
                                        {% elif order.status == 'shipped' %}bg-purple-100 text-purple-800
                                        {% elif order.status == 'delivered' %}bg-green-100 text-green-800
                                        {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ order.get_status_display }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">
                                    Placed on {{ order.created_at|date:"F j, Y" }} at {{ order.created_at|time:"g:i A" }}
                                </p>
                            </div>
                            <div class="mt-2 md:mt-0 text-right">
                                <p class="font-semibold text-gray-900">{% format_price order.total %}</p>
                                <p class="text-sm text-gray-500">{{ order.items.count }} item{{ order.items.count|pluralize }}</p>
                            </div>
                        </div>
                        
                        <!-- Order Items Preview -->
                        <div class="flex items-center space-x-4 overflow-x-auto pb-2">
                            {% for item in order.items.all|slice:":4" %}
                            <div class="flex-shrink-0">
                                <img src="{{ item.product.primary_image.url|default:'/static/images/placeholder.jpg' }}" loading="lazy" decoding="async" 
                                     alt="{{ item.product_name }}"
                                     class="w-16 h-16 object-cover rounded-lg">
                            </div>
                            {% endfor %}
                            {% if order.items.count > 4 %}
                            <div class="flex-shrink-0 w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center">
                                <span class="text-sm text-gray-500">+{{ order.items.count|add:"-4" }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex flex-wrap gap-3 mt-4">
                            <a href="{% url 'orders:detail' order.id %}" 
                               class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                                View Details
                            </a>
                            {% if order.status == 'delivered' %}
                            <a href="{% url 'orders:invoice' order.order_number %}" 
                               class="text-sm text-gray-600 hover:text-gray-700">
                                Download Invoice
                            </a>
                            {% if not order.is_reviewed %}
                            <a href="{% url 'reviews:create' order.order_number %}" 
                               class="text-sm text-gray-600 hover:text-gray-700">
                                Write a Review
                            </a>
                            {% endif %}
                            {% endif %}
                            {% if order.status == 'shipped' and order.tracking_number %}
                            <a href="{{ order.tracking_url }}" target="_blank"
                               class="text-sm text-gray-600 hover:text-gray-700">
                                Track Package
                            </a>
                            {% endif %}
                            {% if order.can_cancel %}
                            <button onclick="cancelOrder('{{ order.order_number }}')" 
                                    class="text-sm text-red-600 hover:text-red-700">
                                Cancel Order
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if orders.has_other_pages %}
                <div class="p-6 border-t border-gray-200">
                    <nav class="flex justify-center">
                        <div class="flex items-center space-x-2">
                            {% if orders.has_previous %}
                            <a href="?page={{ orders.previous_page_number }}{% if status %}&status={{ status }}{% endif %}" 
                               class="px-3 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
                                Previous
                            </a>
                            {% endif %}
                            
                            {% for num in orders.paginator.page_range %}
                            {% if orders.number == num %}
                            <span class="px-4 py-2 bg-primary-600 text-white rounded-lg">{{ num }}</span>
                            {% elif num > orders.number|add:'-3' and num < orders.number|add:'3' %}
                            <a href="?page={{ num }}{% if status %}&status={{ status }}{% endif %}" 
                               class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
                                {{ num }}
                            </a>
                            {% endif %}
                            {% endfor %}
                            
                            {% if orders.has_next %}
                            <a href="?page={{ orders.next_page_number }}{% if status %}&status={{ status }}{% endif %}" 
                               class="px-3 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
                                Next
                            </a>
                            {% endif %}
                        </div>
                    </nav>
                </div>
                {% endif %}
                
                {% else %}
                <!-- Empty State -->
                <div class="p-12 text-center">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    <h2 class="text-xl font-medium text-gray-900 mb-2">No orders yet</h2>
                    <p class="text-gray-600 mb-6">When you place an order, it will appear here.</p>
                    <a href="{% url 'products:list' %}" 
                       class="inline-block bg-primary-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-primary-700 transition-colors">
                        Start Shopping
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div id="cancel-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Cancel Order</h3>
        <p class="text-gray-600 mb-4">Are you sure you want to cancel this order? This action cannot be undone.</p>
        <form id="cancel-form" method="POST">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Reason for cancellation</label>
                <select name="reason" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Select a reason</option>
                    <option value="changed_mind">Changed my mind</option>
                    <option value="found_better_price">Found better price elsewhere</option>
                    <option value="ordered_by_mistake">Ordered by mistake</option>
                    <option value="taking_too_long">Taking too long to ship</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeCancelModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Keep Order</button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Cancel Order</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function cancelOrder(orderNumber) {
        const form = document.getElementById('cancel-form');
        form.action = `/accounts/orders/${orderNumber}/cancel/`;
        document.getElementById('cancel-modal').classList.remove('hidden');
        document.getElementById('cancel-modal').classList.add('flex');
    }
    
    function closeCancelModal() {
        document.getElementById('cancel-modal').classList.add('hidden');
        document.getElementById('cancel-modal').classList.remove('flex');
    }
</script>
{% endblock %}
