{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Set New Password" %}{% endblock %}
{% block page_name %}password-reset-confirm{% endblock %}
{% block body_class %}bg-secondary-50{% endblock %}

{% block content %}
<div class="min-h-[80vh] flex items-center justify-center py-12 px-4">
    <div class="max-w-md w-full">
        <div class="text-center mb-8">
            <a href="{% url 'storefront:home' %}" class="inline-block mb-6">
                <img src="{% static 'images/logo.svg' %}" alt="Bunoraa" class="h-10 w-auto mx-auto">
            </a>
            <div class="w-16 h-16 rounded-full bg-primary-100 flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-secondary-900">{% trans "Set new password" %}</h1>
            <p class="text-secondary-600 mt-2">{% trans "Please enter your new password below." %}</p>
        </div>
        
        <div class="card">
            <div class="card-body">
                {% if validlink %}
                <form method="POST" class="space-y-4">
                    {% csrf_token %}
                    
                    <div>
                        <label for="new_password1" class="label">{% trans "New password" %}</label>
                        <input 
                            type="password" 
                            id="new_password1" 
                            name="new_password1" 
                            class="input {% if form.new_password1.errors %}input-error{% endif %}"
                            placeholder="{% trans 'Enter new password' %}"
                            required
                            autofocus
                            autocomplete="new-password"
                        >
                        {% if form.new_password1.errors %}
                        <p class="error-text">{{ form.new_password1.errors.0 }}</p>
                        {% endif %}
                        <p class="help-text">{% trans "At least 8 characters with letters and numbers" %}</p>
                    </div>
                    
                    <div>
                        <label for="new_password2" class="label">{% trans "Confirm new password" %}</label>
                        <input 
                            type="password" 
                            id="new_password2" 
                            name="new_password2" 
                            class="input {% if form.new_password2.errors %}input-error{% endif %}"
                            placeholder="{% trans 'Confirm new password' %}"
                            required
                            autocomplete="new-password"
                        >
                        {% if form.new_password2.errors %}
                        <p class="error-text">{{ form.new_password2.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-error">
                        {% for error in form.non_field_errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Password Strength Indicator -->
                    <div class="password-strength-container hidden">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm text-secondary-600">{% trans "Password strength" %}</span>
                            <span class="text-sm font-medium password-strength-text"></span>
                        </div>
                        <div class="h-2 bg-secondary-200 rounded-full overflow-hidden">
                            <div class="password-strength-bar h-full transition-all duration-300"></div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-full">
                        {% trans "Reset Password" %}
                    </button>
                </form>
                {% else %}
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-error-100 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-error-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold text-secondary-900 mb-2">{% trans "Invalid or Expired Link" %}</h2>
                    <p class="text-secondary-600 mb-6">
                        {% trans "This password reset link is invalid or has expired. Please request a new one." %}
                    </p>
                    <a href="{% url 'accounts:password_reset' %}" class="btn btn-primary">
                        {% trans "Request New Link" %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <p class="text-center text-secondary-600 mt-6">
            <a href="{% url 'accounts:login' %}" class="text-primary-600 hover:underline font-medium inline-flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                {% trans "Back to sign in" %}
            </a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
// Password strength indicator
const password1 = document.getElementById('new_password1');
const container = document.querySelector('.password-strength-container');
const bar = document.querySelector('.password-strength-bar');
const text = document.querySelector('.password-strength-text');

if (password1 && container) {
    password1.addEventListener('input', function() {
        const value = this.value;
        if (value.length === 0) {
            container.classList.add('hidden');
            return;
        }
        container.classList.remove('hidden');
        
        let strength = 0;
        if (value.length >= 8) strength++;
        if (value.length >= 12) strength++;
        if (/[a-z]/.test(value) && /[A-Z]/.test(value)) strength++;
        if (/\d/.test(value)) strength++;
        if (/[^a-zA-Z0-9]/.test(value)) strength++;
        
        const levels = [
            { width: '20%', color: 'bg-error-500', text: '{% trans "Very Weak" %}' },
            { width: '40%', color: 'bg-error-400', text: '{% trans "Weak" %}' },
            { width: '60%', color: 'bg-warning-500', text: '{% trans "Fair" %}' },
            { width: '80%', color: 'bg-success-400', text: '{% trans "Strong" %}' },
            { width: '100%', color: 'bg-success-500', text: '{% trans "Very Strong" %}' },
        ];
        
        const level = levels[Math.min(strength, 4)];
        bar.style.width = level.width;
        bar.className = `password-strength-bar h-full transition-all duration-300 ${level.color}`;
        text.textContent = level.text;
        text.className = `text-sm font-medium ${level.color.replace('bg-', 'text-')}`;
    });
}
</script>
{% endblock %}
