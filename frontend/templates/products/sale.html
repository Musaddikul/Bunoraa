{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Sale" %}{% endblock %}
{% block page_name %}sale{% endblock %}

{% block breadcrumb %}
<nav class="container mx-auto px-4 py-4" aria-label="Breadcrumb">
    <ol class="breadcrumb">
        <li><a href="{% url 'storefront:home' %}" class="breadcrumb-item">{% trans "Home" %}</a></li>
        <span class="breadcrumb-separator">/</span>
        <li class="breadcrumb-current">{% trans "Sale" %}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-secondary-900">{% trans "Sale" %}</h1>
            <p class="text-secondary-600 mt-1" data-sale-subtitle>{% trans "Loading products..." %}</p>
        </div>
    </div>

    <div id="sale-products" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6"></div>

    <div id="sale-empty" class="hidden py-16 text-center">
        <p class="text-secondary-600">{% trans "No products on sale right now." %}</p>
        <a href="{% url 'storefront:products' %}" class="btn btn-primary mt-4">{% trans "Browse all products" %}</a>
    </div>
</div>

<script type="module">
  import { productsApi } from "{% static 'js/api/products.js' %}";

  const grid = document.getElementById('sale-products');
  const emptyState = document.getElementById('sale-empty');
  const subtitle = document.querySelector('[data-sale-subtitle]');

  function formatMoney(value) {
    const number = Number(value);
    if (Number.isNaN(number)) return value ?? '';
    return number.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function productCard(product) {
    const imageUrl = (product && product.primary_image && product.primary_image.image) ? product.primary_image.image : '';
    const name = escapeHtml(product && product.name);
    const category = escapeHtml(product && product.category_name);
    const url = "{% url 'storefront:product_detail' 'SLUG_REPLACE' %}".replace('SLUG_REPLACE', encodeURIComponent(product.slug));

    const isOnSale = Boolean(product && product.is_on_sale);
    const currentPrice = formatMoney(product && product.current_price);
    const originalPrice = formatMoney(product && product.price);

    return `
      <article class="product-card">
        <div class="product-card-image">
          <a href="${url}">
            ${imageUrl ? `<img src="${imageUrl}" alt="${name}" loading="lazy" class="w-full h-full object-cover">`
              : `<div class="w-full h-full bg-secondary-200 flex items-center justify-center"></div>`}
          </a>
          ${isOnSale ? `<div class="product-card-badge"><span class="badge badge-error">-${product.discount_percentage}%</span></div>` : ''}
        </div>
        <div class="product-card-body">
          ${category ? `<p class="text-xs text-secondary-500 mb-1">${category}</p>` : ''}
          <h3 class="product-card-title"><a href="${url}">${name}</a></h3>
          <div class="product-card-price">
            ${isOnSale
              ? `<span class="product-card-price-current text-error-600">${currentPrice}</span><span class="product-card-price-original">${originalPrice}</span>`
              : `<span class="product-card-price-current">${currentPrice}</span>`}
          </div>
        </div>
      </article>
    `;
  }

  async function load() {
    try {
      const res = await productsApi.getSaleProducts();
      const products = (res && res.data && Array.isArray(res.data.results))
        ? res.data.results
        : ((res && Array.isArray(res.data)) ? res.data : []);

      if (!Array.isArray(products) || products.length === 0) {
        grid.innerHTML = '';
        emptyState.classList.remove('hidden');
        if (subtitle) subtitle.textContent = "{% trans 'No products on sale right now.' %}";
        return;
      }

      emptyState.classList.add('hidden');
      grid.innerHTML = products.map(productCard).join('');
      if (subtitle) subtitle.textContent = `${products.length} {% trans 'items' %}`;
    } catch (e) {
      grid.innerHTML = '';
      emptyState.classList.remove('hidden');
      if (subtitle) subtitle.textContent = "{% trans 'Unable to load sale products.' %}";
      console.error(e);
    }
  }

  load();
</script>
{% endblock %}
